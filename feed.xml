<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Robin's Personal Website</title>
    <description></description>
    <link>/</link>
    <atom:link href="/feed.xml" rel="self" type="application/rss+xml"/>
    <pubDate>Thu, 07 Sep 2017 13:38:13 +0800</pubDate>
    <lastBuildDate>Thu, 07 Sep 2017 13:38:13 +0800</lastBuildDate>
    <generator>Jekyll v3.3.0</generator>
    
      <item>
        <title>Centos6 &amp; Centos 7 初始化脚本</title>
        <description>&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/bin/bash&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#Author: xxxxxxx&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#Email: xxxxxxx@gmail.com&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#Description: This script is for optimizing system performance; For Centos6 and Centos7&lt;/span&gt;

cat /etc/redhat-release|awk &lt;span class=&quot;s1&quot;&gt;'{print &quot;OPERATING SYSTEM:&quot;,$0}'&lt;/span&gt;
grep &lt;span class=&quot;s2&quot;&gt;&quot;IPADDR&quot;&lt;/span&gt; /etc/sysconfig/network-scripts/ifcfg-eth0|awk -F &lt;span class=&quot;s2&quot;&gt;&quot;=&quot;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'{print &quot;HOST IPADDR:&quot;,$2}'&lt;/span&gt;
uname -a|awk &lt;span class=&quot;s1&quot;&gt;'{print &quot;HOSTNAME:&quot;,$2&quot;\nKERNEL VERSION:&quot;,$3}'&lt;/span&gt;        

sed -i &lt;span class=&quot;s1&quot;&gt;'s/DNS1=.*/DNS1=114.114.114.114/g'&lt;/span&gt; /etc/sysconfig/network-scripts/ifcfg-eth0
sed -i &lt;span class=&quot;s1&quot;&gt;'s/DNS2=.*/DNS2=180.76.76.76/g'&lt;/span&gt; /etc/sysconfig/network-scripts/ifcfg-eth0
cat &amp;gt;/etc/resolv.conf&lt;span class=&quot;sh&quot;&gt;&amp;lt;&amp;lt;EOF
nameserver 114.114.114.114
nameserver 180.76.76.76
EOF

&lt;/span&gt;sed -i &lt;span class=&quot;s1&quot;&gt;'s/SELINUX=.*/SELINUX=disabled/g'&lt;/span&gt; /etc/selinux/config
setenforce 0 &amp;amp;&amp;gt; /dev/null

&lt;span class=&quot;nv&quot;&gt;TEST&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;grep &lt;span class=&quot;s2&quot;&gt;&quot;soft nproc 65535&quot;&lt;/span&gt; /etc/security/limits.conf|wc -l&lt;span class=&quot;k&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$TEST&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;0&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;; &lt;span class=&quot;k&quot;&gt;then
&lt;/span&gt;cat  &amp;gt;&amp;gt; /etc/security/limits.conf &lt;span class=&quot;sh&quot;&gt;&amp;lt;&amp;lt; EOF
* soft nproc 65535
* hard nproc 65535
* soft nofile 65535
* hard nofile 65535
EOF
&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;fi

&lt;/span&gt;sed -i &lt;span class=&quot;s2&quot;&gt;&quot;s/&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\#&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;UseDNS.*/UseDNS no/g&quot;&lt;/span&gt; /etc/ssh/sshd_config
sed -i &lt;span class=&quot;s2&quot;&gt;&quot;s/GSSAPIAuthentication.*/GSSAPIAuthentication no/g&quot;&lt;/span&gt; /etc/ssh/sshd_config

&lt;span class=&quot;nv&quot;&gt;TEST&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;egrep &lt;span class=&quot;s2&quot;&gt;&quot;color|auto&quot;&lt;/span&gt; /etc/profile|wc -l&lt;span class=&quot;k&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$TEST&lt;/span&gt; -eq 0 &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;;&lt;span class=&quot;k&quot;&gt;then
&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;alias egrep='egrep --color=auto'&quot;&lt;/span&gt; &amp;gt;&amp;gt;/etc/profile
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;alias grep='grep --color=auto'&quot;&lt;/span&gt; &amp;gt;&amp;gt;/etc/profile
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;alias vi='vim'&quot;&lt;/span&gt; &amp;gt;&amp;gt;/etc/profile
&lt;span class=&quot;k&quot;&gt;fi

&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TEST&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;grep &lt;span class=&quot;s2&quot;&gt;&quot;ntp1.aliyun.com&quot;&lt;/span&gt; /var/spool/cron/root|wc -l&lt;span class=&quot;k&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$TEST&lt;/span&gt; -eq 0 &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;;&lt;span class=&quot;k&quot;&gt;then
&lt;/span&gt;touch /var/spool/cron/root
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;*/5 * * * * /usr/sbin/ntpdate ntp1.aliyun.com &amp;gt;/dev/null 2&amp;gt;&amp;amp;1&quot;&lt;/span&gt; &amp;gt;&amp;gt;/var/spool/cron/root
&lt;span class=&quot;k&quot;&gt;fi

&lt;/span&gt;yum install wget -y &amp;amp;&amp;gt; /dev/null

&lt;span class=&quot;nv&quot;&gt;SYSTEM_VERSION&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;cat /etc/redhat-release|grep -o &lt;span class=&quot;s2&quot;&gt;&quot;6.&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$SYSTEM_VERSION&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;;&lt;span class=&quot;k&quot;&gt;then
    &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;VERSION&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'centos7'&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;else
    &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;VERSION&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'centos6'&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;fi

if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$VERSION&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'centos6'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;;&lt;span class=&quot;k&quot;&gt;then
&lt;/span&gt;chkconfig --list|grep 3:on|egrep -v &lt;span class=&quot;s2&quot;&gt;&quot;crond|network|rsyslog|sshd|sysstat&quot;&lt;/span&gt;|awk &lt;span class=&quot;s1&quot;&gt;'{print $1}'&lt;/span&gt;|sed -r &lt;span class=&quot;s1&quot;&gt;'s#(.*)#chkconfig \1 off#g'&lt;/span&gt;|bash &amp;amp;&amp;gt;/dev/null
/etc/init.d/iptables stop &amp;amp;&amp;gt; /dev/null
wget -qO /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo
wget -qO /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo
&lt;span class=&quot;k&quot;&gt;elif&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$VERSION&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'centos7'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;;&lt;span class=&quot;k&quot;&gt;then
&lt;/span&gt;wget -qO /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
wget -qO /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo
yum clean all &amp;amp;&amp;gt; /dev/null
systemctl stop firewalld.service &amp;amp;&amp;gt; /dev/null
systemctl disable firewalld.service &amp;amp;&amp;gt; /dev/null
systemctl stop NetworkManager.service &amp;amp;&amp;gt; /dev/null
systemctl disable NetworkManager.service &amp;amp;&amp;gt; /dev/null
systemclt stop postfix.service &amp;amp;&amp;gt; /dev/null
systemclt disable postfix.service &amp;amp;&amp;gt; /dev/null
yum install iptables-services -y &amp;amp;&amp;gt; /dev/null
&lt;span class=&quot;k&quot;&gt;else 
&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;Pls Check The System Version&quot;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;fi
&lt;/span&gt;yum clean all &amp;amp;&amp;gt; /dev/null
yum makecache &amp;amp;&amp;gt; /dev/null
yum -y groupinstall Development tools
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;wget -qO ./optimizing-system.sh http://wangrubin.com/scripts/optimizing-system.sh &amp;amp;&amp;amp; sh optimizing-system.sh&lt;/p&gt;
&lt;/blockquote&gt;

&lt;hr /&gt;

&lt;p&gt;end&lt;/p&gt;
</description>
        <pubDate>Thu, 07 Sep 2017 00:00:00 +0800</pubDate>
        <link>/shell/optimizing-system.html</link>
        <guid isPermaLink="true">/shell/optimizing-system.html</guid>
        
        
        <category>Shell</category>
        
      </item>
    
      <item>
        <title>Prometheus-容器监控</title>
        <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#prometheus&quot; id=&quot;markdown-toc-prometheus&quot;&gt;什么是Prometheus&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section&quot; id=&quot;markdown-toc-section&quot;&gt;主要特点&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-1&quot; id=&quot;markdown-toc-section-1&quot;&gt;相关组件&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#prometheus-1&quot; id=&quot;markdown-toc-prometheus-1&quot;&gt;prometheus架构&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#prometheus-2&quot; id=&quot;markdown-toc-prometheus-2&quot;&gt;prometheus部署&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;首先-什么是 TSDB (Time Series Database):&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;我们可以简单的理解为.一个优化后用来处理时间序列数据的软件,并且数据中的数组是由时间进行索引的.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;时间序列数据库的特点:&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;大部分时间都是写入操作&lt;/li&gt;
  &lt;li&gt;写入操作几乎是顺序添加;大多数时候数据到达后都以时间排序.&lt;/li&gt;
  &lt;li&gt;写操作很少写入很久之前的数据,也很少更新数据.大多数情况在数据被采集到数秒或者数分钟后就会被写入数据库.&lt;/li&gt;
  &lt;li&gt;删除操作一般为区块删除,选定开始的历史时间并指定后续的区块.很少单独删除某个时间或者分开的随机时间的数据.&lt;/li&gt;
  &lt;li&gt;数据一般远远超过内存大小,所以缓存基本无用.系统一般是 IO 密集型&lt;/li&gt;
  &lt;li&gt;读操作是十分典型的升序或者降序的顺序读,&lt;/li&gt;
  &lt;li&gt;高并发的读操作十分常见.&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;常见的时间序列数据库:&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;influxDB	https://influxdata.com/&lt;/li&gt;
  &lt;li&gt;RRDtool	http://oss.oetiker.ch/rrdtool/&lt;/li&gt;
  &lt;li&gt;Graphite	http://graphite.readthedocs.org/en/latest/&lt;/li&gt;
  &lt;li&gt;OpenTSDB	http://opentsdb.net/&lt;/li&gt;
  &lt;li&gt;Kdb+	http://kx.com/&lt;/li&gt;
  &lt;li&gt;Druid	http://druid.io/&lt;/li&gt;
  &lt;li&gt;KairosDB	http://kairosdb.github.io/&lt;/li&gt;
  &lt;li&gt;Prometheus	https://prometheus.io/&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;prometheus&quot;&gt;什么是Prometheus&lt;/h2&gt;

&lt;p&gt;Prometheus是由 SoundCloud 开发的开源监控报警系统和时序列数据库(TSDB)，可以看作是Google内部监控系统Borgmon的一个（非官方）实现。&lt;/p&gt;

&lt;p&gt;并且保持独立于任何公司,Prometheus 在2016加入 CNCF ( Cloud Native Computing Foundation ), 作为在 kubernetes 之后的第二个由基金会主持的项目.&lt;/p&gt;

&lt;p&gt;为什么选择Prometheus而不是其它TSDB实现（如InfluxDB）?&lt;/p&gt;

&lt;p&gt;主要是因为Prometheus的核心功能，查询语言PromQL，它更像一种可编程计算器，而不是其那么像SQL，也意味着PromQL可以近乎无限之组合出各种查询结果&lt;/p&gt;

&lt;h2 id=&quot;section&quot;&gt;主要特点&lt;/h2&gt;

&lt;ol&gt;
  &lt;li&gt;多维数据模型（时序列数据由metric名和一组key/value组成）&lt;/li&gt;
  &lt;li&gt;在多维度上灵活的查询语言(PromQl)&lt;/li&gt;
  &lt;li&gt;不依赖分布式存储，单主节点工作.&lt;/li&gt;
  &lt;li&gt;通过基于HTTP的pull方式采集时序数据&lt;/li&gt;
  &lt;li&gt;可以通过中间网关进行时序列数据推送(pushing)&lt;/li&gt;
  &lt;li&gt;目标服务器可以通过发现服务或者静态配置实现&lt;/li&gt;
  &lt;li&gt;多种可视化和仪表盘支持&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;section-1&quot;&gt;相关组件&lt;/h2&gt;

&lt;p&gt;Prometheus生态系统由多个组件组成，其中许多是可选的：&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Prometheus server&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;主要负责数据采集和存储，提供PromQL查询语言的支持&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;客户端sdk&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;官方提供的客户端类库有go、java、scala、python、ruby，其他还有很多第三方开发的类库，支持nodejs、php、erlang等&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Push Gateway&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;支持临时性Job主动推送指标的中间网关&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;PromDash&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;使用rails开发的dashboard，用于可视化指标数据；目前普遍用Grafana代替&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;exporters&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;支持其他数据源的指标导入到Prometheus，支持数据库、硬件、消息中间件、存储系统、http服务器、jmx等&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;alertmanager&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;实验性的报警管理端(alartmanager,单独进行报警汇总,分发,屏蔽等 )&lt;/p&gt;

&lt;p&gt;promethues 的各个组件基本都是用 golang 编写,对编译和部署十分友好.并且没有特殊依赖.基本都是独立工作.&lt;/p&gt;

&lt;h2 id=&quot;prometheus-1&quot;&gt;prometheus架构&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;&lt;img src=&quot;/pic/prometheus/1.svg&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Prometheus的基本原理是通过HTTP协议周期性抓取被监控组件的状态，任意组件只要提供对应的HTTP接口就可以接入监控。不需要任何SDK或者其他的集成过程。这样做非常适合做虚拟化环境监控系统，&lt;/p&gt;

&lt;p&gt;比如VM、Docker、Kubernetes等。输出被监控组件信息的HTTP接口被叫做exporter 。目前互联网公司常用的组件大部分都有exporter可以直接使用，比如Varnish、Haproxy、Nginx、MySQL、Linux系统信息(包括磁盘、内存、CPU、网络等等)。&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Prometheus服务过程大概是这样：&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;Prometheus Daemon负责定时去目标上抓取metrics(指标)数据，每个抓取目标需要暴露一个http服务的接口给它定时抓取。Prometheus支持通过配置文件、文本文件、Zookeeper、Consul、DNS SRV Lookup等方式指定抓取目标。Prometheus采用PULL的方式进行监控，即服务器可以直接通过目标PULL数据或者间接地通过中间网关来Push数据。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Prometheus在本地存储抓取的所有数据，并通过一定规则进行清理和整理数据，并把得到的结果存储到新的时间序列中。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Prometheus通过PromQL和其他API可视化地展示收集的数据。Prometheus支持很多方式的图表可视化，例如Grafana、自带的Promdash以及自身提供的模版引擎等等。Prometheus还提供HTTP API的查询方式，自定义所需要的输出。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;PushGateway支持Client主动推送metrics到PushGateway，而Prometheus只是定时去Gateway上抓取数据。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Alertmanager是独立于Prometheus的一个组件，可以支持Prometheus的查询语句，提供十分灵活的报警方式。&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;prometheus-2&quot;&gt;prometheus部署&lt;/h2&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;docker run &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
	-p 9090:9090 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
	-v /tmp/prometheus.yml:/etc/prometheus/prometheus.yml &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
	-v /home/mtime/prometheus-docker/data：/prometheus/data &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
	prom/prometheus&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

</description>
        <pubDate>Thu, 27 Jul 2017 00:00:00 +0800</pubDate>
        <link>/docker/Prometheus.html</link>
        <guid isPermaLink="true">/docker/Prometheus.html</guid>
        
        
        <category>Docker</category>
        
      </item>
    
      <item>
        <title>CAdvisor-容器信息采集</title>
        <description>&lt;ul&gt;
  &lt;li&gt;所有主机节点运行CAdvisor&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;docker run &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  --volume&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/:/rootfs:ro &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  --volume&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/var/run:/var/run:rw &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  --volume&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/sys:/sys:ro &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  --volume&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/var/lib/docker/:/var/lib/docker:ro &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  --publish&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;8080:8080 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  --detach&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  --name&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;cadvisor &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  google/cadvisor:latest&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;浏览器访问&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;http://host-ip:8080&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;http://host-ip:8080/metrics&lt;/p&gt;
&lt;/blockquote&gt;

</description>
        <pubDate>Tue, 25 Jul 2017 00:00:00 +0800</pubDate>
        <link>/docker/CAdvisor.html</link>
        <guid isPermaLink="true">/docker/CAdvisor.html</guid>
        
        
        <category>Docker</category>
        
      </item>
    
      <item>
        <title>Harbor-docker企业级仓库</title>
        <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#harbor&quot; id=&quot;markdown-toc-harbor&quot;&gt;Harbor简介&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section&quot; id=&quot;markdown-toc-section&quot;&gt;下载安装&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#section-1&quot; id=&quot;markdown-toc-section-1&quot;&gt;部署要求&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;harbor&quot;&gt;Harbor简介&lt;/h2&gt;

&lt;p&gt;Harbor是一个用于存储和分发Docker镜像的企业级Registry服务器，通过添加一些企业必需的功能特性，例如安全、标识和管理等，扩展了开源Docker Distribution。&lt;/p&gt;

&lt;p&gt;作为一个企业级私有Registry服务器，Harbor提供了更好的性能和安全。提升用户使用Registry构建和运行环境传输镜像的效率。&lt;/p&gt;

&lt;p&gt;Harbor支持安装在多个Registry节点的镜像资源复制，镜像全部保存在私有Registry中， 确保数据和知识产权在公司内部网络中管控。&lt;/p&gt;

&lt;p&gt;另外，Harbor也提供了高级的安全特性，诸如用户管理，访问控制和活动审计等。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;基于角色的访问控制 - 用户与Docker镜像仓库通过“项目”进行组织管理，一个用户可以对多个镜像仓库在同一命名空间（project）里有不同的权限。&lt;/li&gt;
  &lt;li&gt;镜像复制 - 镜像可以在多个Registry实例中复制（同步）。尤其适合于负载均衡，高可用，混合云和多云的场景。&lt;/li&gt;
  &lt;li&gt;图形化用户界面 - 用户可以通过浏览器来浏览，检索当前Docker镜像仓库，管理项目和命名空间。&lt;/li&gt;
  &lt;li&gt;AD/LDAP 支持 - Harbor可以集成企业内部已有的AD/LDAP，用于鉴权认证管理。&lt;/li&gt;
  &lt;li&gt;审计管理 - 所有针对镜像仓库的操作都可以被记录追溯，用于审计管理。&lt;/li&gt;
  &lt;li&gt;国际化 - 已拥有英文、中文、德文、日文和俄文的本地化版本。更多的语言将会添加进来。&lt;/li&gt;
  &lt;li&gt;RESTful API - RESTful API 提供给管理员对于Harbor更多的操控, 使得与其它管理软件集成变得更容易。&lt;/li&gt;
  &lt;li&gt;部署简单 - 提供在线和离线两种安装工具， 也可以安装到vSphere平台(OVA方式)虚拟设备。&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;ul&gt;
  &lt;li&gt;项目地址&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;https://github.com/vmware/harbor/tree/master/docs&lt;/p&gt;
&lt;/blockquote&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;section&quot;&gt;下载安装&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;https://github.com/vmware/harbor/releases&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;section-1&quot;&gt;部署要求&lt;/h3&gt;

&lt;ol&gt;
  &lt;li&gt;python2.7或更高版本&lt;/li&gt;
  &lt;li&gt;安装docker1.12或更高版本&lt;/li&gt;
  &lt;li&gt;安装docker-compose&lt;/li&gt;
&lt;/ol&gt;

&lt;ul&gt;
  &lt;li&gt;安装docker-compose&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;curl -L https://get.daocloud.io/docker/compose/releases/download/1.12.0/docker-compose-&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;uname -s&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;-&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;uname -m&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt; &amp;gt; /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;下载安装包&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;wget https://github.com/vmware/harbor/releases/download/v1.1.2/harbor-online-installer-v1.1.2.tgz
tar xf harbor-online-installer-v1.1.2.tgz&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;配置harbor.cfg&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;&lt;span class=&quot;c&quot;&gt;#必选配置&lt;/span&gt;

hostname：用来访问web的地址IP或域名可加端口号；
ui_url_protocol：仓库被访问的时候使用的协议；
db_password：设置一个DB的强类型密码
max_job_workers：最大job数量，默认是3，主要用来跑从库同步任务的。
customize_crt：默认是on
ssl_cert: ssl证书的位置；前提是设置了https的协议
ssl_cert_key: sslkey的位置；前提设置了https的协议
secretkey_path：用于密文同步镜像的key

&lt;span class=&quot;c&quot;&gt;#可选配置：仅在第一次启动时生效；后续的启动会自动忽略这些配置；推荐后期直接在web页面上配置即可。&lt;/span&gt;

Email settings:用于用户重置密码时发送邮件。
harbor_admin_password：默认的web登录密码。
auth_mode：认证模式：本地数据库认证或LDAP认证。
ldap_url：ldap的配置
project_creation_restriction：是否允许普通用户创建项目；默认任何人都可以创建，可设置adminonly，只有admin可以创建。
verify_remote_cert： harbor同步时是否验证对端的证书。&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;启动Harbor&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;./install.sh&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;hr /&gt;

&lt;p&gt;&lt;img src=&quot;/pic/harbor/1.png&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;end&lt;/p&gt;
</description>
        <pubDate>Mon, 24 Jul 2017 00:00:00 +0800</pubDate>
        <link>/docker/harbor.html</link>
        <guid isPermaLink="true">/docker/harbor.html</guid>
        
        
        <category>Docker</category>
        
      </item>
    
      <item>
        <title>shadow代理</title>
        <description>&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;下载shadow二进制文件&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;编写配置文件&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;cat shadow.json 
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;addr&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;:8080&quot;&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;dial_timeout&quot;&lt;/span&gt;: 30000,
  &lt;span class=&quot;s2&quot;&gt;&quot;read_timeout&quot;&lt;/span&gt;: 120000,
  &lt;span class=&quot;s2&quot;&gt;&quot;proxy&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;192.168.1.2:8080&quot;&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;verbose&quot;&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;addr：监听的IP地址和端口号&lt;/li&gt;
  &lt;li&gt;dial_timeout：连接超时时间&lt;/li&gt;
  &lt;li&gt;read_timeout：传送数据超时时间&lt;/li&gt;
  &lt;li&gt;proxy：二级代理ip和端口号&lt;/li&gt;
  &lt;li&gt;verbose：打印日志&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;supervisorshadow&quot;&gt;利用supervisor管理shadow&lt;/h3&gt;

&lt;p&gt;cat shadow.ini&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;program:shadow]
&lt;span class=&quot;nb&quot;&gt;command&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; /home/mtime/shadow -c /home/mtime/shadow.json
autostart &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;true
&lt;/span&gt;autorestart &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;true
&lt;/span&gt;startsecs &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 3
startretries &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 3
stopwaitsecs &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 5
user &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; root
redirect_stderr &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;true
&lt;/span&gt;stdout_logfile &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; /home/mtime/logs/supervisor/shadow.log
stdout_logfile_maxbytes &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 500MB
stdout_logfile_backups &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 0&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;blockquote&gt;
  &lt;p&gt;supervisorctl reload&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;supervisorctl status&lt;/p&gt;
&lt;/blockquote&gt;

&lt;hr /&gt;

&lt;p&gt;end&lt;/p&gt;

</description>
        <pubDate>Mon, 24 Jul 2017 00:00:00 +0800</pubDate>
        <link>/network/shadow.html</link>
        <guid isPermaLink="true">/network/shadow.html</guid>
        
        
        <category>Network</category>
        
      </item>
    
      <item>
        <title>dns代理-overture</title>
        <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#section&quot; id=&quot;markdown-toc-section&quot;&gt;为什么需要这个代理工具？&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-1&quot; id=&quot;markdown-toc-section-1&quot;&gt;解决方案&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-2&quot; id=&quot;markdown-toc-section-2&quot;&gt;安装配置&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#overture&quot; id=&quot;markdown-toc-overture&quot;&gt;启动overture&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-3&quot; id=&quot;markdown-toc-section-3&quot;&gt;编写启动脚本&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;section&quot;&gt;为什么需要这个代理工具？&lt;/h2&gt;

&lt;ol&gt;
  &lt;li&gt;假设我们有一个域名是www.abc.com;这个一名在公网DNS上有A记录，但是在内网DNS上没有；&lt;/li&gt;
  &lt;li&gt;我们的笔记本指向了内网DNS，此时，当我们解析www.abc.com时，内网DNS将无法解析；&lt;/li&gt;
  &lt;li&gt;根据DNS解析原理；此时无法解析是正常的；因为内网dns上配置了abc.com权威综；当权威dns没有此A记录；是不会发生递归或迭代查询的。&lt;/li&gt;
  &lt;li&gt;最终需要实现：优先返回内网dns记录；内网dns没有A记录；则去公网DNS查询一遍。&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;section-1&quot;&gt;解决方案&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;使用overture代理所有的dns请求；优先找主DNS解析；主DNS无法解析；找备DNS解析；&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;项目源码&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;https://github.com/shawn1m/overture&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;section-2&quot;&gt;安装配置&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;下载overture&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;https://github.com/shawn1m/overture/releases&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;mkdir overture &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;overture
wget https://github.com/shawn1m/overture/releases/download/1.3.5.2/overture-linux-amd64.zip
unzip overture-linux-amd64.zip
cp ip_network_sample ip_network_sample.bak
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;0.0.0.0/0&quot;&lt;/span&gt; &amp;gt; ip_network_sample&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;overture返回主DNS的结果给客户端需要满足两个两件：主DNS给overture返回了一条A记录；此A记录匹配ip_network_sample这个文件中的网段。&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;cat config.json
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;BindAddress&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;:53&quot;&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;PrimaryDNS&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;Name&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;dns-master&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;Address&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;192.168.1.1:53&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;Protocol&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;udp&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;SOCKS5Address&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;Timeout&quot;&lt;/span&gt;: 5,
      &lt;span class=&quot;s2&quot;&gt;&quot;EDNSClientSubnet&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;Policy&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;disable&quot;&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;ExternalIP&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;AlternativeDNS&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;Name&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;dns-salve&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;Address&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;114.114.114.114:53&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;Protocol&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;udp&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;SOCKS5Address&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;Timeout&quot;&lt;/span&gt;: 5,
      &lt;span class=&quot;s2&quot;&gt;&quot;EDNSClientSubnet&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;Policy&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;disable&quot;&lt;/span&gt;,
        &lt;span class=&quot;s2&quot;&gt;&quot;ExternalIP&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;OnlyPrimaryDNS&quot;&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;RedirectIPv6Record&quot;&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;IPNetworkFile&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;./ip_network_sample&quot;&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;DomainFile&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;./domain_sample&quot;&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;DomainBase64Decode&quot;&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;HostsFile&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;./hosts_sample&quot;&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;MinimumTTL&quot;&lt;/span&gt;: 3600,
  &lt;span class=&quot;s2&quot;&gt;&quot;CacheSize&quot;&lt;/span&gt; : 500,
  &lt;span class=&quot;s2&quot;&gt;&quot;RejectQtype&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;255]
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;BindAddress：监听的ip地址和端口号，默认同时监听TCP和UDP端口。&lt;/li&gt;
  &lt;li&gt;PrimaryDNS：主dns&lt;/li&gt;
  &lt;li&gt;Name：dns标志&lt;/li&gt;
  &lt;li&gt;Address：dns的ip和端口号&lt;/li&gt;
  &lt;li&gt;Protocol：使用的协议&lt;/li&gt;
  &lt;li&gt;SOCKS5Address：转发dns请求到socket5代理&lt;/li&gt;
  &lt;li&gt;Timeout：代理到后端的超时时间&lt;/li&gt;
  &lt;li&gt;EDNSClientSubnet：智能dns解析，根据客户端的IP地址做判断而不是客户端指定的dns的ip地址；可参考 https://tools.ietf.org/html/rfc7871&lt;/li&gt;
  &lt;li&gt;MinimumTTL：overture缓存解析记录的时长&lt;/li&gt;
  &lt;li&gt;CacheSize：overture缓存大小&lt;/li&gt;
  &lt;li&gt;RejectQtype：拒绝指定类型的DNS请求：可参考 https://en.wikipedia.org/wiki/List_of_DNS_record_types&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;overture&quot;&gt;启动overture&lt;/h2&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;./overture-linux-amd64 --help
Usage of ./overture-linux-amd64:
  -c string
        config file path &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;default &lt;span class=&quot;s2&quot;&gt;&quot;./config.json&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
  -l string
        log file path &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;default &lt;span class=&quot;s2&quot;&gt;&quot;./overture.log&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
  -p int
        number of processor to use &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;default 24&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
  -v    verbose mode&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;-c：指定配置文件路径；默认当前启动路径的下的config.json文件&lt;/li&gt;
  &lt;li&gt;-l：指定日志路径和日志文件；默认当前启动路径下的overture.log&lt;/li&gt;
  &lt;li&gt;-p：指定进程数；默认当前cpu的核心数&lt;/li&gt;
  &lt;li&gt;-v：debug日志模式&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;section-3&quot;&gt;编写启动脚本&lt;/h2&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;&lt;span class=&quot;c&quot;&gt;#!/bin/bash   &lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt; -e   
&lt;span class=&quot;nv&quot;&gt;TOOLS_NAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;overture-linux-amd64&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;TOOLS_PATH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/home/mtime/overture&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;TOOLS_SERVER_NAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Overture Server&quot;&lt;/span&gt; 
&lt;span class=&quot;nv&quot;&gt;DESCRIPTION&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Pls use /etc/init.d/overture start|stop|restart&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;PIDFILE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/home/mtime/overture/overture.pid&quot;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; ! -x &lt;span class=&quot;nv&quot;&gt;$DAEMON&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;;&lt;span class=&quot;k&quot;&gt;then
    &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; -e &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[32mNOT Find &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TOOLS_PATH&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TOOLS_NAME&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[0m&quot;&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;exit &lt;/span&gt;1
&lt;span class=&quot;k&quot;&gt;fi   

case&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$1&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in 
  &lt;/span&gt;start&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;   
         &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; -f &lt;span class=&quot;nv&quot;&gt;$PIDFILE&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;;&lt;span class=&quot;k&quot;&gt;then
            &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; -e &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[32m&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TOOLS_SERVER_NAME&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; was Started.&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[0m&quot;&lt;/span&gt;
            &lt;span class=&quot;nb&quot;&gt;exit &lt;/span&gt;0
         &lt;span class=&quot;k&quot;&gt;fi
         &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; -e &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[32mSTARTTING &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TOOLS_SERVER_NAME&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;......&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[0m&quot;&lt;/span&gt;
         nohup &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TOOLS_PATH&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;/&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TOOLS_NAME&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; -c &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TOOLS_PATH&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;/config.json -l &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TOOLS_PATH&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;/overture.log &amp;amp;&amp;gt;/dev/null &amp;amp;  
         touch &lt;span class=&quot;nv&quot;&gt;$PIDFILE&lt;/span&gt;
         &lt;span class=&quot;p&quot;&gt;;;&lt;/span&gt;   
   stop&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; 
         &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; ! -f &lt;span class=&quot;nv&quot;&gt;$PIDFILE&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;;&lt;span class=&quot;k&quot;&gt;then
            &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; -e &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[32m&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TOOLS_SERVER_NAME&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; was Stopped.&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[0m&quot;&lt;/span&gt;
            &lt;span class=&quot;nb&quot;&gt;exit &lt;/span&gt;0
         &lt;span class=&quot;k&quot;&gt;fi
         &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; -e &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[32mSTOPPING &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TOOLS_SERVER_NAME&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;......&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[0m&quot;&lt;/span&gt;
         &lt;span class=&quot;nb&quot;&gt;kill&lt;/span&gt; -9 &lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;pidof &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TOOLS_NAME&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt; &amp;amp;&amp;gt; /dev/null   
         rm -f &lt;span class=&quot;nv&quot;&gt;$PIDFILE&lt;/span&gt;
         &lt;span class=&quot;p&quot;&gt;;;&lt;/span&gt;   
   restart&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;   
         &lt;span class=&quot;nv&quot;&gt;$0&lt;/span&gt; stop &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; sleep 1 &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$0&lt;/span&gt; start   
         &lt;span class=&quot;p&quot;&gt;;;&lt;/span&gt;   
   &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;   
         &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; -e &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[31mUsage: &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$DESCRIPTION&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[0m&quot;&lt;/span&gt;
         &lt;span class=&quot;nb&quot;&gt;exit &lt;/span&gt;1   
&lt;span class=&quot;k&quot;&gt;esac&lt;/span&gt;   &lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;hr /&gt;

&lt;p&gt;end&lt;/p&gt;

</description>
        <pubDate>Mon, 24 Jul 2017 00:00:00 +0800</pubDate>
        <link>/network/overture.html</link>
        <guid isPermaLink="true">/network/overture.html</guid>
        
        
        <category>Network</category>
        
      </item>
    
      <item>
        <title>带宽测试工具--iperf</title>
        <description>&lt;h2 id=&quot;iperf&quot;&gt;安装iperf&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;Tar包安装&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;wget http://downloads.es.net/pub/iperf/iperf-3.0.6.tar.gz
tar xf iperf-3.0.6.tar.gz 
&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;iperf-3.0.6
./configure 
make
make install&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;Docker容器形式安装&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;docker pull moutten/iperf:3.1&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;section&quot;&gt;测试网络带宽&lt;/h2&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;iperf3 -u -c 192.168.1.251 -p 5201 -b 1000M -t 60&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;docker run -it -p 5201:5201/tcp -p 5201:5201/udp moutten/iperf:3.1&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;docker service create &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  --name iperf &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  --constraint &lt;span class=&quot;s1&quot;&gt;'node.hostname==kafka02'&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  --publish 5201:5201/tcp &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  --publish 5201:5201/udp &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  moutten/iperf:3.1&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;hr /&gt;

&lt;p&gt;end&lt;/p&gt;

</description>
        <pubDate>Fri, 16 Jun 2017 00:00:00 +0800</pubDate>
        <link>/network/iperf.html</link>
        <guid isPermaLink="true">/network/iperf.html</guid>
        
        
        <category>Network</category>
        
      </item>
    
      <item>
        <title>KVM学习笔记</title>
        <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#section&quot; id=&quot;markdown-toc-section&quot;&gt;实验环境准备&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-1&quot; id=&quot;markdown-toc-section-1&quot;&gt;系统优化&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#kvm&quot; id=&quot;markdown-toc-kvm&quot;&gt;kvm环境验证&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#kvm-1&quot; id=&quot;markdown-toc-kvm-1&quot;&gt;安装kvm&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#kvm-2&quot; id=&quot;markdown-toc-kvm-2&quot;&gt;启动kvm服务&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#section-2&quot; id=&quot;markdown-toc-section-2&quot;&gt;准备系统镜像&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#kvm-3&quot; id=&quot;markdown-toc-kvm-3&quot;&gt;kvm创建磁盘文件&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#kvm-4&quot; id=&quot;markdown-toc-kvm-4&quot;&gt;kvm创建虚拟机&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#kvm-5&quot; id=&quot;markdown-toc-kvm-5&quot;&gt;KVM网络模式&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#bridge&quot; id=&quot;markdown-toc-bridge&quot;&gt;Bridge模式&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#nat&quot; id=&quot;markdown-toc-nat&quot;&gt;NAT模式&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#virsh&quot; id=&quot;markdown-toc-virsh&quot;&gt;virsh基础命令&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#vnc&quot; id=&quot;markdown-toc-vnc&quot;&gt;VNC远程连接虚拟机&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#windows&quot; id=&quot;markdown-toc-windows&quot;&gt;windows客户端安装&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#vm&quot; id=&quot;markdown-toc-vm&quot;&gt;vm虚拟机系统优化&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#vmnginx&quot; id=&quot;markdown-toc-vmnginx&quot;&gt;vm安装nginx&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#clone&quot; id=&quot;markdown-toc-clone&quot;&gt;虚拟机clone&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#virshclone&quot; id=&quot;markdown-toc-virshclone&quot;&gt;virsh直接clone&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#section-3&quot; id=&quot;markdown-toc-section-3&quot;&gt;配置文件+磁盘文件&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-4&quot; id=&quot;markdown-toc-section-4&quot;&gt;时区问题&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-5&quot; id=&quot;markdown-toc-section-5&quot;&gt;快照&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-6&quot; id=&quot;markdown-toc-section-6&quot;&gt;测试&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;section&quot;&gt;实验环境准备&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;系统版本：CentOS-7.2&lt;/li&gt;
  &lt;li&gt;系统内核：3.10.0-327.el7.x86_64&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;section-1&quot;&gt;系统优化&lt;/h2&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;sed -i &lt;span class=&quot;s1&quot;&gt;'s/SELINUX=.*/SELINUX=disabled/g'&lt;/span&gt; /etc/selinux/config
setenforce 0
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; -e  &lt;span class=&quot;s2&quot;&gt;&quot;* soft nofile 102400&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;* hard nofile 102400&quot;&lt;/span&gt; &amp;gt;&amp;gt; /etc/security/limits.conf
systemctl stop firewalld.service
systemctl disable firewalld.service
systemctl stop NetworkManager.service
systemctl disable NetworkManager.service
sed -i &lt;span class=&quot;s1&quot;&gt;'s/DNS1=.*/DNS1=114.114.114.114/g'&lt;/span&gt; /etc/sysconfig/network-scripts/ifcfg-eth0 
cat &amp;gt;/etc/resolv.conf&lt;span class=&quot;sh&quot;&gt;&amp;lt;&amp;lt;EOF
nameserver 114.114.114.114
nameserver 180.76.76.76
EOF
&lt;/span&gt;systemctl restart network
yum install wget -y
mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup
wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
yum makecache
yum install vim lrzsz net-tools ntpdate -y
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;*/5 * * * * /usr/sbin/ntpdate ntp1.aliyun.com &amp;gt;/dev/null 2&amp;gt;&amp;amp;1&quot;&lt;/span&gt; &amp;gt;&amp;gt;/var/spool/cron/root&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;kvm&quot;&gt;kvm环境验证&lt;/h2&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# lsmod |grep kvm
kvm_intel             162153  3 
kvm                   525259  1 kvm_intel&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# grep -E &lt;span class=&quot;s2&quot;&gt;&quot;svm|vmx&quot;&lt;/span&gt; /proc/cpuinfo
flags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon pebs bts rep_good nopl xtopology nonstop_tsc aperfmperf pni pclmulqdq dtes64 monitor ds_cpl vmx smx est tm2 ssse3 cx16 xtpr pdcm pcid dca sse4_1 sse4_2 popcnt aes lahf_lm ida arat dtherm tpr_shadow vnmi flexpriority ept vpid
......&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;&lt;img src=&quot;/pic/kvm/2.png&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;kvm-1&quot;&gt;安装kvm&lt;/h2&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;yum -y install qemu-kvm libvirt virt-install libvirt-python acpid&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h2 id=&quot;kvm-2&quot;&gt;启动kvm服务&lt;/h2&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;systemctl start acpid.service
systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;acpid.service
systemctl start libvirtd.service
systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;libvirtd.service&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h3 id=&quot;section-2&quot;&gt;准备系统镜像&lt;/h3&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;mkdir -p /home/iso
&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; /home/iso/
wget http://mirrors.163.com/centos/7.3.1611/isos/x86_64/CentOS-7-x86_64-Minimal-1611.iso&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;kvm-3&quot;&gt;kvm创建磁盘文件&lt;/h2&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;mkdir /home/kvm_images
qemu-img create -f raw /home/kvm_images/centos7-1.raw 20G
qemu-img create -f raw /home/kvm_images/windows2008-1.raw 100G&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;blockquote&gt;
  &lt;p&gt;qemu-img info /home/kvm_images/windows2008-1.raw&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;kvm-4&quot;&gt;kvm创建虚拟机&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;Linux&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;virt-install --virt-type&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;kvm --name&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;centos7-1 --vcpus&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;8 --memory&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;4096 --cdrom&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/home/iso/CentOS-7-x86_64-Minimal-1611.iso --disk &lt;span class=&quot;nv&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/home/kvm_images/centos7-1.img --network &lt;span class=&quot;nv&quot;&gt;network&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;default --vnc --vnclisten&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0.0.0.0 --vncport&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;12345 --noautoconsole --accelerate --os-type&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;linux --os-variant&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;rhel6&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;Windows&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;virt-install --virt-type&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;kvm --name&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;windows-2008-1 --vcpus&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;16 --memory&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;4096 --cdrom&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/home/iso/Windows_Server_2008_R2.iso --disk &lt;span class=&quot;nv&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/home/kvm_images/windows2008-1.raw --network &lt;span class=&quot;nv&quot;&gt;network&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;default --vnc --vnclisten&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0.0.0.0 --vncport&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;12346 --noautoconsole --accelerate --os-type&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;windows --os-variant&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;win2k8&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;–name指定虚拟机名称&lt;/li&gt;
  &lt;li&gt;–memory分配内存大小。&lt;/li&gt;
  &lt;li&gt;–vcpus分配CPU核心数，最大与实体机CPU核心数相同&lt;/li&gt;
  &lt;li&gt;–disk指定虚拟机镜像，size指定分配大小单位为G。&lt;/li&gt;
  &lt;li&gt;–network网络类型，此处用的是默认，一般用的应该是bridge桥接。&lt;/li&gt;
  &lt;li&gt;–accelerate加速&lt;/li&gt;
  &lt;li&gt;–cdrom指定安装镜像iso&lt;/li&gt;
  &lt;li&gt;–vnc启用VNC远程管理，一般安装系统都要启用。&lt;/li&gt;
  &lt;li&gt;–vncport指定VNC监控端口，默认端口为5900，端口不能重复。&lt;/li&gt;
  &lt;li&gt;–vnclisten指定VNC绑定IP，默认绑定127.0.0.1，这里改为0.0.0.0。&lt;/li&gt;
  &lt;li&gt;–os-type=linux,windows&lt;/li&gt;
  &lt;li&gt;–os-variant=rhel6&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;kvm-5&quot;&gt;KVM网络模式&lt;/h2&gt;

&lt;h3 id=&quot;bridge&quot;&gt;Bridge模式&lt;/h3&gt;

&lt;p&gt;在bridged模式下，虚拟出来的操作系统就像是局域网中的一台独立的主机;&lt;/p&gt;

&lt;p&gt;它可以访问网内任何一台机器。同时，由于这个虚拟系统是局域网中的一个独立的主机系统，那么就可以手工配置它的TCP/IP配置信息，以实现通过局域网的网关或路由器访问互联网;&lt;/p&gt;

&lt;p&gt;使用bridged模式的虚拟系统和宿主机器的关系，就像连接在同一个Hub上的两台电脑。想让它们相互通讯，你就需要为虚拟系统配置IP地址和子网掩码，否则就无法通信;&lt;/p&gt;

&lt;p&gt;这种方式最简单，直接将虚拟网卡桥接到一个物理网卡上面，和linux下一个网卡绑定两个不同地址类似，实际上是将网卡设置为混杂模式，从而达到侦听多个IP的能力;&lt;/p&gt;

&lt;p&gt;在此种模式下，虚拟机内部的网卡（例如linux下的eth0)直接连到了物理网卡所在的网络上，可以想象为虚拟机和host机处于对等的地位，在网络关系上是平等的，没有谁在谁后面的问题。使用这种方式很简单，前提是你可以得到1个以上的IP地址。&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt;  /etc/sysconfig/network-scripts/
cp ifcfg-em1 ifcfg-br0&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# cat /etc/sysconfig/network-scripts/ifcfg-em1
&lt;span class=&quot;nv&quot;&gt;TYPE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;Ethernet
&lt;span class=&quot;nv&quot;&gt;BOOTPROTO&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;static
&lt;span class=&quot;nv&quot;&gt;NAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;em1
&lt;span class=&quot;nv&quot;&gt;DEVICE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;em1
&lt;span class=&quot;nv&quot;&gt;ONBOOT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;yes
&lt;span class=&quot;nv&quot;&gt;IPADDR&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;123.126.176.207
&lt;span class=&quot;nv&quot;&gt;NETMASK&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;255.255.255.0
&lt;span class=&quot;nv&quot;&gt;GATEWAY&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;123.126.176.165
&lt;span class=&quot;nv&quot;&gt;DNS1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;114.114.114.114
&lt;span class=&quot;nv&quot;&gt;BRIDGE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;br0&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# cat /etc/sysconfig/network-scripts/ifcfg-br0 
&lt;span class=&quot;nv&quot;&gt;TYPE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;Bridge
&lt;span class=&quot;nv&quot;&gt;BOOTPROTO&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;static
&lt;span class=&quot;nv&quot;&gt;NAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;em1
&lt;span class=&quot;nv&quot;&gt;DEVICE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;br0
&lt;span class=&quot;nv&quot;&gt;ONBOOT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;yes
&lt;span class=&quot;nv&quot;&gt;IPADDR&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;123.126.176.207
&lt;span class=&quot;nv&quot;&gt;NETMASK&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;255.255.255.0
&lt;span class=&quot;nv&quot;&gt;GATEWAY&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;123.126.176.165
&lt;span class=&quot;nv&quot;&gt;DNS1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;114.114.114.114&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;systemctl restart network&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# brctl show
bridge name     bridge id               STP enabled     interfaces
br0             8000.842b2b6dd23c       no              em1
virbr0          8000.52540028ef19       yes             virbr0-nic&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h3 id=&quot;nat&quot;&gt;NAT模式&lt;/h3&gt;

&lt;p&gt;使用NAT模式，就是让虚拟系统借助NAT(网络地址转换)功能，通过宿主机器所在的网络来访问公网；&lt;/p&gt;

&lt;p&gt;也就是说，使用NAT模式可以实现在虚拟系统里访问互联网。很显然，如果你只有一个外网地址，此种方式很合适。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;virsh net-undefine default&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;    &amp;lt;network&amp;gt;  
      &amp;lt;name&amp;gt;default&amp;lt;/name&amp;gt;  
      &amp;lt;uuid&amp;gt;dc69ff61-6445-4376-b940-8714a3922bf7&amp;lt;/uuid&amp;gt;  
      &amp;lt;forward &lt;span class=&quot;nv&quot;&gt;mode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'nat'&lt;/span&gt;/&amp;gt;  
      &amp;lt;bridge &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'virbr0'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;stp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'on'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;delay&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'0'&lt;/span&gt; /&amp;gt;  
      &amp;lt;mac &lt;span class=&quot;nv&quot;&gt;address&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'52:54:00:81:14:18'&lt;/span&gt;/&amp;gt;  
      &amp;lt;ip &lt;span class=&quot;nv&quot;&gt;address&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'192.168.122.1'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;netmask&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'255.255.255.0'&lt;/span&gt;&amp;gt;  
        &amp;lt;dhcp&amp;gt;  
          &amp;lt;range &lt;span class=&quot;nv&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'192.168.122.2'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'192.168.122.254'&lt;/span&gt; /&amp;gt;  
          &amp;lt;host &lt;span class=&quot;nv&quot;&gt;mac&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'00:25:90:eb:4b:bb'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'guest1'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;ip&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'192.168.5.13'&lt;/span&gt; /&amp;gt;  
          &amp;lt;host &lt;span class=&quot;nv&quot;&gt;mac&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'00:25:90:eb:34:2c'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'guest2'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;ip&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'192.168.7.206'&lt;/span&gt; /&amp;gt;  
          &amp;lt;host &lt;span class=&quot;nv&quot;&gt;mac&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'00:25:90:eb:e5:de'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'guest3'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;ip&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'192.168.7.207'&lt;/span&gt; /&amp;gt;  
          &amp;lt;host &lt;span class=&quot;nv&quot;&gt;mac&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'00:25:90:eb:7e:11'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'guest4'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;ip&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'192.168.7.208'&lt;/span&gt; /&amp;gt;  
          &amp;lt;host &lt;span class=&quot;nv&quot;&gt;mac&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'00:25:90:eb:b2:11'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'guest5'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;ip&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'192.168.7.209'&lt;/span&gt; /&amp;gt;  
        &amp;lt;/dhcp&amp;gt;  
      &amp;lt;/ip&amp;gt;  
    &amp;lt;/network&amp;gt;  &lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;virsh&quot;&gt;virsh基础命令&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;virt-install 生成kvm虚拟机&lt;/li&gt;
  &lt;li&gt;virsh list 查看在运行的虚拟机&lt;/li&gt;
  &lt;li&gt;virsh list –all 查看所有虚拟机&lt;/li&gt;
  &lt;li&gt;virsh dumpxml vm-name 查看kvm虚拟机配置文件&lt;/li&gt;
  &lt;li&gt;virsh start vm-name 启动kvm虚拟机&lt;/li&gt;
  &lt;li&gt;virsh shutdown vm-name 正常关机&lt;/li&gt;
  &lt;li&gt;virsh destroy vm-name 非正常关机（相当于物理机直接拔掉电源）&lt;/li&gt;
  &lt;li&gt;virsh undefine vm-name 删除vm的配置文件&lt;/li&gt;
  &lt;li&gt;virsh define file-name.xml 根据配置文件定义虚拟机&lt;/li&gt;
  &lt;li&gt;virsh suspend vm-name 挂起，终止&lt;/li&gt;
  &lt;li&gt;virsh resumed vm-name 恢复挂起状态&lt;/li&gt;
  &lt;li&gt;virsh autostart vm-name 开机自启动vm&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;vnc&quot;&gt;VNC远程连接虚拟机&lt;/h2&gt;

&lt;h3 id=&quot;windows&quot;&gt;windows客户端安装&lt;/h3&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;https://www.realvnc.com/download/file/vnc.files/VNC-6.1.1-Windows.exe&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;通过vnc连接 IP+port（12345）进行安装系统：&lt;/p&gt;

&lt;h3 id=&quot;vm&quot;&gt;vm虚拟机系统优化&lt;/h3&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;sed -i &lt;span class=&quot;s1&quot;&gt;'s/SELINUX=.*/SELINUX=disabled/g'&lt;/span&gt; /etc/selinux/config
setenforce 0
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; -e  &lt;span class=&quot;s2&quot;&gt;&quot;* soft nofile 102400&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;* hard nofile 102400&quot;&lt;/span&gt; &amp;gt;&amp;gt; /etc/security/limits.conf
systemctl stop firewalld.service
systemctl disable firewalld.service
systemctl stop NetworkManager.service
systemctl disable NetworkManager.service
sed -i &lt;span class=&quot;s1&quot;&gt;'s/DNS1=.*/DNS1=114.114.114.114/g'&lt;/span&gt; /etc/selinux/config
systemctl restart network
yum install wget -y
mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup
wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
yum makecache
yum install vim lrzsz net-tools.x86_64 -y&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h3 id=&quot;vmnginx&quot;&gt;vm安装nginx&lt;/h3&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;wget http://nginx.org/download/nginx-1.12.0.tar.gz
yum install gcc -y
yum install openssl-devel pcre-devel -y
tar xf nginx-1.12.0.tar.gz
&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;nginx-1.12.0
./configure --prefix&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/local/nginx-1.12.0 --user&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;nginx --group&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;nginx --with-http_ssl_module --with-http_stub_status_module
make &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; make install
ln -s /usr/local/nginx-1.12.0/ /etc/nginx
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&amp;lt;h1&amp;gt;This is work-node01 &amp;lt;/h1&amp;gt;&quot;&lt;/span&gt; &amp;gt; /usr/local/nginx-1.12.0/html/index.html 
/usr/local/nginx-1.12.0/sbin/nginx&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;clone&quot;&gt;虚拟机clone&lt;/h2&gt;

&lt;h3 id=&quot;virshclone&quot;&gt;virsh直接clone&lt;/h3&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;virsh shutdown centos7-1
virt-clone -o centos7-1 -n centos7-2 -f /home/kvm_images/centos7-2.raw
virsh edit centos7-2
修改VNC端口&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;/usr/local/nginx-1.12.0/sbin/nginx
hostnamectl &lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt;-hostname worker-node02
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&amp;lt;h1&amp;gt;This is work-node02 &amp;lt;/h1&amp;gt;&quot;&lt;/span&gt; &amp;gt; /usr/local/nginx-1.12.0/html/index.html 
/usr/local/nginx-1.12.0/sbin/nginx&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h3 id=&quot;section-3&quot;&gt;配置文件+磁盘文件&lt;/h3&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;virsh shutdown centos7-1
virsh dumpxml centos7-1 &amp;gt; /etc/libvirt/qemu/centos7-3.xml
cp /home/kvm_images/centos7-1.img /home/kvm_images/centos7-3.img
vim /etc/libvirt/qemu/centos7-3.xml&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;diff /etc/libvirt/qemu/centos7-1.xml /etc/libvirt/qemu/centos7-3.xml&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;&amp;lt;   &amp;lt;name&amp;gt;centos7-1&amp;lt;/name&amp;gt;
&amp;lt;   &amp;lt;uuid&amp;gt;51e8a434-3aca-4664-a4df-25c42226a9ed&amp;lt;/uuid&amp;gt;
---
&lt;span class=&quot;gp&quot;&gt;&amp;gt;   &lt;/span&gt;&amp;lt;name&amp;gt;centos7-3&amp;lt;/name&amp;gt;
&lt;span class=&quot;gp&quot;&gt;&amp;gt;   &lt;/span&gt;&amp;lt;uuid&amp;gt;51e8a434-3aca-4664-a4df-25c42226a900&amp;lt;/uuid&amp;gt;
25c25
&amp;lt;       &amp;lt;&lt;span class=&quot;nb&quot;&gt;source &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'/home/kvm_images/centos7-1.img'&lt;/span&gt;/&amp;gt;
---
&lt;span class=&quot;gp&quot;&gt;&amp;gt;       &lt;/span&gt;&amp;lt;&lt;span class=&quot;nb&quot;&gt;source &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'/home/kvm_images/centos7-3.img'&lt;/span&gt;/&amp;gt;
74c74
&amp;lt;       &amp;lt;mac &lt;span class=&quot;nv&quot;&gt;address&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'52:54:00:2e:ef:7f'&lt;/span&gt;/&amp;gt;
---
&lt;span class=&quot;gp&quot;&gt;&amp;gt;       &lt;/span&gt;&amp;lt;mac &lt;span class=&quot;nv&quot;&gt;address&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'52:54:00:2e:ef:7a'&lt;/span&gt;/&amp;gt;
94c94
&amp;lt;     &amp;lt;graphics &lt;span class=&quot;nb&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'vnc'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'12345'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;autoport&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'no'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;listen&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'0.0.0.0'&lt;/span&gt;&amp;gt;
---
&lt;span class=&quot;gp&quot;&gt;&amp;gt;     &lt;/span&gt;&amp;lt;graphics &lt;span class=&quot;nb&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'vnc'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'12347'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;autoport&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'no'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;listen&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'0.0.0.0'&lt;/span&gt;&amp;gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;virsh define /etc/libvirt/qemu/centos7-3.xml
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost qemu]# virsh list --all
 Id    Name                           State
----------------------------------------------------
 12    centos7-2                      running
 -     centos7-1                      shut off
 -     centos7-3                      shut off
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost qemu]# virsh start centos7-3
Domain centos7-3 started&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;vnc 连接虚拟机 更改IP地址&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;/usr/local/nginx-1.12.0/sbin/nginx
hostnamectl &lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt;-hostname worker-node03
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&amp;lt;h1&amp;gt;This is work-node03 &amp;lt;/h1&amp;gt;&quot;&lt;/span&gt; &amp;gt; /usr/local/nginx-1.12.0/html/index.html
/usr/local/nginx-1.12.0/sbin/nginx&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h2 id=&quot;section-4&quot;&gt;时区问题&lt;/h2&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;TZ='Asia/Shanghai'; export TZ&quot;&lt;/span&gt; &amp;gt;&amp;gt; /etc/profile&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h2 id=&quot;section-5&quot;&gt;快照&lt;/h2&gt;

&lt;p&gt;kvm虚拟机默认使用raw格式的镜像格式，性能最好，速度最快;&lt;/p&gt;

&lt;p&gt;它的缺点就是不支持一些新的功能，如支持镜像,zlib磁盘压缩,AES加密等。&lt;/p&gt;

&lt;p&gt;要使用镜像功能，磁盘格式必须为qcow2。下面开始kvm虚拟机快照备份的过程。&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# qemu-img info /home/kvm_images/centos7-3.img 
image: /home/kvm_images/centos7-3.img
file format: raw
virtual size: 20G &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;21474836480 bytes&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
disk size: 2.1G

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# virsh shutdown centos7-3
Domain centos7-3 is being shutdown
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# qemu-img convert -f raw -O qcow2 /home/kvm_images/centos7-3.img /home/kvm_images/centos7-3.qcow2

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# qemu-img info /home/kvm_images/centos7-3.qcow2 
image: /home/kvm_images/centos7-3.qcow2
file format: qcow2
virtual size: 20G &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;21474836480 bytes&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
disk size: 2.0G
cluster_size: 65536
Format specific information:
    compat: 1.1
    lazy refcounts: &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;
	
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# virsh snapshot-create centos7-3 
Domain snapshot 1497367511 created

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# virsh snapshot-list centos7-3
 Name                 Creation Time             State
------------------------------------------------------------
 1497367511           2017-06-13 23:25:11 +0800 shutoff
 
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# virsh snapshot-current centos7-3|head
&amp;lt;domainsnapshot&amp;gt;
  &amp;lt;name&amp;gt;1497367511&amp;lt;/name&amp;gt;
  &amp;lt;state&amp;gt;shutoff&amp;lt;/state&amp;gt;
  &amp;lt;creationTime&amp;gt;1497367511&amp;lt;/creationTime&amp;gt;
  &amp;lt;memory &lt;span class=&quot;nv&quot;&gt;snapshot&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'no'&lt;/span&gt;/&amp;gt;
  &amp;lt;disks&amp;gt;
    &amp;lt;disk &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'vda'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;snapshot&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'internal'&lt;/span&gt;/&amp;gt;
    &amp;lt;disk &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'hda'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;snapshot&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'no'&lt;/span&gt;/&amp;gt;
  &amp;lt;/disks&amp;gt;
  &amp;lt;domain &lt;span class=&quot;nb&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'kvm'&lt;/span&gt;&amp;gt;
  
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# virsh snapshot-create centos7-3 
Domain snapshot 1497367618 created

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# ll /var/lib/libvirt/qemu/snapshot/centos7-3/
total 16
-rw------- 1 root root 4310 Jun 13 23:26 1497367511.xml
-rw------- 1 root root 4361 Jun 13 23:26 1497367618.xml

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# virsh snapshot-delete centos7-3 1497367618
Domain snapshot 1497367618 deleted&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;&lt;img src=&quot;/pic/kvm/10.png&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/pic/kvm/11.png&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/pic/kvm/12.png&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/pic/kvm/13.png&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;section-6&quot;&gt;测试&lt;/h2&gt;

&lt;p&gt;&lt;img src=&quot;/pic/kvm/9.png&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

</description>
        <pubDate>Wed, 14 Jun 2017 00:00:00 +0800</pubDate>
        <link>/kvm/KVM.html</link>
        <guid isPermaLink="true">/kvm/KVM.html</guid>
        
        
        <category>Kvm</category>
        
      </item>
    
      <item>
        <title>Docker -- 日志系统FKLEK</title>
        <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#fklek&quot; id=&quot;markdown-toc-fklek&quot;&gt;FKLEK系统介绍&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section&quot; id=&quot;markdown-toc-section&quot;&gt;实验环境准备&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-1&quot; id=&quot;markdown-toc-section-1&quot;&gt;系统环境准备&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#zookeeper&quot; id=&quot;markdown-toc-zookeeper&quot;&gt;部署zookeeper集群&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#kafka&quot; id=&quot;markdown-toc-kafka&quot;&gt;部署kafka集群&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#fluentd&quot; id=&quot;markdown-toc-fluentd&quot;&gt;部署Fluentd收集日志&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#elasticsearch&quot; id=&quot;markdown-toc-elasticsearch&quot;&gt;部署elasticsearch&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#logstash&quot; id=&quot;markdown-toc-logstash&quot;&gt;部署logstash&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#kibana&quot; id=&quot;markdown-toc-kibana&quot;&gt;部署kibana&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-2&quot; id=&quot;markdown-toc-section-2&quot;&gt;环境检查&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#nginx&quot; id=&quot;markdown-toc-nginx&quot;&gt;部署nginx测试&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;fklek&quot;&gt;FKLEK系统介绍&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;Fluentd: 专业的集中化容器日志收集工具&lt;/li&gt;
  &lt;li&gt;Kafka：高吞吐异步消息队列&lt;/li&gt;
  &lt;li&gt;Logstash：接收，发送，过滤，分隔日志&lt;/li&gt;
  &lt;li&gt;ElasticSearch：存储和索引日志&lt;/li&gt;
  &lt;li&gt;Kibana：用来索引，展示，分析日志的UI&lt;/li&gt;
&lt;/ul&gt;

&lt;ol&gt;
  &lt;li&gt;Fluentd将所有容器的日志并转发到kafka上。&lt;/li&gt;
  &lt;li&gt;Kafka临时存储所有容器的日志；用于被Logstash消费&lt;/li&gt;
  &lt;li&gt;Logstash消费kafka的日志，最终转存到ElasticSearch上。&lt;/li&gt;
  &lt;li&gt;ElasticSearch永久存储日志的数据库&lt;/li&gt;
  &lt;li&gt;Kibana从ElasticSearch中抽取数据页面展示&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Docker ==&amp;gt; Fluentd ==&amp;gt; Kafka ==&amp;gt; Logstash ==&amp;gt; ElasticSearch ==&amp;gt; Kibana&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;section&quot;&gt;实验环境准备&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;系统要求：CentOS-7.2&lt;/li&gt;
  &lt;li&gt;内核要求：3.10.0-327.el7.x86_64&lt;/li&gt;
  &lt;li&gt;Docker版本：17.03.1-ce&lt;/li&gt;
  &lt;li&gt;JAVA环境：JDK_1.8&lt;/li&gt;
  &lt;li&gt;Zookeeper版本：zookeeper-3.4.6&lt;/li&gt;
  &lt;li&gt;kafka版本： 2.11-0.10.0.1&lt;/li&gt;
  &lt;li&gt;elasticsearch版本：2.4&lt;/li&gt;
  &lt;li&gt;logstash版本：2.4&lt;/li&gt;
  &lt;li&gt;kibana版本：4.6&lt;/li&gt;
  &lt;li&gt;fluentd版本：任意&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;IP地址和应用安装对应表&lt;/p&gt;

&lt;p&gt;192.168.1.250 ===== kafka01 Fluentd(Container) Kibana(Container)&lt;/p&gt;

&lt;p&gt;192.168.1.251 ===== kafka02 Fluentd(Container) ElasticSearch(Container)&lt;/p&gt;

&lt;p&gt;192.168.1.252 ===== kafka03 Fluentd(Container) Logstash(Container)&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;section-1&quot;&gt;系统环境准备&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;主机名解析&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;所有节点：&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
192.168.1.250   kafka01
192.168.1.251   kafka02
192.168.1.252   kafka03
192.168.1.250 192.168.1.251 192.168.1.252 fluentd.test.com	&lt;span class=&quot;c&quot;&gt;#利用DNS轮询伪造fluentd集群&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;JAVA_1.8环境部署&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;tar xf jdk-8u11-linux-x64.tar.gz -C /usr/local/
cat &amp;gt;&amp;gt; /etc/profile &lt;span class=&quot;sh&quot;&gt;&amp;lt;&amp;lt;EOF
export JAVA_HOME=/usr/local/jdk1.8.0_11
export CLASSPATH=.:\$JAVA_HOME/lib/dt.jar:\$JAVA_HOME/lib/tools.jar
export PATH=\$JAVA_HOME/bin:\$PATH
EOF
&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;source&lt;/span&gt; /etc/profile&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;hr /&gt;

&lt;p&gt;kafka集群依赖于zookeeper，所以我们先搭建zookeeper集群&lt;/p&gt;

&lt;h2 id=&quot;zookeeper&quot;&gt;部署zookeeper集群&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;安装zookeeper&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;wget https://mirrors.tuna.tsinghua.edu.cn/apache/zookeeper/zookeeper-3.4.6/zookeeper-3.4.6.tar.gz
tar xf zookeeper-3.4.6.tar.gz -C /usr/local/
ln -s /usr/local/zookeeper-3.4.6/ /usr/local/zookeeper
mv /usr/local/zookeeper/conf/zoo_sample.cfg /usr/local/zookeeper/conf/zoo.cfg&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;配置zookeeper&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;三台配置都如下：&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;cat /usr/local/zookeeper/conf/zoo.cfg 
&lt;span class=&quot;nv&quot;&gt;tickTime&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2000
&lt;span class=&quot;nv&quot;&gt;initLimit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;10
&lt;span class=&quot;nv&quot;&gt;syncLimit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;5
&lt;span class=&quot;nv&quot;&gt;dataDir&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/tmp/zookeeper
&lt;span class=&quot;nv&quot;&gt;clientPort&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2181
server.1&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;192.168.1.250:3181:4181
server.2&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;192.168.1.251:3181:4181
server.3&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;192.168.1.252:3181:4181&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;mkdir -p /tmp/zookeeper/
&lt;span class=&quot;nb&quot;&gt;echo &lt;/span&gt;1 &amp;gt; /tmp/zookeeper/myid		//kafka01执行
&lt;span class=&quot;nb&quot;&gt;echo &lt;/span&gt;2 &amp;gt; /tmp/zookeeper/myid		//kafka02执行
&lt;span class=&quot;nb&quot;&gt;echo &lt;/span&gt;3 &amp;gt; /tmp/zookeeper/myid		//kafka03执行&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;启动zookeeper集群&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;/usr/local/zookeeper/bin/zkServer.sh start /usr/local/zookeeper/conf/zoo.cfg&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;验证zookeeper集群状态&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;/usr/local/zookeeper/bin/zkServer.sh status /usr/local/zookeeper/conf/zoo.cfg&lt;/p&gt;
&lt;/blockquote&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;kafka&quot;&gt;部署kafka集群&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;安装kafka&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;wget http://mirrors.tuna.tsinghua.edu.cn/apache/kafka/0.10.0.1/kafka_2.11-0.10.0.1.tgz
tar xf kafka_2.11-0.10.0.1.tgz -C /usr/local/
ln -s /usr/local/kafka_2.11-0.10.0.1/ /usr/local/kafka
mkdir -p /var/log/kafka/&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;配置kafka&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;cat /usr/local/kafka/config/server.properties
broker.id&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1			//每台kafka都要设置独一无二broker ID号
&lt;span class=&quot;nv&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;9092			//监听端口号；推荐三天机器都设置成一样的
host.name&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;192.168.1.250		//每台kafka设置成自己的IP地址
advertised.host.name&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;192.168.1.250		//每台kafka设置成自己的IP地址
zookeeper.connect&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;192.168.1.250:2181,192.168.1.251:2181,192.168.1.252:2181	//zookeeper地址；三台机器都设置成一样
log.dirs&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/var/log/kafka
num.network.threads&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;3
num.io.threads&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;8
socket.send.buffer.bytes&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;102400
socket.receive.buffer.bytes&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;102400
socket.request.max.bytes&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;104857600
num.partitions&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1
num.recovery.threads.per.data.dir&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1
log.retention.hours&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;168
log.segment.bytes&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1073741824
log.retention.check.interval.ms&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;300000
zookeeper.connection.timeout.ms&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;6000
delete.topic.enable&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;启动kafka集群&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;nohup /usr/local/kafka/bin/kafka-server-start.sh /usr/local/kafka/config/server.properties &amp;amp;&amp;gt;&amp;gt;/var/log/kafka/kafka-server.log  &amp;amp;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;验证kafka集群&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;创建一个topic&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;/usr/local/kafka/bin/kafka-topics.sh -zookeeper 192.168.1.250:2181,192.168.1.251:2181,192.168.1.252:2181 -topic wangrubintest -replication-factor 2 -partitions 3 -create&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;查看topic列表&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;/usr/local/kafka/bin/kafka-topics.sh -zookeeper 192.168.1.250:2181,192.168.1.251:2181,192.168.1.252:2181 -list&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;创建测试生产者&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;/usr/local/kafka/bin/kafka-console-producer.sh -broker-list 192.168.1.250:9092,192.168.1.251:9092,192.168.1.252:9092 -topic wangrubintest&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;创建测试消费者&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;/usr/local/kafka/bin/kafka-console-consumer.sh --zookeeper 192.168.1.250:2181,192.168.1.251:2181,192.168.1.252:2181 --topic wangrubintest&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;fluentd&quot;&gt;部署Fluentd收集日志&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;编写Dockerfile文件&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;mkdir fluentd &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;fluentd
vim Dockerfile
FROM fluent/fluentd:onbuild
MAINTAINER YOUR_NAME &amp;lt;...@...&amp;gt;
USER root
RUN apk add --update --virtual .build-deps &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
        sudo build-base ruby-dev &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;

 &lt;span class=&quot;c&quot;&gt;# cutomize following instruction as you wish&lt;/span&gt;
 &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; sudo -u fluent gem install &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
        fluent-plugin-elasticsearch &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
        fluent-plugin-kafka &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;

 &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; sudo -u fluent gem sources --clear-all &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
 &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; apk del .build-deps &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
 &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; rm -rf /var/cache/apk/&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
           /home/fluent/.gem/ruby/2.3.0/cache/&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;.gem
EXPOSE 24284&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;编写fluent配置文件&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;vim fluent.conf
&amp;lt;&lt;span class=&quot;nb&quot;&gt;source&lt;/span&gt;&amp;gt;
  @type forward
  port 24224
  &lt;span class=&quot;nb&quot;&gt;bind &lt;/span&gt;0.0.0.0
&amp;lt;/source&amp;gt;

&amp;lt;match &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;.&lt;span class=&quot;k&quot;&gt;**&lt;/span&gt;&amp;gt;
  @type kafka_buffered		//该字段表示output给kafka

  &lt;span class=&quot;c&quot;&gt;# list of seed brokers&lt;/span&gt;
  brokers 192.168.1.250:9092,192.168.1.251:9092,192.168.1.252:9092		//kafka集群

  &lt;span class=&quot;c&quot;&gt;# buffer settings&lt;/span&gt;
  buffer_type file
  buffer_path /var/log/td-agent/buffer/td
  flush_interval 3s

  &lt;span class=&quot;c&quot;&gt;# topic settings&lt;/span&gt;
  default_topic wangrubintest		//kafka上的topic

  &lt;span class=&quot;c&quot;&gt;# data type settings&lt;/span&gt;
  output_data_type json
  compression_codec gzip

  &lt;span class=&quot;c&quot;&gt;# producer settings&lt;/span&gt;
  max_send_retries 1
  required_acks -1
&amp;lt;/match&amp;gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;mkdir plugins
mkdir -p /var/log/td-agent/buffer/td&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;构建Docker镜像&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;fluentd/
docker build -t 10.0.0.39:5000/fluentd:v10 .&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;启动fluent&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;docker run -d -p 24224:24224/tcp -p 24224:24224/udp --rm --name fluentd 10.0.0.39:5000/fluentd:v10&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;elasticsearch&quot;&gt;部署elasticsearch&lt;/h2&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;docker run -d --rm -p 9200:9200 --name elasticsearch hub.c.163.com/library/elasticsearch:2.4&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;logstash&quot;&gt;部署logstash&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;准备logstash.conf配置文件&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;mkdir -p /root/logstash &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; vim /root/logstash/logstash.conf
&lt;span class=&quot;c&quot;&gt;#&lt;/span&gt;

input &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;    
    kafka &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;    
        zk_connect &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&amp;gt; &lt;span class=&quot;s2&quot;&gt;&quot;192.168.1.250:2181,192.168.1.251:2181,192.168.1.252:2181&quot;&lt;/span&gt;
        group_id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&amp;gt; &lt;span class=&quot;s2&quot;&gt;&quot;es&quot;&lt;/span&gt;    
        topic_id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&amp;gt; &lt;span class=&quot;s2&quot;&gt;&quot;wangrubintest&quot;&lt;/span&gt;
        codec &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&amp;gt; plain
        reset_beginning &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&amp;gt; &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# boolean (optional)， default: false&lt;/span&gt;
        consumer_threads &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&amp;gt; 5  &lt;span class=&quot;c&quot;&gt;# number (optional)， default: 1&lt;/span&gt;
        decorate_events &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&amp;gt; &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# boolean (optional)， default: false&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

output &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
     elasticsearch &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;         
        hosts &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&amp;gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;192.168.1.251:9200&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
         index &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&amp;gt; &lt;span class=&quot;s2&quot;&gt;&quot;logstash-%{+YYYY.MM.dd}&quot;&lt;/span&gt;
        workers &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&amp;gt; 5
        flush_size &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&amp;gt; 3840
        idle_flush_time &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&amp;gt; 10
        template_overwrite &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&amp;gt; &lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    stdout&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        codec &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&amp;gt; rubydebug
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;启动logstash&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;docker run -d --rm -v /root/logstash/:/config-dir/ logstash:2.4 -f /config-dir/logstash.conf&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;kibana&quot;&gt;部署kibana&lt;/h2&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;ocker run -d --rm --name kibana -e &lt;span class=&quot;nv&quot;&gt;ELASTICSEARCH_URL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.1.251:9200 -p 5601:5601 hub.c.163.com/library/kibana:4.6&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;section-2&quot;&gt;环境检查&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;http://192.168.1.250:5601/status&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;img src=&quot;/pic/FKLEK/1.png&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;nginx&quot;&gt;部署nginx测试&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;下载镜像&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;docker pull 10.0.0.39:5000/nginx:v1.12&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;启动镜像&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;docker run -d -p 80:80 --rm --log-driver&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;fluentd --log-opt fluentd-address&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;fluentd.test.com:24224 --log-opt &lt;span class=&quot;nv&quot;&gt;tag&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;nginx_access --name nginx 10.0.0.39:5000/nginx:v1.12&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;访问nginx并去kibana观察日志&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;/pic/FKLEK/4.png&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/pic/FKLEK/2.png&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/pic/FKLEK/3.png&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Docker ==&amp;gt; Fluentd ==&amp;gt; Kafka ==&amp;gt; Logstash ==&amp;gt; ElasticSearch ==&amp;gt; Kibana 测试完毕&lt;/p&gt;

&lt;p&gt;end&lt;/p&gt;

</description>
        <pubDate>Fri, 19 May 2017 00:00:00 +0800</pubDate>
        <link>/docker/Docker-FKLEK.html</link>
        <guid isPermaLink="true">/docker/Docker-FKLEK.html</guid>
        
        
        <category>Docker</category>
        
      </item>
    
      <item>
        <title>Python抓取特定XML JSON HTML文件内容</title>
        <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#xml&quot; id=&quot;markdown-toc-xml&quot;&gt;XML文件处理&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;xml&quot;&gt;XML文件处理&lt;/h2&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;&lt;span class=&quot;c&quot;&gt;#!/usr/bin/python&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# -*- coding: UTF-8 -*-&lt;/span&gt;

from xml.parsers.expat import ParserCreate
from urllib import request

&lt;span class=&quot;c&quot;&gt;# 定义回调机制&lt;/span&gt;
class MovieHandler&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;object&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:
   def __init__&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;self&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:
      self.CurrentData &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;
      self.type &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;
      self.format &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;
      self.year &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;
      self.rating &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;
      self.stars &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;
      self.description &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;

   &lt;span class=&quot;c&quot;&gt;# 元素开始事件处理&lt;/span&gt;
   def startElement&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;self, tag, attributes&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:
      self.CurrentData &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; tag
      &lt;span class=&quot;k&quot;&gt;if &lt;/span&gt;self.CurrentData &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;movie&quot;&lt;/span&gt;:
         print&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;*****Movie*****&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
         title &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; attributes[&lt;span class=&quot;s2&quot;&gt;&quot;title&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
         print&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Title:&quot;&lt;/span&gt;, title&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;

   &lt;span class=&quot;c&quot;&gt;# 元素结束事件处理&lt;/span&gt;
   def endElement&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;self, tag&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:
      &lt;span class=&quot;k&quot;&gt;if &lt;/span&gt;self.CurrentData &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt;:
         print&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Type:&quot;&lt;/span&gt;, self.type&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;elif &lt;/span&gt;self.CurrentData &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;format&quot;&lt;/span&gt;:
         print&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Format:&quot;&lt;/span&gt;, self.format&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;elif &lt;/span&gt;self.CurrentData &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;year&quot;&lt;/span&gt;:
         print&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Year:&quot;&lt;/span&gt;, self.year&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;elif &lt;/span&gt;self.CurrentData &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;rating&quot;&lt;/span&gt;:
         print&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Rating:&quot;&lt;/span&gt;, self.rating&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;elif &lt;/span&gt;self.CurrentData &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;stars&quot;&lt;/span&gt;:
         print&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Stars:&quot;&lt;/span&gt;, self.stars&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;elif &lt;/span&gt;self.CurrentData &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;description&quot;&lt;/span&gt;:
         print&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Description:&quot;&lt;/span&gt;, self.description&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
      self.CurrentData &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;

   &lt;span class=&quot;c&quot;&gt;# 内容事件处理&lt;/span&gt;
   def characters&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;self, content&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:
      &lt;span class=&quot;k&quot;&gt;if &lt;/span&gt;self.CurrentData &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt;:
         self.type &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; content
      &lt;span class=&quot;k&quot;&gt;elif &lt;/span&gt;self.CurrentData &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;format&quot;&lt;/span&gt;:
         self.format &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; content
      &lt;span class=&quot;k&quot;&gt;elif &lt;/span&gt;self.CurrentData &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;year&quot;&lt;/span&gt;:
         self.year &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; content
      &lt;span class=&quot;k&quot;&gt;elif &lt;/span&gt;self.CurrentData &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;rating&quot;&lt;/span&gt;:
         self.rating &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; content
      &lt;span class=&quot;k&quot;&gt;elif &lt;/span&gt;self.CurrentData &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;stars&quot;&lt;/span&gt;:
         self.stars &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; content
      &lt;span class=&quot;k&quot;&gt;elif &lt;/span&gt;self.CurrentData &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;description&quot;&lt;/span&gt;:
         self.description &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; content

&lt;span class=&quot;c&quot;&gt;# 获取XML文件&lt;/span&gt;
with request.urlopen&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;http://wangrubin.com/testfile/movies.xml&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; as f:
        xml &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; f.read&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;

handler &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; MovieHandler&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;
parser &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ParserCreate&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# 重写原有的StartElementHandler EndElementHandler CharacterDataHandler&lt;/span&gt;
parser.StartElementHandler &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; handler.startElement
parser.EndElementHandler &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; handler.endElement
parser.CharacterDataHandler &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; handler.characters

parser.Parse&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;xml&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

</description>
        <pubDate>Tue, 25 Apr 2017 00:00:00 +0800</pubDate>
        <link>/python/python-web.html</link>
        <guid isPermaLink="true">/python/python-web.html</guid>
        
        
        <category>Python</category>
        
      </item>
    
  </channel>
</rss>
