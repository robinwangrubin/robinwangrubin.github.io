<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Robin's Personal Website</title>
    <description></description>
    <link>/</link>
    <atom:link href="/feed.xml" rel="self" type="application/rss+xml"/>
    <pubDate>Fri, 16 Jun 2017 16:45:33 +0800</pubDate>
    <lastBuildDate>Fri, 16 Jun 2017 16:45:33 +0800</lastBuildDate>
    <generator>Jekyll v3.3.0</generator>
    
      <item>
        <title>带宽测试工具--iperf</title>
        <description>&lt;h2 id=&quot;iperf&quot;&gt;安装iperf&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;Tar包安装&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;wget http://downloads.es.net/pub/iperf/iperf-3.0.6.tar.gz
tar xf iperf-3.0.6.tar.gz 
&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;iperf-3.0.6
./configure 
make
make install&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;Docker容器形式安装&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;docker pull moutten/iperf:3.1&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;section&quot;&gt;测试网络带宽&lt;/h2&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;iperf3 -u -c 192.168.1.251 -p 5201 -b 1000M -t 60&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;docker run -it -p 5201:5201/tcp -p 5201:5201/udp moutten/iperf:3.1&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;docker service create &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  --name iperf &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  --constraint &lt;span class=&quot;s1&quot;&gt;'node.hostname==kafka02'&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  --publish 5201:5201/tcp &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  --publish 5201:5201/udp &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  moutten/iperf:3.1&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;hr /&gt;

&lt;p&gt;end&lt;/p&gt;

</description>
        <pubDate>Fri, 16 Jun 2017 00:00:00 +0800</pubDate>
        <link>/network/iperf.html</link>
        <guid isPermaLink="true">/network/iperf.html</guid>
        
        
        <category>Network</category>
        
      </item>
    
      <item>
        <title>KVM学习笔记</title>
        <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#section&quot; id=&quot;markdown-toc-section&quot;&gt;实验环境准备&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-1&quot; id=&quot;markdown-toc-section-1&quot;&gt;系统优化&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#kvm&quot; id=&quot;markdown-toc-kvm&quot;&gt;kvm环境验证&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#kvm-1&quot; id=&quot;markdown-toc-kvm-1&quot;&gt;安装kvm&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#section-2&quot; id=&quot;markdown-toc-section-2&quot;&gt;准备系统镜像&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#kvm-2&quot; id=&quot;markdown-toc-kvm-2&quot;&gt;启动kvm服务&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#kvm-3&quot; id=&quot;markdown-toc-kvm-3&quot;&gt;KVM网络模式&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#bridge&quot; id=&quot;markdown-toc-bridge&quot;&gt;Bridge模式&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#nat&quot; id=&quot;markdown-toc-nat&quot;&gt;NAT模式&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#kvm-4&quot; id=&quot;markdown-toc-kvm-4&quot;&gt;kvm创建磁盘文件&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#kvm-5&quot; id=&quot;markdown-toc-kvm-5&quot;&gt;kvm创建虚拟机&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#virsh&quot; id=&quot;markdown-toc-virsh&quot;&gt;virsh基础命令&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#vnc&quot; id=&quot;markdown-toc-vnc&quot;&gt;VNC远程连接虚拟机&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#windows&quot; id=&quot;markdown-toc-windows&quot;&gt;windows客户端安装&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#vm&quot; id=&quot;markdown-toc-vm&quot;&gt;vm虚拟机系统优化&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#vmnginx&quot; id=&quot;markdown-toc-vmnginx&quot;&gt;vm安装nginx&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#clone&quot; id=&quot;markdown-toc-clone&quot;&gt;虚拟机clone&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#virshclone&quot; id=&quot;markdown-toc-virshclone&quot;&gt;virsh直接clone&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#section-3&quot; id=&quot;markdown-toc-section-3&quot;&gt;配置文件+磁盘文件&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-4&quot; id=&quot;markdown-toc-section-4&quot;&gt;时区问题&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-5&quot; id=&quot;markdown-toc-section-5&quot;&gt;快照&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-6&quot; id=&quot;markdown-toc-section-6&quot;&gt;测试&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;section&quot;&gt;实验环境准备&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;系统版本：CentOS-7.2&lt;/li&gt;
  &lt;li&gt;系统内核：3.10.0-327.el7.x86_64&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;section-1&quot;&gt;系统优化&lt;/h2&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;sed -i &lt;span class=&quot;s1&quot;&gt;'s/SELINUX=.*/SELINUX=disabled/g'&lt;/span&gt; /etc/selinux/config
setenforce 0
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; -e  &lt;span class=&quot;s2&quot;&gt;&quot;* soft nofile 102400&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;* hard nofile 102400&quot;&lt;/span&gt; &amp;gt;&amp;gt; /etc/security/limits.conf
systemctl stop firewalld.service
systemctl disable firewalld.service
systemctl stop NetworkManager.service
systemctl disable NetworkManager.service
sed -i &lt;span class=&quot;s1&quot;&gt;'s/DNS1=.*/DNS1=114.114.114.114/g'&lt;/span&gt; /etc/selinux/config
systemctl restart network
yum install wget -y
mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup
wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
yum makecache
yum install vim lrzsz net-tools.x86_64 -y&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;kvm&quot;&gt;kvm环境验证&lt;/h2&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# lsmod |grep kvm
kvm_intel             162153  3 
kvm                   525259  1 kvm_intel&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# grep -E &lt;span class=&quot;s2&quot;&gt;&quot;svm|vmx&quot;&lt;/span&gt; /proc/cpuinfo
flags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon pebs bts rep_good nopl xtopology nonstop_tsc aperfmperf pni pclmulqdq dtes64 monitor ds_cpl vmx smx est tm2 ssse3 cx16 xtpr pdcm pcid dca sse4_1 sse4_2 popcnt aes lahf_lm ida arat dtherm tpr_shadow vnmi flexpriority ept vpid
......&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;&lt;img src=&quot;/pic/kvm/2.png&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;kvm-1&quot;&gt;安装kvm&lt;/h2&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;yum -y install qemu-kvm qemu-kvm-tools  libvirt virt-install libvirt-python acpid&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h3 id=&quot;section-2&quot;&gt;准备系统镜像&lt;/h3&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;mkdir -p /home/iso
&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; /home/iso/
wget https://mirrors.tuna.tsinghua.edu.cn/centos/7.3.1611/isos/x86_64/CentOS-7-x86_64-Minimal-1611.iso&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h2 id=&quot;kvm-2&quot;&gt;启动kvm服务&lt;/h2&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;systemctl start acpid.service
systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;acpid.service
systemctl start libvirtd.service
systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;libvirtd.service&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;kvm-3&quot;&gt;KVM网络模式&lt;/h2&gt;

&lt;h3 id=&quot;bridge&quot;&gt;Bridge模式&lt;/h3&gt;

&lt;p&gt;在bridged模式下，虚拟出来的操作系统就像是局域网中的一台独立的主机;&lt;/p&gt;

&lt;p&gt;它可以访问网内任何一台机器。同时，由于这个虚拟系统是局域网中的一个独立的主机系统，那么就可以手工配置它的TCP/IP配置信息，以实现通过局域网的网关或路由器访问互联网;&lt;/p&gt;

&lt;p&gt;使用bridged模式的虚拟系统和宿主机器的关系，就像连接在同一个Hub上的两台电脑。想让它们相互通讯，你就需要为虚拟系统配置IP地址和子网掩码，否则就无法通信;&lt;/p&gt;

&lt;p&gt;这种方式最简单，直接将虚拟网卡桥接到一个物理网卡上面，和linux下一个网卡绑定两个不同地址类似，实际上是将网卡设置为混杂模式，从而达到侦听多个IP的能力;&lt;/p&gt;

&lt;p&gt;在此种模式下，虚拟机内部的网卡（例如linux下的eth0)直接连到了物理网卡所在的网络上，可以想象为虚拟机和host机处于对等的地位，在网络关系上是平等的，没有谁在谁后面的问题。使用这种方式很简单，前提是你可以得到1个以上的IP地址。&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt;  /etc/sysconfig/network-scripts/
cp ifcfg-em1 ifcfg-br0&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# cat /etc/sysconfig/network-scripts/ifcfg-em1
&lt;span class=&quot;nv&quot;&gt;TYPE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;Ethernet
&lt;span class=&quot;nv&quot;&gt;BOOTPROTO&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;static
&lt;span class=&quot;nv&quot;&gt;NAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;em1
&lt;span class=&quot;nv&quot;&gt;DEVICE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;em1
&lt;span class=&quot;nv&quot;&gt;ONBOOT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;yes
&lt;span class=&quot;nv&quot;&gt;IPADDR&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;123.126.176.207
&lt;span class=&quot;nv&quot;&gt;NETMASK&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;255.255.255.0
&lt;span class=&quot;nv&quot;&gt;GATEWAY&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;123.126.176.165
&lt;span class=&quot;nv&quot;&gt;DNS1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;114.114.114.114
&lt;span class=&quot;nv&quot;&gt;BRIDGE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;br0&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# cat /etc/sysconfig/network-scripts/ifcfg-br0 
&lt;span class=&quot;nv&quot;&gt;TYPE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;Bridge
&lt;span class=&quot;nv&quot;&gt;BOOTPROTO&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;static
&lt;span class=&quot;nv&quot;&gt;NAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;em1
&lt;span class=&quot;nv&quot;&gt;DEVICE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;br0
&lt;span class=&quot;nv&quot;&gt;ONBOOT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;yes
&lt;span class=&quot;nv&quot;&gt;IPADDR&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;123.126.176.207
&lt;span class=&quot;nv&quot;&gt;NETMASK&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;255.255.255.0
&lt;span class=&quot;nv&quot;&gt;GATEWAY&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;123.126.176.165
&lt;span class=&quot;nv&quot;&gt;DNS1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;114.114.114.114&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;systemctl restart network&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# brctl show
bridge name     bridge id               STP enabled     interfaces
br0             8000.842b2b6dd23c       no              em1
virbr0          8000.52540028ef19       yes             virbr0-nic&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h3 id=&quot;nat&quot;&gt;NAT模式&lt;/h3&gt;

&lt;p&gt;使用NAT模式，就是让虚拟系统借助NAT(网络地址转换)功能，通过宿主机器所在的网络来访问公网；&lt;/p&gt;

&lt;p&gt;也就是说，使用NAT模式可以实现在虚拟系统里访问互联网。很显然，如果你只有一个外网地址，此种方式很合适。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;virsh net-undefine default&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;    &amp;lt;network&amp;gt;  
      &amp;lt;name&amp;gt;default&amp;lt;/name&amp;gt;  
      &amp;lt;uuid&amp;gt;dc69ff61-6445-4376-b940-8714a3922bf7&amp;lt;/uuid&amp;gt;  
      &amp;lt;forward &lt;span class=&quot;nv&quot;&gt;mode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'nat'&lt;/span&gt;/&amp;gt;  
      &amp;lt;bridge &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'virbr0'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;stp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'on'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;delay&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'0'&lt;/span&gt; /&amp;gt;  
      &amp;lt;mac &lt;span class=&quot;nv&quot;&gt;address&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'52:54:00:81:14:18'&lt;/span&gt;/&amp;gt;  
      &amp;lt;ip &lt;span class=&quot;nv&quot;&gt;address&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'192.168.122.1'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;netmask&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'255.255.255.0'&lt;/span&gt;&amp;gt;  
        &amp;lt;dhcp&amp;gt;  
          &amp;lt;range &lt;span class=&quot;nv&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'192.168.122.2'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'192.168.122.254'&lt;/span&gt; /&amp;gt;  
          &amp;lt;host &lt;span class=&quot;nv&quot;&gt;mac&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'00:25:90:eb:4b:bb'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'guest1'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;ip&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'192.168.5.13'&lt;/span&gt; /&amp;gt;  
          &amp;lt;host &lt;span class=&quot;nv&quot;&gt;mac&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'00:25:90:eb:34:2c'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'guest2'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;ip&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'192.168.7.206'&lt;/span&gt; /&amp;gt;  
          &amp;lt;host &lt;span class=&quot;nv&quot;&gt;mac&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'00:25:90:eb:e5:de'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'guest3'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;ip&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'192.168.7.207'&lt;/span&gt; /&amp;gt;  
          &amp;lt;host &lt;span class=&quot;nv&quot;&gt;mac&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'00:25:90:eb:7e:11'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'guest4'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;ip&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'192.168.7.208'&lt;/span&gt; /&amp;gt;  
          &amp;lt;host &lt;span class=&quot;nv&quot;&gt;mac&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'00:25:90:eb:b2:11'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'guest5'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;ip&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'192.168.7.209'&lt;/span&gt; /&amp;gt;  
        &amp;lt;/dhcp&amp;gt;  
      &amp;lt;/ip&amp;gt;  
    &amp;lt;/network&amp;gt;  &lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;kvm-4&quot;&gt;kvm创建磁盘文件&lt;/h2&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;mkdir /home/kvm_images
qemu-img create -f raw /home/kvm_images/centos7-1.raw 20G
qemu-img create -f raw /home/kvm_images/windows2008-1.raw 100G&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;blockquote&gt;
  &lt;p&gt;qemu-img info /home/kvm_images/windows2008-1.raw&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;kvm-5&quot;&gt;kvm创建虚拟机&lt;/h2&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;virt-install --virt-type&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;kvm --name&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;centos7-1 --memory&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2048 --cdrom&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/home/iso/CentOS-7-x86_64-Minimal-1611.iso --disk &lt;span class=&quot;nv&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/home/kvm_images/centos7-1.img --network &lt;span class=&quot;nv&quot;&gt;network&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;default --vnc --vncport&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;12345 --vnclisten&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0.0.0.0 --noautoconsole --os-type&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;linux --os-variant&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;rhel6&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;virt-install --virt-type&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;kvm --name&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;windows-2008-1 --memory&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;4096 --cdrom&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/home/iso/Windows_Server_2008_R2.iso --disk &lt;span class=&quot;nv&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/home/kvm_images/windows2008-1.raw --network &lt;span class=&quot;nv&quot;&gt;network&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;default --vnc --vncport&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;10000 --vnclisten&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0.0.0.0 --noautoconsole --os-type&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;windows --os-variant&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;win2k8&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;–name指定虚拟机名称&lt;/li&gt;
  &lt;li&gt;–memory分配内存大小。&lt;/li&gt;
  &lt;li&gt;–vcpus分配CPU核心数，最大与实体机CPU核心数相同&lt;/li&gt;
  &lt;li&gt;–disk指定虚拟机镜像，size指定分配大小单位为G。&lt;/li&gt;
  &lt;li&gt;–network网络类型，此处用的是默认，一般用的应该是bridge桥接。&lt;/li&gt;
  &lt;li&gt;–accelerate加速&lt;/li&gt;
  &lt;li&gt;–cdrom指定安装镜像iso&lt;/li&gt;
  &lt;li&gt;–vnc启用VNC远程管理，一般安装系统都要启用。&lt;/li&gt;
  &lt;li&gt;–vncport指定VNC监控端口，默认端口为5900，端口不能重复。&lt;/li&gt;
  &lt;li&gt;–vnclisten指定VNC绑定IP，默认绑定127.0.0.1，这里改为0.0.0.0。&lt;/li&gt;
  &lt;li&gt;–os-type=linux,windows&lt;/li&gt;
  &lt;li&gt;–os-variant=rhel6&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;virsh&quot;&gt;virsh基础命令&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;virt-install 生成kvm虚拟机&lt;/li&gt;
  &lt;li&gt;virsh list 查看在运行的虚拟机&lt;/li&gt;
  &lt;li&gt;virsh list –all 查看所有虚拟机&lt;/li&gt;
  &lt;li&gt;virsh dumpxml vm-name 查看kvm虚拟机配置文件&lt;/li&gt;
  &lt;li&gt;virsh start vm-name 启动kvm虚拟机&lt;/li&gt;
  &lt;li&gt;virsh shutdown vm-name 正常关机&lt;/li&gt;
  &lt;li&gt;virsh destroy vm-name 非正常关机（相当于物理机直接拔掉电源）&lt;/li&gt;
  &lt;li&gt;virsh undefine vm-name 删除vm的配置文件&lt;/li&gt;
  &lt;li&gt;virsh define file-name.xml 根据配置文件定义虚拟机&lt;/li&gt;
  &lt;li&gt;virsh suspend vm-name 挂起，终止&lt;/li&gt;
  &lt;li&gt;virsh resumed vm-name 恢复挂起状态&lt;/li&gt;
  &lt;li&gt;virsh autostart vm-name 开机自启动vm&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;vnc&quot;&gt;VNC远程连接虚拟机&lt;/h2&gt;

&lt;h3 id=&quot;windows&quot;&gt;windows客户端安装&lt;/h3&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;https://www.realvnc.com/download/file/vnc.files/VNC-6.1.1-Windows.exe&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;通过vnc连接 IP+port（12345）进行安装系统：&lt;/p&gt;

&lt;h3 id=&quot;vm&quot;&gt;vm虚拟机系统优化&lt;/h3&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;sed -i &lt;span class=&quot;s1&quot;&gt;'s/SELINUX=.*/SELINUX=disabled/g'&lt;/span&gt; /etc/selinux/config
setenforce 0
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; -e  &lt;span class=&quot;s2&quot;&gt;&quot;* soft nofile 102400&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;* hard nofile 102400&quot;&lt;/span&gt; &amp;gt;&amp;gt; /etc/security/limits.conf
systemctl stop firewalld.service
systemctl disable firewalld.service
systemctl stop NetworkManager.service
systemctl disable NetworkManager.service
sed -i &lt;span class=&quot;s1&quot;&gt;'s/DNS1=.*/DNS1=114.114.114.114/g'&lt;/span&gt; /etc/selinux/config
systemctl restart network
yum install wget -y
mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup
wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
yum makecache
yum install vim lrzsz net-tools.x86_64 -y&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h3 id=&quot;vmnginx&quot;&gt;vm安装nginx&lt;/h3&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;wget http://nginx.org/download/nginx-1.12.0.tar.gz
yum install gcc -y
yum install openssl-devel pcre-devel -y
tar xf nginx-1.12.0.tar.gz
&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;nginx-1.12.0
./configure --prefix&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/local/nginx-1.12.0 --user&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;nginx --group&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;nginx --with-http_ssl_module --with-http_stub_status_module
make &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; make install
ln -s /usr/local/nginx-1.12.0/ /etc/nginx
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&amp;lt;h1&amp;gt;This is work-node01 &amp;lt;/h1&amp;gt;&quot;&lt;/span&gt; &amp;gt; /usr/local/nginx-1.12.0/html/index.html 
/usr/local/nginx-1.12.0/sbin/nginx&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;clone&quot;&gt;虚拟机clone&lt;/h2&gt;

&lt;h3 id=&quot;virshclone&quot;&gt;virsh直接clone&lt;/h3&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;virsh shutdown centos7-1
virt-clone -o centos7-1 -n centos7-2 -f /home/kvm_images/centos7-2.raw
virsh edit centos7-2
修改VNC端口&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;/usr/local/nginx-1.12.0/sbin/nginx
hostnamectl &lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt;-hostname worker-node02
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&amp;lt;h1&amp;gt;This is work-node02 &amp;lt;/h1&amp;gt;&quot;&lt;/span&gt; &amp;gt; /usr/local/nginx-1.12.0/html/index.html 
/usr/local/nginx-1.12.0/sbin/nginx&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h3 id=&quot;section-3&quot;&gt;配置文件+磁盘文件&lt;/h3&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;virsh shutdown centos7-1
virsh dumpxml centos7-1 &amp;gt; /etc/libvirt/qemu/centos7-3.xml
cp /home/kvm_images/centos7-1.img /home/kvm_images/centos7-3.img
vim /etc/libvirt/qemu/centos7-3.xml&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;diff /etc/libvirt/qemu/centos7-1.xml /etc/libvirt/qemu/centos7-3.xml&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;&amp;lt;   &amp;lt;name&amp;gt;centos7-1&amp;lt;/name&amp;gt;
&amp;lt;   &amp;lt;uuid&amp;gt;51e8a434-3aca-4664-a4df-25c42226a9ed&amp;lt;/uuid&amp;gt;
---
&lt;span class=&quot;gp&quot;&gt;&amp;gt;   &lt;/span&gt;&amp;lt;name&amp;gt;centos7-3&amp;lt;/name&amp;gt;
&lt;span class=&quot;gp&quot;&gt;&amp;gt;   &lt;/span&gt;&amp;lt;uuid&amp;gt;51e8a434-3aca-4664-a4df-25c42226a900&amp;lt;/uuid&amp;gt;
25c25
&amp;lt;       &amp;lt;&lt;span class=&quot;nb&quot;&gt;source &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'/home/kvm_images/centos7-1.img'&lt;/span&gt;/&amp;gt;
---
&lt;span class=&quot;gp&quot;&gt;&amp;gt;       &lt;/span&gt;&amp;lt;&lt;span class=&quot;nb&quot;&gt;source &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'/home/kvm_images/centos7-3.img'&lt;/span&gt;/&amp;gt;
74c74
&amp;lt;       &amp;lt;mac &lt;span class=&quot;nv&quot;&gt;address&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'52:54:00:2e:ef:7f'&lt;/span&gt;/&amp;gt;
---
&lt;span class=&quot;gp&quot;&gt;&amp;gt;       &lt;/span&gt;&amp;lt;mac &lt;span class=&quot;nv&quot;&gt;address&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'52:54:00:2e:ef:7a'&lt;/span&gt;/&amp;gt;
94c94
&amp;lt;     &amp;lt;graphics &lt;span class=&quot;nb&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'vnc'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'12345'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;autoport&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'no'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;listen&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'0.0.0.0'&lt;/span&gt;&amp;gt;
---
&lt;span class=&quot;gp&quot;&gt;&amp;gt;     &lt;/span&gt;&amp;lt;graphics &lt;span class=&quot;nb&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'vnc'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'12347'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;autoport&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'no'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;listen&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'0.0.0.0'&lt;/span&gt;&amp;gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;virsh define /etc/libvirt/qemu/centos7-3.xml
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost qemu]# virsh list --all
 Id    Name                           State
----------------------------------------------------
 12    centos7-2                      running
 -     centos7-1                      shut off
 -     centos7-3                      shut off
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost qemu]# virsh start centos7-3
Domain centos7-3 started&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;vnc 连接虚拟机 更改IP地址&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;/usr/local/nginx-1.12.0/sbin/nginx
hostnamectl &lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt;-hostname worker-node03
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&amp;lt;h1&amp;gt;This is work-node03 &amp;lt;/h1&amp;gt;&quot;&lt;/span&gt; &amp;gt; /usr/local/nginx-1.12.0/html/index.html
/usr/local/nginx-1.12.0/sbin/nginx&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h2 id=&quot;section-4&quot;&gt;时区问题&lt;/h2&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;TZ='Asia/Shanghai'; export TZ&quot;&lt;/span&gt; &amp;gt;&amp;gt; /etc/profile&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h2 id=&quot;section-5&quot;&gt;快照&lt;/h2&gt;

&lt;p&gt;kvm虚拟机默认使用raw格式的镜像格式，性能最好，速度最快;&lt;/p&gt;

&lt;p&gt;它的缺点就是不支持一些新的功能，如支持镜像,zlib磁盘压缩,AES加密等。&lt;/p&gt;

&lt;p&gt;要使用镜像功能，磁盘格式必须为qcow2。下面开始kvm虚拟机快照备份的过程。&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# qemu-img info /home/kvm_images/centos7-3.img 
image: /home/kvm_images/centos7-3.img
file format: raw
virtual size: 20G &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;21474836480 bytes&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
disk size: 2.1G

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# virsh shutdown centos7-3
Domain centos7-3 is being shutdown
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# qemu-img convert -f raw -O qcow2 /home/kvm_images/centos7-3.img /home/kvm_images/centos7-3.qcow2

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# qemu-img info /home/kvm_images/centos7-3.qcow2 
image: /home/kvm_images/centos7-3.qcow2
file format: qcow2
virtual size: 20G &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;21474836480 bytes&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
disk size: 2.0G
cluster_size: 65536
Format specific information:
    compat: 1.1
    lazy refcounts: &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;
	
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# virsh snapshot-create centos7-3 
Domain snapshot 1497367511 created

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# virsh snapshot-list centos7-3
 Name                 Creation Time             State
------------------------------------------------------------
 1497367511           2017-06-13 23:25:11 +0800 shutoff
 
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# virsh snapshot-current centos7-3|head
&amp;lt;domainsnapshot&amp;gt;
  &amp;lt;name&amp;gt;1497367511&amp;lt;/name&amp;gt;
  &amp;lt;state&amp;gt;shutoff&amp;lt;/state&amp;gt;
  &amp;lt;creationTime&amp;gt;1497367511&amp;lt;/creationTime&amp;gt;
  &amp;lt;memory &lt;span class=&quot;nv&quot;&gt;snapshot&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'no'&lt;/span&gt;/&amp;gt;
  &amp;lt;disks&amp;gt;
    &amp;lt;disk &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'vda'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;snapshot&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'internal'&lt;/span&gt;/&amp;gt;
    &amp;lt;disk &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'hda'&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;snapshot&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'no'&lt;/span&gt;/&amp;gt;
  &amp;lt;/disks&amp;gt;
  &amp;lt;domain &lt;span class=&quot;nb&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'kvm'&lt;/span&gt;&amp;gt;
  
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# virsh snapshot-create centos7-3 
Domain snapshot 1497367618 created

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# ll /var/lib/libvirt/qemu/snapshot/centos7-3/
total 16
-rw------- 1 root root 4310 Jun 13 23:26 1497367511.xml
-rw------- 1 root root 4361 Jun 13 23:26 1497367618.xml

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# virsh snapshot-delete centos7-3 1497367618
Domain snapshot 1497367618 deleted&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;&lt;img src=&quot;/pic/kvm/10.png&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/pic/kvm/11.png&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/pic/kvm/12.png&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/pic/kvm/13.png&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;section-6&quot;&gt;测试&lt;/h2&gt;

&lt;p&gt;&lt;img src=&quot;/pic/kvm/9.png&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

</description>
        <pubDate>Wed, 14 Jun 2017 00:00:00 +0800</pubDate>
        <link>/kvm/KVM.html</link>
        <guid isPermaLink="true">/kvm/KVM.html</guid>
        
        
        <category>Kvm</category>
        
      </item>
    
      <item>
        <title>Docker -- 日志系统FKLEK</title>
        <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#fklek&quot; id=&quot;markdown-toc-fklek&quot;&gt;FKLEK系统介绍&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section&quot; id=&quot;markdown-toc-section&quot;&gt;实验环境准备&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-1&quot; id=&quot;markdown-toc-section-1&quot;&gt;系统环境准备&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#zookeeper&quot; id=&quot;markdown-toc-zookeeper&quot;&gt;部署zookeeper集群&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#kafka&quot; id=&quot;markdown-toc-kafka&quot;&gt;部署kafka集群&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#fluentd&quot; id=&quot;markdown-toc-fluentd&quot;&gt;部署Fluentd收集日志&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#elasticsearch&quot; id=&quot;markdown-toc-elasticsearch&quot;&gt;部署elasticsearch&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#logstash&quot; id=&quot;markdown-toc-logstash&quot;&gt;部署logstash&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#kibana&quot; id=&quot;markdown-toc-kibana&quot;&gt;部署kibana&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-2&quot; id=&quot;markdown-toc-section-2&quot;&gt;环境检查&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#nginx&quot; id=&quot;markdown-toc-nginx&quot;&gt;部署nginx测试&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;fklek&quot;&gt;FKLEK系统介绍&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;Fluentd: 专业的集中化容器日志收集工具&lt;/li&gt;
  &lt;li&gt;Kafka：高吞吐异步消息队列&lt;/li&gt;
  &lt;li&gt;Logstash：接收，发送，过滤，分隔日志&lt;/li&gt;
  &lt;li&gt;ElasticSearch：存储和索引日志&lt;/li&gt;
  &lt;li&gt;Kibana：用来索引，展示，分析日志的UI&lt;/li&gt;
&lt;/ul&gt;

&lt;ol&gt;
  &lt;li&gt;Fluentd将所有容器的日志并转发到kafka上。&lt;/li&gt;
  &lt;li&gt;Kafka临时存储所有容器的日志；用于被Logstash消费&lt;/li&gt;
  &lt;li&gt;Logstash消费kafka的日志，最终转存到ElasticSearch上。&lt;/li&gt;
  &lt;li&gt;ElasticSearch永久存储日志的数据库&lt;/li&gt;
  &lt;li&gt;Kibana从ElasticSearch中抽取数据页面展示&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Docker ==&amp;gt; Fluentd ==&amp;gt; Kafka ==&amp;gt; Logstash ==&amp;gt; ElasticSearch ==&amp;gt; Kibana&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;section&quot;&gt;实验环境准备&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;系统要求：CentOS-7.2&lt;/li&gt;
  &lt;li&gt;内核要求：3.10.0-327.el7.x86_64&lt;/li&gt;
  &lt;li&gt;Docker版本：17.03.1-ce&lt;/li&gt;
  &lt;li&gt;JAVA环境：JDK_1.8&lt;/li&gt;
  &lt;li&gt;Zookeeper版本：zookeeper-3.4.6&lt;/li&gt;
  &lt;li&gt;kafka版本： 2.11-0.10.0.1&lt;/li&gt;
  &lt;li&gt;elasticsearch版本：2.4&lt;/li&gt;
  &lt;li&gt;logstash版本：2.4&lt;/li&gt;
  &lt;li&gt;kibana版本：4.6&lt;/li&gt;
  &lt;li&gt;fluentd版本：任意&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;IP地址和应用安装对应表&lt;/p&gt;

&lt;p&gt;192.168.1.250 ===== kafka01 Fluentd(Container) Kibana(Container)&lt;/p&gt;

&lt;p&gt;192.168.1.251 ===== kafka02 Fluentd(Container) ElasticSearch(Container)&lt;/p&gt;

&lt;p&gt;192.168.1.252 ===== kafka03 Fluentd(Container) Logstash(Container)&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;section-1&quot;&gt;系统环境准备&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;主机名解析&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;所有节点：&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
192.168.1.250   kafka01
192.168.1.251   kafka02
192.168.1.252   kafka03
192.168.1.250 192.168.1.251 192.168.1.252 fluentd.test.com	&lt;span class=&quot;c&quot;&gt;#利用DNS轮询伪造fluentd集群&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;JAVA_1.8环境部署&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;tar xf jdk-8u11-linux-x64.tar.gz -C /usr/local/
cat &amp;gt;&amp;gt; /etc/profile &lt;span class=&quot;sh&quot;&gt;&amp;lt;&amp;lt;EOF
export JAVA_HOME=/usr/local/jdk1.8.0_11
export CLASSPATH=.:\$JAVA_HOME/lib/dt.jar:\$JAVA_HOME/lib/tools.jar
export PATH=\$JAVA_HOME/bin:\$PATH
EOF
&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;source&lt;/span&gt; /etc/profile&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;hr /&gt;

&lt;p&gt;kafka集群依赖于zookeeper，所以我们先搭建zookeeper集群&lt;/p&gt;

&lt;h2 id=&quot;zookeeper&quot;&gt;部署zookeeper集群&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;安装zookeeper&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;wget http://apache.fayea.com/zookeeper/zookeeper-3.4.6/zookeeper-3.4.6.tar.gz
tar xf zookeeper-3.4.6.tar.gz -C /usr/local/
ln -s /usr/local/zookeeper-3.4.6/ /usr/local/zookeeper
mv /usr/local/zookeeper/conf/zoo_sample.cfg /usr/local/zookeeper/conf/zoo.cfg&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;配置zookeeper&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;三台配置都如下：&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;cat /usr/local/zookeeper/conf/zoo.cfg 
&lt;span class=&quot;nv&quot;&gt;tickTime&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2000
&lt;span class=&quot;nv&quot;&gt;initLimit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;10
&lt;span class=&quot;nv&quot;&gt;syncLimit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;5
&lt;span class=&quot;nv&quot;&gt;dataDir&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/tmp/zookeeper
&lt;span class=&quot;nv&quot;&gt;clientPort&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2181
server.1&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;192.168.1.250:3181:4181
server.2&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;192.168.1.251:3181:4181
server.3&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;192.168.1.252:3181:4181&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;mkdir -p /tmp/zookeeper/
&lt;span class=&quot;nb&quot;&gt;echo &lt;/span&gt;1 &amp;gt; /tmp/zookeeper/myid		//kafka01执行
&lt;span class=&quot;nb&quot;&gt;echo &lt;/span&gt;2 &amp;gt; /tmp/zookeeper/myid		//kafka02执行
&lt;span class=&quot;nb&quot;&gt;echo &lt;/span&gt;3 &amp;gt; /tmp/zookeeper/myid		//kafka03执行&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;启动zookeeper集群&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;/usr/local/zookeeper/bin/zkServer.sh start /usr/local/zookeeper/conf/zoo.cfg&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;验证zookeeper集群状态&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;/usr/local/zookeeper/bin/zkServer.sh status /usr/local/zookeeper/conf/zoo.cfg&lt;/p&gt;
&lt;/blockquote&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;kafka&quot;&gt;部署kafka集群&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;安装kafka&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;wget http://mirrors.tuna.tsinghua.edu.cn/apache/kafka/0.10.0.1/kafka_2.11-0.10.0.1.tgz
tar xf kafka_2.11-0.10.0.1.tgz -C /usr/local/
ln -s /usr/local/kafka_2.11-0.10.0.1/ /usr/local/kafka
mkdir -p /var/log/kafka/&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;配置kafka&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;cat /usr/local/kafka/config/server.properties
broker.id&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1			//每台kafka都要设置独一无二broker ID号
&lt;span class=&quot;nv&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;9092			//监听端口号；推荐三天机器都设置成一样的
host.name&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;192.168.1.250		//每台kafka设置成自己的IP地址
advertised.host.name&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;192.168.1.250		//每台kafka设置成自己的IP地址
zookeeper.connect&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;192.168.1.250:2181,192.168.1.251:2181,192.168.1.252:2181	//zookeeper地址；三台机器都设置成一样
log.dirs&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/var/log/kafka
num.network.threads&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;3
num.io.threads&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;8
socket.send.buffer.bytes&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;102400
socket.receive.buffer.bytes&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;102400
socket.request.max.bytes&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;104857600
num.partitions&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1
num.recovery.threads.per.data.dir&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1
log.retention.hours&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;168
log.segment.bytes&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1073741824
log.retention.check.interval.ms&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;300000
zookeeper.connection.timeout.ms&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;6000
delete.topic.enable&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;启动kafka集群&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;nohup /usr/local/kafka/bin/kafka-server-start.sh /usr/local/kafka/config/server.properties &amp;amp;&amp;gt;&amp;gt;/var/log/kafka/kafka-server.log  &amp;amp;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;验证kafka集群&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;创建一个topic&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;/usr/local/kafka/bin/kafka-topics.sh -zookeeper 192.168.1.250:2181,192.168.1.251:2181,192.168.1.252:2181 -topic wangrubintest -replication-factor 2 -partitions 3 -create&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;查看topic列表&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;/usr/local/kafka/bin/kafka-topics.sh -zookeeper 192.168.1.250:2181,192.168.1.251:2181,192.168.1.252:2181 -list&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;创建测试生产者&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;/usr/local/kafka/bin/kafka-console-producer.sh -broker-list 192.168.1.250:9092,192.168.1.251:9092,192.168.1.252:9092 -topic wangrubintest&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;创建测试消费者&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;/usr/local/kafka/bin/kafka-console-consumer.sh --zookeeper 192.168.1.250:2181,192.168.1.251:2181,192.168.1.252:2181 --topic wangrubintest&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;fluentd&quot;&gt;部署Fluentd收集日志&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;编写Dockerfile文件&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;mkdir fluentd &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;fluentd
vim Dockerfile
FROM fluent/fluentd:onbuild
MAINTAINER YOUR_NAME &amp;lt;...@...&amp;gt;
USER root
RUN apk add --update --virtual .build-deps &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
        sudo build-base ruby-dev &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;

 &lt;span class=&quot;c&quot;&gt;# cutomize following instruction as you wish&lt;/span&gt;
 &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; sudo -u fluent gem install &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
        fluent-plugin-elasticsearch &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
        fluent-plugin-kafka &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;

 &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; sudo -u fluent gem sources --clear-all &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
 &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; apk del .build-deps &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
 &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; rm -rf /var/cache/apk/&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
           /home/fluent/.gem/ruby/2.3.0/cache/&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;.gem
EXPOSE 24284&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;编写fluent配置文件&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;vim fluent.conf
&amp;lt;&lt;span class=&quot;nb&quot;&gt;source&lt;/span&gt;&amp;gt;
  @type forward
  port 24224
  &lt;span class=&quot;nb&quot;&gt;bind &lt;/span&gt;0.0.0.0
&amp;lt;/source&amp;gt;

&amp;lt;match &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;.&lt;span class=&quot;k&quot;&gt;**&lt;/span&gt;&amp;gt;
  @type kafka_buffered		//该字段表示output给kafka

  &lt;span class=&quot;c&quot;&gt;# list of seed brokers&lt;/span&gt;
  brokers 192.168.1.250:9092,192.168.1.251:9092,192.168.1.252:9092		//kafka集群

  &lt;span class=&quot;c&quot;&gt;# buffer settings&lt;/span&gt;
  buffer_type file
  buffer_path /var/log/td-agent/buffer/td
  flush_interval 3s

  &lt;span class=&quot;c&quot;&gt;# topic settings&lt;/span&gt;
  default_topic wangrubintest		//kafka上的topic

  &lt;span class=&quot;c&quot;&gt;# data type settings&lt;/span&gt;
  output_data_type json
  compression_codec gzip

  &lt;span class=&quot;c&quot;&gt;# producer settings&lt;/span&gt;
  max_send_retries 1
  required_acks -1
&amp;lt;/match&amp;gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;mkdir plugins
mkdir -p /var/log/td-agent/buffer/td&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;构建Docker镜像&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;fluentd/
docker build -t 10.0.0.39:5000/fluentd:v10 .&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;启动fluent&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;docker run -d -p 24224:24224/tcp -p 24224:24224/udp --rm --name fluentd 10.0.0.39:5000/fluentd:v10&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;elasticsearch&quot;&gt;部署elasticsearch&lt;/h2&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;docker run -d --rm -p 9200:9200 --name elasticsearch hub.c.163.com/library/elasticsearch:2.4&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;logstash&quot;&gt;部署logstash&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;准备logstash.conf配置文件&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;mkdir -p /root/logstash &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; vim /root/logstash/logstash.conf
&lt;span class=&quot;c&quot;&gt;#&lt;/span&gt;

input &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;    
    kafka &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;    
        zk_connect &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&amp;gt; &lt;span class=&quot;s2&quot;&gt;&quot;192.168.1.250:2181,192.168.1.251:2181,192.168.1.252:2181&quot;&lt;/span&gt;
        group_id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&amp;gt; &lt;span class=&quot;s2&quot;&gt;&quot;es&quot;&lt;/span&gt;    
        topic_id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&amp;gt; &lt;span class=&quot;s2&quot;&gt;&quot;wangrubintest&quot;&lt;/span&gt;
        codec &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&amp;gt; plain
        reset_beginning &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&amp;gt; &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# boolean (optional)， default: false&lt;/span&gt;
        consumer_threads &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&amp;gt; 5  &lt;span class=&quot;c&quot;&gt;# number (optional)， default: 1&lt;/span&gt;
        decorate_events &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&amp;gt; &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# boolean (optional)， default: false&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

output &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
     elasticsearch &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;         
        hosts &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&amp;gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;192.168.1.251:9200&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
         index &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&amp;gt; &lt;span class=&quot;s2&quot;&gt;&quot;logstash-%{+YYYY.MM.dd}&quot;&lt;/span&gt;
        workers &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&amp;gt; 5
        flush_size &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&amp;gt; 3840
        idle_flush_time &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&amp;gt; 10
        template_overwrite &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&amp;gt; &lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    stdout&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        codec &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&amp;gt; rubydebug
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;启动logstash&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;docker run -d --rm -v /root/logstash/:/config-dir/ logstash:2.4 -f /config-dir/logstash.conf&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;kibana&quot;&gt;部署kibana&lt;/h2&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;ocker run -d --rm --name kibana -e &lt;span class=&quot;nv&quot;&gt;ELASTICSEARCH_URL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.1.251:9200 -p 5601:5601 hub.c.163.com/library/kibana:4.6&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;section-2&quot;&gt;环境检查&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;http://192.168.1.250:5601/status&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;img src=&quot;/pic/FKLEK/1.png&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;nginx&quot;&gt;部署nginx测试&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;下载镜像&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;docker pull 10.0.0.39:5000/nginx:v1.12&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;启动镜像&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;docker run -d -p 80:80 --rm --log-driver&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;fluentd --log-opt fluentd-address&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;fluentd.test.com:24224 --log-opt &lt;span class=&quot;nv&quot;&gt;tag&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;nginx_access --name nginx 10.0.0.39:5000/nginx:v1.12&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;ul&gt;
  &lt;li&gt;访问nginx并去kibana观察日志&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;/pic/FKLEK/4.png&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/pic/FKLEK/2.png&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/pic/FKLEK/3.png&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Docker ==&amp;gt; Fluentd ==&amp;gt; Kafka ==&amp;gt; Logstash ==&amp;gt; ElasticSearch ==&amp;gt; Kibana 测试完毕&lt;/p&gt;

&lt;p&gt;end&lt;/p&gt;

</description>
        <pubDate>Fri, 19 May 2017 00:00:00 +0800</pubDate>
        <link>/docker/Docker-FKLEK.html</link>
        <guid isPermaLink="true">/docker/Docker-FKLEK.html</guid>
        
        
        <category>Docker</category>
        
      </item>
    
      <item>
        <title>Python抓取特定XML JSON HTML文件内容</title>
        <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#xml&quot; id=&quot;markdown-toc-xml&quot;&gt;XML文件处理&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;xml&quot;&gt;XML文件处理&lt;/h2&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;&lt;span class=&quot;c&quot;&gt;#!/usr/bin/python&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# -*- coding: UTF-8 -*-&lt;/span&gt;

from xml.parsers.expat import ParserCreate
from urllib import request

&lt;span class=&quot;c&quot;&gt;# 定义回调机制&lt;/span&gt;
class MovieHandler&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;object&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:
   def __init__&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;self&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:
      self.CurrentData &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;
      self.type &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;
      self.format &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;
      self.year &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;
      self.rating &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;
      self.stars &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;
      self.description &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;

   &lt;span class=&quot;c&quot;&gt;# 元素开始事件处理&lt;/span&gt;
   def startElement&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;self, tag, attributes&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:
      self.CurrentData &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; tag
      &lt;span class=&quot;k&quot;&gt;if &lt;/span&gt;self.CurrentData &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;movie&quot;&lt;/span&gt;:
         print&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;*****Movie*****&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
         title &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; attributes[&lt;span class=&quot;s2&quot;&gt;&quot;title&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
         print&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Title:&quot;&lt;/span&gt;, title&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;

   &lt;span class=&quot;c&quot;&gt;# 元素结束事件处理&lt;/span&gt;
   def endElement&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;self, tag&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:
      &lt;span class=&quot;k&quot;&gt;if &lt;/span&gt;self.CurrentData &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt;:
         print&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Type:&quot;&lt;/span&gt;, self.type&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;elif &lt;/span&gt;self.CurrentData &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;format&quot;&lt;/span&gt;:
         print&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Format:&quot;&lt;/span&gt;, self.format&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;elif &lt;/span&gt;self.CurrentData &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;year&quot;&lt;/span&gt;:
         print&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Year:&quot;&lt;/span&gt;, self.year&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;elif &lt;/span&gt;self.CurrentData &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;rating&quot;&lt;/span&gt;:
         print&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Rating:&quot;&lt;/span&gt;, self.rating&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;elif &lt;/span&gt;self.CurrentData &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;stars&quot;&lt;/span&gt;:
         print&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Stars:&quot;&lt;/span&gt;, self.stars&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;elif &lt;/span&gt;self.CurrentData &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;description&quot;&lt;/span&gt;:
         print&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Description:&quot;&lt;/span&gt;, self.description&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
      self.CurrentData &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;

   &lt;span class=&quot;c&quot;&gt;# 内容事件处理&lt;/span&gt;
   def characters&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;self, content&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:
      &lt;span class=&quot;k&quot;&gt;if &lt;/span&gt;self.CurrentData &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt;:
         self.type &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; content
      &lt;span class=&quot;k&quot;&gt;elif &lt;/span&gt;self.CurrentData &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;format&quot;&lt;/span&gt;:
         self.format &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; content
      &lt;span class=&quot;k&quot;&gt;elif &lt;/span&gt;self.CurrentData &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;year&quot;&lt;/span&gt;:
         self.year &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; content
      &lt;span class=&quot;k&quot;&gt;elif &lt;/span&gt;self.CurrentData &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;rating&quot;&lt;/span&gt;:
         self.rating &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; content
      &lt;span class=&quot;k&quot;&gt;elif &lt;/span&gt;self.CurrentData &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;stars&quot;&lt;/span&gt;:
         self.stars &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; content
      &lt;span class=&quot;k&quot;&gt;elif &lt;/span&gt;self.CurrentData &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;description&quot;&lt;/span&gt;:
         self.description &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; content

&lt;span class=&quot;c&quot;&gt;# 获取XML文件&lt;/span&gt;
with request.urlopen&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;http://wangrubin.com/testfile/movies.xml&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; as f:
        xml &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; f.read&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;

handler &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; MovieHandler&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;
parser &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ParserCreate&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# 重写原有的StartElementHandler EndElementHandler CharacterDataHandler&lt;/span&gt;
parser.StartElementHandler &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; handler.startElement
parser.EndElementHandler &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; handler.endElement
parser.CharacterDataHandler &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; handler.characters

parser.Parse&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;xml&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

</description>
        <pubDate>Tue, 25 Apr 2017 00:00:00 +0800</pubDate>
        <link>/python/python-web.html</link>
        <guid isPermaLink="true">/python/python-web.html</guid>
        
        
        <category>Python</category>
        
      </item>
    
      <item>
        <title>Learning to think in English</title>
        <description>&lt;h2 id=&quot;do-you-think-in-english&quot;&gt;Do you think in English?&lt;/h2&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;Article by: Simon Buckland, WSE International&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;For example, when someone asks you a question in English, do you immediately think to yourself in English “Mmmh, how shall i answer this question?” Or do you mentally translate the question into your own language, find an answer in your own language, and then mentally translate the answer into English before speaking?&lt;/p&gt;

&lt;p&gt;It took me quite a long time to write that question - and it will take you quite a long time to do it. if you look at the picture, you'll see exactly what happens when you go “the long way around 'instead of the direct route'”.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/pic/English/1.jpg&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I'v used  Chinese as an example, Because Chinese people do often translate mentally into Chinese before speaking in English. and to make it look really complicated for people who can't read Chinese!&lt;/p&gt;

&lt;p&gt;Here are some things for you to notice:&lt;/p&gt;

&lt;p&gt;There are five steps, compared with only one step if you think in english. Obviously, this is going to take time.&lt;/p&gt;

&lt;p&gt;When you translate into your own language you might make a mistake, or you might not find anything which is exactly like what you heard in English.&lt;/p&gt;

&lt;p&gt;Then, when you come up with the answer in your own language it may be something that you don't know how to say in English.&lt;/p&gt;

&lt;p&gt;With all these steps, you'll take even more time to think the right answer. Meanwhile the other person is sitting or standing there waiting for you to speak, Or maybe they're not even waiting anymore - maybe they've got bored with waiting, and they're already gone away!&lt;/p&gt;

&lt;p&gt;So i think it's obvious that you need to start thinking in English as soon as possible. The next question is: how long do you need to study English before you start thinking in English? Six months? One year? Two years? Ten years?&lt;/p&gt;

&lt;p&gt;The answer may surprise you: you can start thinking in English right from the beginning, even if you started studying only a coupleof weeks ago. How is this possible? The answer depends on understanding one or two things about how the brain works.&lt;/p&gt;

&lt;p&gt;There is an area in the human brain called, Wernicks's Area, witch is generallyassociatede with processing and understanding language. This area of brain is right next to the parts of the brain associated with visual images and memory.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/pic/English/2.jpg&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Take a look at this picture - which world do you first look at? Of course, it's the world in your own language - excuse me if yours is missing. Because the brain links the picture of the dog with the word 'dog' in your native language. But it is possible to use this aspect of the brain to help you think in English - by thinking of a picture in English, or related to English. When you speak English.&lt;/p&gt;

&lt;p&gt;Think about speaking English for a moment - What pictures come into your mind? Maybe it's famous places in English-speaking countries like Towe Bridge in London or the Statue of Liberty in New York. Or maybe the picture that comes into your mind is your local Wall Street Center - or a teacher or a Personal Tutor. It doesn't matter - if you try to keep these images in your mind when you speak, it will help you to think in English. Try it and see.&lt;/p&gt;

&lt;p&gt;And here's another idea for you to try, But first a question: Have you ever seen someone walking down the street, Talking to himself? Probably you thought 'poor man'; 'He's sick'; 'He needs to be in the hospital' - or something like that.&lt;/p&gt;

&lt;p&gt;Well, if people like that are crazy. so are most of us: we almost all talk to ourselves. The only difference is that us 'normal' people don't talk to ourselves out loud; we just do it inside our own heads, where no one can hear us.&lt;/p&gt;

&lt;p&gt;So when you 'talk to yourself', What language do you do it in? Obviously, in your own language, So why not try talking to yourself in English, Ask yourself some simple questions like: “How are you today?” or “Did you have a nice weekend?” or perhaps, if you're thinking about some decision in your life, talk about that in English - “So shall i take that job? will i be happy there?” or “Do i really like Maria? I think so, Maybe i'll ask her to go out to dinner with me” etc.etc.&lt;/p&gt;

&lt;p&gt;See how long you can keep up this 'mental conversation' in English: five minutes? Ten? Half an hour? more? You'll be surprised how much it will help you if you can talk yourself in English. After all, when you talk to yourself you know someone islistening!&lt;/p&gt;

&lt;p&gt;And when you're alone - but not when you are on the street or a train - try speaking out loud too. That will help you confidence in speaking as well.&lt;/p&gt;

&lt;p&gt;So, what do you think about this. Do you often think in English? What is it like for you? Please post your thoughts and experiences here - and thanks for reading.&lt;/p&gt;

</description>
        <pubDate>Tue, 18 Apr 2017 00:00:00 +0800</pubDate>
        <link>/point/Learning-to-think-in-English.html</link>
        <guid isPermaLink="true">/point/Learning-to-think-in-English.html</guid>
        
        
        <category>Point</category>
        
      </item>
    
      <item>
        <title>LVS 四层负载均衡</title>
        <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#section&quot; id=&quot;markdown-toc-section&quot;&gt;介绍&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#lvs&quot; id=&quot;markdown-toc-lvs&quot;&gt;LVS工作模式&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#lvs-1&quot; id=&quot;markdown-toc-lvs-1&quot;&gt;LVS工作原理&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#nat&quot; id=&quot;markdown-toc-nat&quot;&gt;NAT&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#dr&quot; id=&quot;markdown-toc-dr&quot;&gt;DR&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#tun&quot; id=&quot;markdown-toc-tun&quot;&gt;TUN&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#fullnat&quot; id=&quot;markdown-toc-fullnat&quot;&gt;FULLNAT&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-1&quot; id=&quot;markdown-toc-section-1&quot;&gt;需求&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-2&quot; id=&quot;markdown-toc-section-2&quot;&gt;前提&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-3&quot; id=&quot;markdown-toc-section-3&quot;&gt;模拟测试&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;section&quot;&gt;介绍&lt;/h2&gt;

&lt;p&gt;Linux虚拟服务器（Linux Virtual Server）&lt;/p&gt;

&lt;p&gt;我们使用该软件配置LVS时候，不能直接配置内核中的ipvs，而需要使用ipvs的管理工具ipvsadm进行管理；或者使用keepalived管理。&lt;/p&gt;

&lt;p&gt;LVS集群负载均衡器接受服务的所有入站客户端计算机请求，并根据调度算法决定哪个集群节点应该处理回复请求。负载均衡器(简称LB)有时也被称为LVS Director(简称Director)。&lt;/p&gt;

&lt;h2 id=&quot;lvs&quot;&gt;LVS工作模式&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;NAT（Network Address Translation）&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;DR（Direct Routing）&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;TUN（IP Tunneling）&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;FULLNAT（Full Network Address Translation）&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;lvs-1&quot;&gt;LVS工作原理&lt;/h2&gt;

&lt;h3 id=&quot;nat&quot;&gt;NAT&lt;/h3&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;NAT技术将请求的报文（通过DNAT方式改写）和响应的报文（通过SNAT方式改写），通过调度器地址重写然后在转发给内部的服务器，报文返回时改写成原来的用户请求的地址。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;只需要在调度器LB上配置WAN公网IP即可，调度器也要有私有LAN IP和内部RS节点通信。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;每台内部RS节点的网关地址，必须要配成调度器LB的私有LAN内物理网卡地址（LDIP），这样才能确保数据报文返回时仍然经过调度器LB。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;由于请求与响应的数据报文都经过调度器LB，因此，网站访问量大时调度器LB有较大瓶颈，一般要求最多10-20台节点。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;NAT模式支持对IP及端口的转换，即用户请求10.0.1.1:80，可以通过调度器转换到RS节点的10.0.1.2:8080（DR和TUN模式不具备的）。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;所有NAT内部RS节点只需配置私有LAN IP即可。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;由于数据包来回都需要经过调度器，因此，要开启内核转发net.ipv4.ip_forward = 1，当然也包括iptables防火墙的forward功能（DR和TUN模式不需要）。&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&quot;dr&quot;&gt;DR&lt;/h3&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;通过在调度器LB上修改数据包的目的MAC地址实现转发。注意，源IP地址仍然是CIP，目的IP地址仍然是VIP。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;请求的报文经过调度器，而RS响应处理后的报文无需经过调度器LB，因此，并发访问量大时使用效率很高（和NAT模式比）。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;因DR模式是通过MAC地址的改写机制实现的转发，因此，所有RS节点和调度器LB只能在一个局域网LAN中（小缺点）。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;需要注意RS节点的VIP的绑定（lo:vip/32,lo1:vip/32）和ARP抑制问题。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;RS节点的默认网关不需要是调度器LB的DIP，而直接是IDC机房分配的上级路由器的IP（这是RS带有外网IP地址的情况），理论讲：只要RS可以出网即可，不是必须要配置外网IP。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;由于DR模式的调度器仅进行了目的MAC地址的改写，因此，调度器LB无法改变请求的报文的目的端口（和NAT要区别）。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;总的来说DR模式效率很高，但是配置也较麻烦，因此，访问量不是特别大的公司可以用haproxy/nginx取代之。这符合运维的原则：简单、易用、高效。日1000-2000W PV或并发请求1万以下都可以考虑用haproxy/nginx（LVS NAT模式）&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;直接对外的访问业务，例如：web服务做RS节点，RS最好用公网IP地址。如果不直接对外的业务，例如：MySQL,存储系统RS节点，最好只用内部IP地址。&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&quot;tun&quot;&gt;TUN&lt;/h3&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;负载均衡器通过把请求的报文通过IP隧道（ipip隧道，高级班讲这个）的方式（请求的报文不经过原目的地址的改写(包括MAC)，而是直接封装成另外的IP报文）转发至真实服务器，而真实服务器将响应处理后直接返回给客户端用户。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;由于真实服务器将响应处理后的报文直接返回给客户端用户，因此，最好RS有一个外网IP地址，这样效率才会更高。理论上：只要能出网即可，无需外网IP地址。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;由于调度器LB只处理入站请求的报文。因此，此集群系统的吞吐量可以提高10倍以上，但隧道模式也会带来一定的系统开销。TUN模式适合LAN/WAN。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;TUN模式的LAN环境转发不如DR模式效率高，而且还要考虑系统对IP隧道的支持问题。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;所有的RS服务器都要绑定VIP，抑制ARP，配置复杂。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;LAN环境一般多采用DR模式，WAN环境可以用TUN模式，但是当前在WAN环境下，请求转发更多的被haproxy/nginx/DNS调度等代理取代。因此，TUN模式在国内公司实际应用的已经很少。跨机房应用要么拉光纤成局域网，要么DNS调度，底层数据还得同步。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;直接对外的访问业务，例如：web服务做RS节点，最好用公网IP地址。不直接对外的业务，例如：MySQL,存储系统RS节点，最好用内部IP地址。&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&quot;fullnat&quot;&gt;FULLNAT&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;数据包经过LVS时；同时更改DIP+PORT 和 SIP+PORT&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;section-1&quot;&gt;需求&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;使用lvs实现 client访问公网IPA+prot 映射到内网的real server的IPB+port上&lt;/li&gt;
  &lt;li&gt;Real server 可以看到client的公网IP地址&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;LVS本是用来做负载均衡，但在单real server节点的时候，相当于实现了NAT功能&lt;/code&gt;&lt;/p&gt;

&lt;h2 id=&quot;section-2&quot;&gt;前提&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;lvs有一个内网IP 和 后端real server在同一网段&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;后端的real server 需要将网关指向lvs的内网IP&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;lvs上配置了公网VIP用户可以访问到。（即路由可达）&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;section-3&quot;&gt;模拟测试&lt;/h2&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;安装LVS&lt;/code&gt;&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;modprobe ip_vs
yum install ipvsadm -y	&lt;span class=&quot;c&quot;&gt;#安装IPVS的管理模块，真正实现负载的是工作在内核空间的IPVS&lt;/span&gt;
lsmod |grep ip_vs	&lt;span class=&quot;c&quot;&gt;#有输出则代表内核支持lvs，基本都支持lvs&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;ulimit&lt;/span&gt; -n 65535
sed -i &lt;span class=&quot;s1&quot;&gt;'s#net.ipv4.ip_forward = 0#net.ipv4.ip_forward = 1#g'&lt;/span&gt; /etc/sysctl.conf		&lt;span class=&quot;c&quot;&gt;#开启内核转发&lt;/span&gt;
sysctl -p	&lt;span class=&quot;c&quot;&gt;#使配置生效&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;配置转发策略&lt;/code&gt;&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;ipvsadm -C		&lt;span class=&quot;c&quot;&gt;#清空所有规则&lt;/span&gt;
ipvsadm -A -t 128.24.170.256:7000 -s rr		&lt;span class=&quot;c&quot;&gt;#添加VIP+PORT 负载策略：轮询&lt;/span&gt;
ipvsadm -a -t 128.24.170.256:7000  -r 192.168.1.12:7000 -m	&lt;span class=&quot;c&quot;&gt;#VIP+PORT ----&amp;gt; RIP+PORT 负载模式：NAT&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;保存配置&lt;/code&gt;&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;service ipvsadm save&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;开机启动&lt;/code&gt;&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;chkconfig ipvsadm on&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;重启&lt;/code&gt;&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;service ipvsadm restart
/etc/init.d/ipvsadm restart&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;hr /&gt;

&lt;p&gt;end&lt;/p&gt;

</description>
        <pubDate>Mon, 17 Apr 2017 00:00:00 +0800</pubDate>
        <link>/network/LVS-NAT.html</link>
        <guid isPermaLink="true">/network/LVS-NAT.html</guid>
        
        
        <category>Network</category>
        
      </item>
    
      <item>
        <title>Iptables和HAproxy实现端口转发</title>
        <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#section&quot; id=&quot;markdown-toc-section&quot;&gt;需求：&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-1&quot; id=&quot;markdown-toc-section-1&quot;&gt;问题：&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-2&quot; id=&quot;markdown-toc-section-2&quot;&gt;解决方案：&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-3&quot; id=&quot;markdown-toc-section-3&quot;&gt;模拟测试：&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#iptables&quot; id=&quot;markdown-toc-iptables&quot;&gt;Iptables&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#section-4&quot; id=&quot;markdown-toc-section-4&quot;&gt;压力测试&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#haproxy&quot; id=&quot;markdown-toc-haproxy&quot;&gt;HAproxy&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-5&quot; id=&quot;markdown-toc-section-5&quot;&gt;推测结论&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;section&quot;&gt;需求：&lt;/h2&gt;

&lt;p&gt;client访问公网IP-A+prot 映射到公网IP-B+port&lt;/p&gt;

&lt;h2 id=&quot;section-1&quot;&gt;问题：&lt;/h2&gt;

&lt;p&gt;client访问的是A 数据包经过A之后目的变成B B收到数据包处理完毕回包，由于B会将数据包直接回向client；注意：client一开始访问的是A，回包的是B，所以三次握手都无法建立成功。&lt;/p&gt;

&lt;h2 id=&quot;section-2&quot;&gt;解决方案：&lt;/h2&gt;

&lt;p&gt;避免公网B直接给真实client回包；所以除了做DNAT外还需做SNAT&lt;/p&gt;

&lt;h2 id=&quot;section-3&quot;&gt;模拟测试：&lt;/h2&gt;

&lt;p&gt;访问192.168.1.11:8080 —»202.205.184.149:80（中国教育网IP）&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;方案一：&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;192.168.1.11上配置iptables 做SNAT+DNAT&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;方案二：&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;192.168.1.11上配置haproxy实现TCP层反向代理负载均衡（单个realserver节点其实就是变相的SNAT+DNAT）&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;方案三：&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;192.168.1.11上配置LVS的Full NAT模式(SNAT+DNAT)&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;方案四：&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;192.168.1.11上配置nginx的4层转发(SNAT+DNAT)&lt;/p&gt;

&lt;h2 id=&quot;iptables&quot;&gt;Iptables&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;开启路由转发，关闭系统sys防护（以便后面进行压测）&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;&lt;span class=&quot;nb&quot;&gt;ulimit&lt;/span&gt; -n 65535
&lt;span class=&quot;nb&quot;&gt;echo &lt;/span&gt;1 &amp;gt; /proc/sys/net/ipv4/ip_forward
sed -i &lt;span class=&quot;s1&quot;&gt;'s#net.ipv4.ip_forward = 0#net.ipv4.ip_forward = 1#g'&lt;/span&gt; /etc/sysctl.conf
sed -i &lt;span class=&quot;s1&quot;&gt;'s#net.ipv4.tcp_syncookies = 1#net.ipv4.tcp_syncookies = 0#g'&lt;/span&gt; /etc/sysctl.conf
modprobe ip_tables
modprobe iptable_filter
modprobe iptable_nat
modprobe ip_conntrack
modprobe ip_conntrack_ftp
modprobe ip_nat_ftp
modprobe ipt_state
sysctl -p&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;/etc/init.d/iptables start
iptables -F
iptables -X
iptables -t nat -A PREROUTING -d 192.168.1.11 -p tcp --dport 8888 -j DNAT --to-destination 202.205.184.149:80
iptables -t nat -A POSTROUTING -d 202.205.184.149/32 -o eth0 -j SNAT --to-source 192.168.1.11
iptables-save &amp;gt;/etc/sysconfig/iptables
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;/etc/init.d/iptables start&quot;&lt;/span&gt; &amp;gt;&amp;gt; /etc/rc.local&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;&lt;img src=&quot;/pic/iptables-HAproxy/jiaoyu.png&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;section-4&quot;&gt;压力测试&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;sed -i ‘s#net.ipv4.tcp_syncookies = 1#net.ipv4.tcp_syncookies = 0#g’ /etc/sysctl.conf&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;压测服务器 iptables 应用服务器都要关闭此选项才能进行高并发测试；否则报错：apr_socket_recv: Connection reset by peer (104)&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;为了排除网络因素 因此我们不夸互联网进行测试&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;&lt;span class=&quot;nb&quot;&gt;ulimit&lt;/span&gt; -n 65535
iptables -t nat -A PREROUTING -d 192.168.1.11 -p tcp --dport 8888 -j DNAT --to-destination 192.168.1.100:80
iptables -t nat -A POSTROUTING -d 192.168.1.100/32 -o eth0 -j SNAT --to-source 192.168.1.11&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;192.168.1.100是我搭建的nginx web服务 提供了一个静态页面&lt;/code&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;安装压力测试工具并且开始压测&lt;/li&gt;
&lt;/ul&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;yum install httpd-tools -y
ab -n 100000 -c 10000 http://192.168.1.11:8888/&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;&lt;img src=&quot;/pic/iptables-HAproxy/iptables01.png&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/pic/iptables-HAproxy/iptables02.png&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;haproxy&quot;&gt;HAproxy&lt;/h2&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;wget http://www.haproxy.org/download/1.7/src/haproxy-1.7.5.tar.gz
tar xf haproxy-1.7.5.tar.gz 
&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;haproxy-1.7.5
uname -r
make &lt;span class=&quot;nv&quot;&gt;TARGET&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;linux26 &lt;span class=&quot;nv&quot;&gt;PREFIX&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/local/haproxy
make install &lt;span class=&quot;nv&quot;&gt;PREFIX&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/local/haproxy
mkdir /etc/haproxy/conf -p&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;cat &amp;gt;&amp;gt; /etc/haproxy/conf/haproxy.cfg &lt;span class=&quot;sh&quot;&gt;&amp;lt;&amp;lt;EOF
global  
        daemon  
        nbproc 10  
        pidfile /var/run/haproxy.pid  
defaults  
        mode tcp               #默认的模式mode { tcp|http|health }，tcp是4层，http是7层，health只会返回OK  
        retries 2               #两次连接失败就认为是服务器不可用，也可以通过后面设置  
        option abortonclose     #当服务器负载很高的时候，自动结束掉当前队列处理比较久的链接  
        maxconn 65535            #默认的最大连接数  
        timeout connect 5000ms  #连接超时  
        timeout client 30000ms  #客户端超时  
        timeout server 10000ms  #服务器超时  
        log 127.0.0.1 local0 err #[err warning info debug]  
listen test1  
        bind 0.0.0.0:8888  
        mode tcp  
        server s1 192.168.1.100:80
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;EOF&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;blockquote&gt;
  &lt;p&gt;/usr/local/haproxy/sbin/haproxy -f /etc/haproxy/conf/haproxy.cfg &amp;amp;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;img src=&quot;/pic/iptables-HAproxy/ha01.png&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/pic/iptables-HAproxy/ha02.png&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;section-5&quot;&gt;推测结论&lt;/h2&gt;

&lt;p&gt;HAproxy用来当做NAT设备使用，在高并发场景会消耗大量CPU计算资源，性能远不如iptables&lt;/p&gt;

&lt;p&gt;Iptables做NAT设备使用几乎不消耗CPU和内存资源。&lt;/p&gt;

</description>
        <pubDate>Tue, 11 Apr 2017 00:00:00 +0800</pubDate>
        <link>/network/Iptables-Haproxy.html</link>
        <guid isPermaLink="true">/network/Iptables-Haproxy.html</guid>
        
        
        <category>Network</category>
        
      </item>
    
      <item>
        <title>Nginx-proxy_pass理解</title>
        <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#section&quot; id=&quot;markdown-toc-section&quot;&gt;需求&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-1&quot; id=&quot;markdown-toc-section-1&quot;&gt;问题&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#nginx&quot; id=&quot;markdown-toc-nginx&quot;&gt;nginx配置&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-2&quot; id=&quot;markdown-toc-section-2&quot;&gt;我以为&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-3&quot; id=&quot;markdown-toc-section-3&quot;&gt;事实是&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-4&quot; id=&quot;markdown-toc-section-4&quot;&gt;解决方案&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-5&quot; id=&quot;markdown-toc-section-5&quot;&gt;拿数据说话&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;section&quot;&gt;需求&lt;/h2&gt;

&lt;p&gt;用户访问：www.wangrubin.com/weixin/front/123.ttf 这个文件;&lt;/p&gt;

&lt;p&gt;www.wangrubin.com被解析到了nginx上;&lt;/p&gt;

&lt;p&gt;nginx需要到www.123.com/uploadServer/fonts/123.ttf 取到132.ttf这个文件返回给用户。&lt;/p&gt;

&lt;h2 id=&quot;section-1&quot;&gt;问题&lt;/h2&gt;

&lt;p&gt;www.123.com 做了防盗链配置，http-header中的host字段必须是自己的域名才会接受访问；&lt;/p&gt;

&lt;h2 id=&quot;nginx&quot;&gt;nginx配置&lt;/h2&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;location /weixin/front/ &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                proxy_pass http:///www.123.com/uploadServer/fonts/;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h2 id=&quot;section-2&quot;&gt;我以为&lt;/h2&gt;

&lt;ol&gt;
  &lt;li&gt;当用户浏览器访问www.wangrubin.com/weixin/front/123.ttf&lt;/li&gt;
  &lt;li&gt;流量到nginx上，命中location /weixin/front/&lt;/li&gt;
  &lt;li&gt;nginx代替用户去访问http:///www.123.com/uploadServer/fonts/123.ttf&lt;/li&gt;
  &lt;li&gt;www.123.com这台主机看到的请求host是www.123.com；因为nginx完全自主的发起了新的连接&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;section-3&quot;&gt;事实是&lt;/h2&gt;

&lt;ol&gt;
  &lt;li&gt;当用户浏览器访问www.wangrubin.com/weixin/front/123.ttf&lt;/li&gt;
  &lt;li&gt;流量到nginx上，命中location /weixin/front/&lt;/li&gt;
  &lt;li&gt;nginx代替用户去访问http:///www.123.com/uploadServer/fonts/123.ttf&lt;/li&gt;
  &lt;li&gt;www.123.com这台主机看到的请求host是www.wangrubin.com，不匹配本机server字段，不处理&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;section-4&quot;&gt;解决方案&lt;/h2&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;location /weixin/front/ &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
		proxy_set_header Host www.wangrubin.com;
                proxy_pass http:///www.123.com/uploadServer/fonts/;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;blockquote&gt;
  &lt;p&gt;proxy_pass代理到upstream 需要添加proxy_set_header Host字段很容易理解，因为upstream中配置的IP地址，所以需要传递Host值，但是proxy_pass 代理到一个域名，我本以为是nginx自身为客户端去访问http://www.123.com/uploadServer/fonts/123.ttf，这是按照道理说Host字段应该是www.123.com，然而却不是这样的。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;猜测：nginx在reload配置时会将域名解析成IP地址，保存到内存中，这样在高并发访问场景中，无需进行耗时的DNS解析。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;section-5&quot;&gt;拿数据说话&lt;/h2&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;没有手动传Host参数&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/pic/nginx-proxx_pass/1490778110.png&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;手动传Host参数&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/pic/nginx-proxx_pass/20170329170247.png&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;end&lt;/p&gt;
</description>
        <pubDate>Wed, 29 Mar 2017 00:00:00 +0800</pubDate>
        <link>/nginx/Nginx-Upstream.html</link>
        <guid isPermaLink="true">/nginx/Nginx-Upstream.html</guid>
        
        
        <category>Nginx</category>
        
      </item>
    
      <item>
        <title>dmidecode</title>
        <description>&lt;h3 id=&quot;bios&quot;&gt;查看BIOS信息&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;dmidecode -t 0&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;section&quot;&gt;查看系统信息&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;dmidecode -t 1&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;u&quot;&gt;查看服务器u数电源数&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;dmidecode -t 3&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;cpu&quot;&gt;查看cpu信息&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;dmidecode -t 4 |grep Version&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;dmidecode -t 7&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;section-1&quot;&gt;查看服务器物理接口信息&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;dmidecode -t 8&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;section-2&quot;&gt;查看最大支持内存&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;dmidecode -t 16&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;section-3&quot;&gt;查看内存详细信息&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;dmidecode -t 17&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;section-4&quot;&gt;查看服务器电源信息&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;dmidecode -t 39&lt;/p&gt;
&lt;/blockquote&gt;

</description>
        <pubDate>Tue, 28 Mar 2017 00:00:00 +0800</pubDate>
        <link>/command/dmidecode.html</link>
        <guid isPermaLink="true">/command/dmidecode.html</guid>
        
        
        <category>Command</category>
        
      </item>
    
      <item>
        <title>递归算法--HanoiTower</title>
        <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#section&quot; id=&quot;markdown-toc-section&quot;&gt;起源&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-1&quot; id=&quot;markdown-toc-section-1&quot;&gt;抽象成数学问题&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-2&quot; id=&quot;markdown-toc-section-2&quot;&gt;归纳法求解&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-3&quot; id=&quot;markdown-toc-section-3&quot;&gt;归纳总结&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-4&quot; id=&quot;markdown-toc-section-4&quot;&gt;递归算法分析&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-5&quot; id=&quot;markdown-toc-section-5&quot;&gt;调用方法的栈机制&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#pythond&quot; id=&quot;markdown-toc-pythond&quot;&gt;Pythond代码&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;section&quot;&gt;起源&lt;/h2&gt;

&lt;p&gt;汉诺塔（又称河内塔）问题是源于印度一个古老传说的益智玩具。&lt;/p&gt;

&lt;p&gt;大梵天创造世界的时候做了三根金刚石柱子，在一根柱子上从下往上按照大小顺序摞着64片黄金圆盘。&lt;/p&gt;

&lt;p&gt;大梵天命令婆罗门把圆盘从下面开始按大小顺序重新摆放在另一根柱子上。&lt;/p&gt;

&lt;p&gt;并且规定，在小圆盘上不能放大圆盘，在三根柱子之间一次只能移动一个圆盘。&lt;/p&gt;

&lt;h2 id=&quot;section-1&quot;&gt;抽象成数学问题&lt;/h2&gt;

&lt;p&gt;如下图所示，从左到右有A、B、C三根柱子，其中A柱子上面有从小叠到大的n个圆盘，现要求将A柱子上的圆盘移到C柱子上去.&lt;/p&gt;

&lt;p&gt;期间只有一个原则：一次只能移到一个盘子且大盘子不能在小盘子上面，求移动的步骤和移动的次数.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/pic/python/HanoiTower/1026866-20161016022859889-2055402664.jpg&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;section-2&quot;&gt;归纳法求解&lt;/h2&gt;

&lt;p&gt;n = 1&lt;/p&gt;

&lt;p&gt;第1次  1号盘  A —-&amp;gt;C&lt;/p&gt;

&lt;p&gt;n = 2&lt;/p&gt;

&lt;p&gt;第1次  1号盘  A—-&amp;gt;B&lt;/p&gt;

&lt;p&gt;第2次  2号盘  A—-&amp;gt;C&lt;/p&gt;

&lt;p&gt;第3次  1号盘  B—-&amp;gt;C&lt;/p&gt;

&lt;p&gt;n = 3&lt;/p&gt;

&lt;p&gt;第1次  1号盘  A—-&amp;gt;C&lt;/p&gt;

&lt;p&gt;第2次  2号盘  A—-&amp;gt;B&lt;/p&gt;

&lt;p&gt;第3次  1号盘  C—-&amp;gt;B&lt;/p&gt;

&lt;p&gt;第4次  3号盘  A—-&amp;gt;C&lt;/p&gt;

&lt;p&gt;第5次  1号盘  B—-&amp;gt;A&lt;/p&gt;

&lt;p&gt;第6次  2号盘  B—-&amp;gt;C&lt;/p&gt;

&lt;p&gt;第7次  1号盘  A—-&amp;gt;C&lt;/p&gt;

&lt;h2 id=&quot;section-3&quot;&gt;归纳总结&lt;/h2&gt;

&lt;p&gt;1个圆盘的次数 2的1次方减1&lt;/p&gt;

&lt;p&gt;2个圆盘的次数 2的2次方减1&lt;/p&gt;

&lt;p&gt;3个圆盘的次数 2的3次方减1&lt;/p&gt;

&lt;p&gt;n个圆盘的次数 2的n次方减1&lt;/p&gt;

&lt;h2 id=&quot;section-4&quot;&gt;递归算法分析&lt;/h2&gt;

&lt;p&gt;我们在利用计算机求汉诺塔问题时，必不可少的一步是对整个实现求解进行算法分析。到目前为止，求解汉诺塔问题最简单的算法还是同过递归来求，至于是什么是递归，递归实现的机制是什么，我们说的简单点就是自己是一个方法或者说是函数，但是在自己这个函数里有调用自己这个函数的语句，而这个调用怎么才能调用结束呢？这里还必须有一个结束点，或者具体的说是在调用到某一次后函数能返回一个确定的值，接着倒数第二个就能返回一个确定的值，一直到第一次调用的这个函数能返回一个确定的值。&lt;/p&gt;

&lt;p&gt;实现这个算法可以简单分为三个步骤：&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;把n-1个盘子由 A 移到 B；&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;把第n个盘子由 A 移到 C；&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;把n-1个盘子由 B 移到 C；&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;从这里入手，在加上上面数学问题解法的分析，我们不难发现，移到的步数必定为奇数步：&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;中间的一步是把最大的一个盘子由A移到C上去；&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;中间一步之上可以看成把A上n-1个盘子通过借助辅助塔（C塔）移到了B上，&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;中间一步之下可以看成把B上n-1个盘子通过借助辅助塔（A塔）移到了C上；&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;section-5&quot;&gt;调用方法的栈机制&lt;/h2&gt;

&lt;p&gt;特点：先进后出&lt;/p&gt;

&lt;p&gt;从主线程开始调用方法（函数）进行不停的压栈和出栈操作，函数的调用就是将函数压如栈中，函数的结束就是函数出栈的过程，这样就保证了方法调用的顺序流，即当函数出现多层嵌套时，需要从外到内一层层把函数压入栈中，最后栈顶的函数先执行结束（最内层的函数先执行结束）后出栈，再倒数第二层的函数执行结束出栈，到最后，第一个进栈的函数调用结束后从栈中弹出回到主线程，并且结束。&lt;/p&gt;

&lt;h2 id=&quot;pythond&quot;&gt;Pythond代码&lt;/h2&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;def HanoiTower&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;n,source,Buffer,destination&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:
    &lt;span class=&quot;k&quot;&gt;if &lt;/span&gt;n &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; 1:
        print&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;source&lt;/span&gt;,&lt;span class=&quot;s1&quot;&gt;'------&amp;gt;'&lt;/span&gt;,destination&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return
    &lt;/span&gt;HanoiTower&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;n-1,source,destination,Buffer&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
    HanoiTower&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;1,source,Buffer,destination&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
    HanoiTower&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;n-1,Buffer,source,destination&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
HanoiTower&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;4,&lt;span class=&quot;s1&quot;&gt;'A'&lt;/span&gt;,&lt;span class=&quot;s1&quot;&gt;'B'&lt;/span&gt;,&lt;span class=&quot;s1&quot;&gt;'C'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;A ------&amp;gt; B
A ------&amp;gt; C
B ------&amp;gt; C
A ------&amp;gt; B
C ------&amp;gt; A
C ------&amp;gt; B
A ------&amp;gt; B
A ------&amp;gt; C
B ------&amp;gt; C
B ------&amp;gt; A
C ------&amp;gt; A
B ------&amp;gt; C
A ------&amp;gt; B
A ------&amp;gt; C
B ------&amp;gt; C&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;hr /&gt;

&lt;p&gt;end&lt;/p&gt;

</description>
        <pubDate>Fri, 10 Mar 2017 00:00:00 +0800</pubDate>
        <link>/python/HanoiTower.html</link>
        <guid isPermaLink="true">/python/HanoiTower.html</guid>
        
        
        <category>Python</category>
        
      </item>
    
  </channel>
</rss>
