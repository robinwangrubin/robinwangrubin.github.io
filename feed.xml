<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Robin's Personal Website</title>
    <description></description>
    <link>/</link>
    <atom:link href="/feed.xml" rel="self" type="application/rss+xml"/>
    <pubDate>Tue, 10 Oct 2017 12:10:58 +0800</pubDate>
    <lastBuildDate>Tue, 10 Oct 2017 12:10:58 +0800</lastBuildDate>
    <generator>Jekyll v3.3.0</generator>
    
      <item>
        <title>MyDNS</title>
        <description>&lt;h2 id=&quot;section&quot;&gt;基础环境准备&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;yum -y install gcc gcc-c++ autoconf automake zlib zlib-devel openssl openssl-devel pcre* make gd-devel libjpeg-devel libpng-devel libxml2-devel bzip2-devel libcurl-devel freetype-devel ncurses ncurses-devel cmake libaio
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;lnmp&quot;&gt;LNMP环境准备&lt;/h2&gt;

&lt;h3 id=&quot;mysql&quot;&gt;安装Mysql&lt;/h3&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;useradd mysql -s /sbin/nologin -M
mkdir /mysql /mysql/data /mysql/log 
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;二进制安装mysql&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;wget http://mirrors.sohu.com/mysql/MySQL-5.7/mysql-5.7.17-linux-glibc2.5-x86_64.tar.gz
tar xf mysql-5.7.17-linux-glibc2.5-x86_64.tar.gz -C /usr/local/
ln -s /usr/local/mysql-5.7.17-linux-glibc2.5-x86_64 /usr/local/mysql
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;编译安装mysql&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;wget http://mirrors.sohu.com/mysql/MySQL-5.7/mysql-boost-5.7.17.tar.gz
tar xf mysql-boost-5.7.17.tar.gz &amp;amp;&amp;amp; cd mysql-5.7.17
cmake . -DCMAKE_INSTALL_PREFIX=/usr/local/mysql5.7.17 \
-DMYSQL_DATADIR=/data/mysql \
-DDOWNLOAD_BOOST=1 \
-DWITH_BOOST=./boost/boost_1_59_0 \
-DSYSCONFDIR=/etc \
-DWITH_INNOBASE_STORAGE_ENGINE=1 \
-DWITH_PARTITION_STORAGE_ENGINE=1 \
-DWITH_FEDERATED_STORAGE_ENGINE=1 \
-DWITH_BLACKHOLE_STORAGE_ENGINE=1 \
-DWITH_MYISAM_STORAGE_ENGINE=1 \
-DENABLED_LOCAL_INFILE=1 \
-DENABLE_DTRACE=0 \
-DDEFAULT_CHARSET=utf8mb4 \
-DDEFAULT_COLLATION=utf8mb4_general_ci \
-DWITH_EMBEDDED_SERVER=1
make &amp;amp;&amp;amp; make install
ln -s /usr/local/mysql5.7.17/ /usr/local/mysql
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;初始化mysql&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;/usr/local/mysql/bin/mysqld --initialize-insecure --user=mysql --basedir=/usr/local/mysql --datadir=/mysql/data/
/usr/local/mysql/bin/mysql_ssl_rsa_setup  --datadir=/mysql/data
chown -R mysql:mysql /usr/local/mysql /mysql
cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld
chmod +x /etc/init.d/mysqld
cp /usr/local/mysql/bin/* /usr/sbin/
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;配置mysql&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;cat &amp;gt;/etc/my.cnf&amp;lt;&amp;lt;EOF
#
[client]
port = 3306
socket = /tmp/mysql.sock
default-character-set = utf8mb4

[mysqld]
port = 3306
socket = /tmp/mysql.sock
basedir = /usr/local/mysql
datadir = /mysql/data/
pid-file = /mysql/data/mysql.pid
user = mysql
bind-address = 0.0.0.0
server-id = 1
init-connect = 'SET NAMES utf8mb4'
character-set-server = utf8mb4
#skip-name-resolve
#skip-networking
back_log = 300
max_connections = 1000
max_connect_errors = 6000
open_files_limit = 65535
table_open_cache = 128
max_allowed_packet = 4M
binlog_cache_size = 1M
max_heap_table_size = 8M
tmp_table_size = 16M
read_buffer_size = 2M
read_rnd_buffer_size = 8M
sort_buffer_size = 8M
join_buffer_size = 8M
key_buffer_size = 4M
thread_cache_size = 8
query_cache_type = 1
query_cache_size = 8M
query_cache_limit = 2M
ft_min_word_len = 4
log_bin = mysql-bin
binlog_format = mixed
expire_logs_days = 30
log_error = /mysql/log/mysql-error.log
slow_query_log = 1
long_query_time = 1
slow_query_log_file = /mysql/log/mysql-slow.log
performance_schema = 0
explicit_defaults_for_timestamp
#lower_case_table_names = 1
skip-external-locking
default_storage_engine = InnoDB
#default-storage-engine = MyISAM
innodb_file_per_table = 1
innodb_open_files = 500
innodb_buffer_pool_size = 64M
innodb_write_io_threads = 4
innodb_read_io_threads = 4
innodb_thread_concurrency = 0
innodb_purge_threads = 1
innodb_flush_log_at_trx_commit = 2
innodb_log_buffer_size = 2M
innodb_log_file_size = 32M
innodb_log_files_in_group = 3
innodb_max_dirty_pages_pct = 90
innodb_lock_wait_timeout = 120
bulk_insert_buffer_size = 8M
myisam_sort_buffer_size = 8M
myisam_max_sort_file_size = 10G
myisam_repair_threads = 1
interactive_timeout = 28800
wait_timeout = 28800
[mysqldump]
quick
max_allowed_packet = 16M
[myisamchk]
key_buffer_size = 8M
sort_buffer_size = 8M
read_buffer = 4M
write_buffer = 4M
EOF
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;hr /&gt;

&lt;h3 id=&quot;php&quot;&gt;安装PHP&lt;/h3&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;yum install libxml2-devel libjpeg-devel libiconv-devel freetype-devel libpng-devel gd-devel curl-devel libxslt-devel libmcrypt-devel mhash mhash-devel mcrypt -y
wget http://br2.php.net/distributions/php-5.3.27.tar.gz
tar xf php-5.3.27.tar.gz  &amp;amp;&amp;amp; cd php-5.3.27
./configure --prefix=/usr/local/php5.3.27 --with-mysql=/usr/local/mysql --with-iconv-dir --with-freetype-dir --with-jpeg-dir --with-png-dir --with-zlib --with-libxml-dir=/usr --enable-xml --disable-rpath --enable-safe-mode --enable-bcmath --enable-shmop --enable-sysvsem --enable-inline-optimization --with-curl --with-curlwrappers --enable-mbregex --enable-fpm --enable-mbstring --with-mcrypt --with-gd --enable-gd-native-ttf --with-openssl --with-mhash --enable-pcntl --enable-sockets --with-xmlrpc --enable-zip --enable-soap --enable-short-tags --enable-zend-multibyte --enable-static --with-xsl --with-fpm-user=nginx --with-fpm-group=nginx --enable-ftp
ln -s /usr/local/mysql/lib/libmysqlclient.so.20 /usr/lib64/
touch ext/phar/phar.phar
make &amp;amp;&amp;amp; make install
ln -s /usr/local/php5.3.27/ /usr/local/php
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;配置PHP&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;cp /root/php-5.3.27/php.ini-production /usr/local/php/etc/php.ini
cp /usr/local/php/etc/php-fpm.conf.default /usr/local/php/etc/php-fpm.conf

sed -i 's#max_execution_time =.*#max_execution_time = 300#g' /usr/local/php/etc/php.ini
sed -i 's#memory_limit = .*#memory_limit = 128M#g' /usr/local/php/etc/php.ini
sed -i 's#post_max_size = .*#post_max_size = 16M#g' /usr/local/php/etc/php.ini        
sed -i 's#upload_max_filesize = .*#upload_max_filesize = 2M#g' /usr/local/php/etc/php.ini           
sed -i 's#max_input_time = .*#max_input_time = 300#g' /usr/local/php/etc/php.ini
sed -i 's#;date.timezone.*#date.timezone = PRC#g'  /usr/local/php/etc/php.ini

grep &quot;max_execution_time = &quot; /usr/local/php/etc/php.ini  
grep &quot;memory_limit = &quot; /usr/local/php/etc/php.ini  
grep &quot;post_max_size =&quot; /usr/local/php/etc/php.ini  
grep &quot;upload_max_filesize =&quot; /usr/local/php/etc/php.ini  
grep &quot;max_input_time =&quot; /usr/local/php/etc/php.ini  
grep &quot;date.timezone =&quot; /usr/local/php/etc/php.ini  
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;hr /&gt;

&lt;h3 id=&quot;nginx&quot;&gt;安装nginx&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;安装gninx&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;http://wangrubin.com/shell/nginx.html&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;配置nginx&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mkdir -p /usr/local/nginx/html/mydns
mkdir -p /var/log/nginx/mydns 
mkdir -p /usr/local/nginx/conf/extra
cat &amp;gt;/usr/local/nginx/conf/nginx.conf&amp;lt;&amp;lt;EOF
user  nginx;
worker_processes  auto;

#error_log  logs/error.log warning;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

pid        logs/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    log_format  main  '\$remote_addr - \$remote_user [\$time_local] &quot;\$request&quot; '
                      '\$status \$body_bytes_sent &quot;\$http_referer&quot; '
                      '&quot;\$http_user_agent&quot; &quot;\$http_x_forwarded_for&quot;';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    #gzip  on;
    include extra/*.conf;
}
EOF
cat &amp;gt;/usr/local/nginx/conf/extra/mydns.conf &amp;lt;&amp;lt;EOF
server {
listen 80;
server_name localhost;
access_log /var/log/nginx/mydns/nginx_mydns.log main;
root html;

location / {
           index index.html index.php index.html;
        }

location ~ .*\.(php|php5)?$
            {
             fastcgi_pass  127.0.0.1:9000;
             fastcgi_index index.php;
             include fastcgi.conf;
           }
}
EOF
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;mydns&quot;&gt;安装MyDNS&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;wget http://mydns.bboy.net/download/mydns-1.1.0.tar.gz
tar xf mydns-1.1.0.tar.gz &amp;amp;&amp;amp; cd mydns-1.1.0
./configure --prefix=/usr/local/mydns --with-mysql-lib=/usr/lib64/mysql/ --with-zlib=/usr/lib64/
make &amp;amp;&amp;amp; make install
ln -s /usr/local/mysql/lib/libmysqlclient.so.20 /usr/lib
ldconfig 
make conf   
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;section-1&quot;&gt;启动服务&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;启动nginx&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;/etc/init.d/nginx start&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;启动mysql&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;/etc/init.d/mysqld start&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;启动PHP&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;/usr/local/php/sbin/php-fpm&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;启动MyDNS&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;/usr/local/mydns/sbin/mydns -b&lt;/p&gt;
&lt;/blockquote&gt;

&lt;hr /&gt;

&lt;ul&gt;
  &lt;li&gt;创建数据库&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;language-`&quot;&gt;mysql -uroot -p
set global validate_password_policy=0;
create database mydns;
grant all on mydns.* to 'mydns'@'localhost' identified by 'mydns_password';
flush privileges;
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
  &lt;li&gt;配置MyDNS&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sed -i 's#db-host = .*#db-host = localhost#g' /etc/mydns.conf 
sed -i 's#db-user = .*#db-user = mydns#g' /etc/mydns.conf 
sed -i 's#db-password = .*#db-password = mydns_password#g' /etc/mydns.conf 
sed -i 's#database = .*#database = mydns#g' /etc/mydns.conf 
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;mydnsconfig&quot;&gt;安装MyDNSConfig&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;tar xf MyDNSConfig-1.1.0.tar.gz &amp;amp;&amp;amp; cd MyDNSConfig-1.1.0 
mkdir /usr/share/mydnsconfig
cp -rf interface/* /usr/share/mydnsconfig/
ln -s /usr/share/mydnsconfig/web/ /usr/local/nginx/html/mydnsconfig
mysql -u mydns -p  mydns &amp;lt; install/mydnsconfig.sql 
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h2 id=&quot;mydnsconfig-1&quot;&gt;配置MyDNSConfig&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;vim /usr/share/mydnsconfig/lib/config.inc.php
*/

$conf[“db_type”]        = 'mysql';
$conf[“db_host”]        = 'localhost';    –&amp;gt;  keep as it
$conf[“db_database”]    = 'mydns';
$conf[“db_user”]        = 'mydns';
$conf[“db_password”]    = 'mydns_password';

/*
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;hr /&gt;

&lt;h2 id=&quot;web&quot;&gt;访问web页面&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;http://192.168.1.145/mydnsconfig/&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;Username: admin&lt;/li&gt;
  &lt;li&gt;Password: admin&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;p&gt;end&lt;/p&gt;

</description>
        <pubDate>Thu, 28 Sep 2017 00:00:00 +0800</pubDate>
        <link>/dns/Mydns.html</link>
        <guid isPermaLink="true">/dns/Mydns.html</guid>
        
        
        <category>DNS</category>
        
      </item>
    
      <item>
        <title>Kibana</title>
        <description>&lt;h2 id=&quot;kibana&quot;&gt;安装kibana&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;wget https://download.elastic.co/kibana/kibana/kibana-4.6.6-linux-x86_64.tar.gz
tar xf kibana-4.6.6-linux-x86_64.tar.gz -C /usr/local/
ln -s /usr/local/kibana-4.6.6-linux-x86_64 /usr/local/kibana
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h2 id=&quot;kibana-1&quot;&gt;配置kibana&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mv /usr/local/kibana/config/kibana.yml /usr/local/kibana/config/kibana.yml.bak
cat &amp;gt;config/kibana.yml&amp;lt;&amp;lt;EOF
 server.host: &quot;0.0.0.0&quot;
 elasticsearch.url: &quot;http://192.168.1.190:9200&quot;
 elasticsearch.username: &quot;kibana&quot;
 elasticsearch.password: &quot;kibana@123&quot;
EOF
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;如果es添加了认证，则需要去es上为kibana添加链接用户&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;cd /usr/local/elasticsearch
./bin/shield/esusers useradd kibana -r kibana4_server
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;添加supervisor守护kibana进程&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;cat &amp;gt;/etc/supervisor/conf/kibana.ini&amp;lt;&amp;lt;EOF
[program:Kibana]
command = /usr/local/kibana/bin/kibana
autostart = true
autorestart = true
startsecs = 3
startretries = 3
stopwaitsecs = 5
user = root
redirect_stderr = true
stdout_logfile = /var/log/supervisor/kibana.log
stdout_logfile_maxbytes = 500MB
stdout_logfile_backups = 0
EOF
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;h2 id=&quot;kibana-2&quot;&gt;启动kibana服务&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;supervisorctl update&lt;/p&gt;
&lt;/blockquote&gt;

&lt;hr /&gt;

&lt;p&gt;end&lt;/p&gt;

</description>
        <pubDate>Thu, 21 Sep 2017 00:00:00 +0800</pubDate>
        <link>/bigdata/Kibana.html</link>
        <guid isPermaLink="true">/bigdata/Kibana.html</guid>
        
        
        <category>BigData</category>
        
      </item>
    
      <item>
        <title>Elasticsearch</title>
        <description>&lt;h2 id=&quot;section&quot;&gt;架构原理&lt;/h2&gt;

&lt;h3 id=&quot;segment-buffer-translog&quot;&gt;segment buffer translog&lt;/h3&gt;

&lt;h3 id=&quot;segment-merge&quot;&gt;segment merge&lt;/h3&gt;

&lt;h3 id=&quot;routing-replica&quot;&gt;routing replica&lt;/h3&gt;

&lt;h3 id=&quot;shard&quot;&gt;shard&lt;/h3&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;elasticsearch&quot;&gt;安装 elasticsearch&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;useradd elasticsearch -M -s /sbin/nologin
https://download.elastic.co/elasticsearch/release/org/elasticsearch/distribution/tar/elasticsearch/2.4.6/elasticsearch-2.4.6.tar.gz
tar xf elasticsearch-2.4.6.tar.gz -C /usr/local/
chown -R elasticsearch: /usr/local/elasticsearch-2.4.6
ln -s /usr/local/elasticsearch-2.4.6 /usr/local/elasticsearch
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h2 id=&quot;plugin&quot;&gt;安装 plugin&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;cd /usr/local/elasticsearch
./bin/plugin install mobz/elasticsearch-head
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h2 id=&quot;elasticsearch-cluster&quot;&gt;配置 elasticsearch cluster&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mv /usr/local/elasticsearch/config/elasticsearch.yml /usr/local/elasticsearch/config/elasticsearch.yml.bak
cat &amp;gt;/usr/local/elasticsearch/config/elasticsearch.yml &amp;lt;&amp;lt;EOF
 cluster.name: robin_test_cluster
 node.name: xxxxYour Hostname	
 network.host: 0.0.0.0
 index.number_of_shards 5
 index.number_of_replicas 2
 discovery.zen.minimum_master_nodes: 3
 discovery.zen.ping_timeout: 100s
 discovery.zen.fd.ping_timeout: 100s
 discovery.zen.ping.multicast.enabled: false
 discovery.zen.ping.unicast.hosts: [&quot;192.168.1.190&quot;,&quot;192.168.1.191&quot;,&quot;192.168.1.192&quot;]
EOF
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h2 id=&quot;supervisor-&quot;&gt;Supervisor 守护&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;cat &amp;gt;/etc/supervisor/conf/elasticsearch.ini &amp;lt;&amp;lt;EOF
[program:Elasticsearch]
command = /usr/local/elasticsearch/bin/elasticsearch
autostart = true
autorestart = true
startsecs = 3
startretries = 3
stopwaitsecs = 5
user = elasticsearch
redirect_stderr = true
stdout_logfile = /var/log/supervisor/elasticsearch.log
stdout_logfile_maxbytes = 500MB
stdout_logfile_backups = 0
EOF
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h3 id=&quot;es&quot;&gt;启动es服务&lt;/h3&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;supervisorctl update
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h3 id=&quot;section-1&quot;&gt;服务验证&lt;/h3&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;netstat -lntup|grep 9200
netstat -lntup|grep 9300
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl 'http://localhost:9200/?pretty'
{
  &quot;name&quot; : &quot;Abner Little&quot;,
  &quot;cluster_name&quot; : &quot;RobinES&quot;,
  &quot;cluster_uuid&quot; : &quot;qFXwzSfgRvSVv8EhJmeSlQ&quot;,
  &quot;version&quot; : {
    &quot;number&quot; : &quot;2.4.6&quot;,
    &quot;build_hash&quot; : &quot;5376dca9f70f3abef96a77f4bb22720ace8240fd&quot;,
    &quot;build_timestamp&quot; : &quot;2017-07-18T12:17:44Z&quot;,
    &quot;build_snapshot&quot; : false,
    &quot;lucene_version&quot; : &quot;5.5.4&quot;
  },
  &quot;tagline&quot; : &quot;You Know, for Search&quot;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;elasticsearch-1&quot;&gt;Elasticsearch日常操作&lt;/h2&gt;

&lt;h3 id=&quot;section-2&quot;&gt;增&lt;/h3&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XPOST http://localhost:9200/logstash-2015.06.21/testlog -d '{&quot;date&quot; : &quot;1434966686000&quot;,&quot;user&quot; : &quot;chenlin7&quot;,&quot;mesg&quot; : &quot;first message into Elasticsearch&quot;}'
{&quot;_index&quot;:&quot;logstash-2015.06.21&quot;,&quot;_type&quot;:&quot;testlog&quot;,&quot;_id&quot;:&quot;AV6eVtpCdKKfa5USSXuh&quot;,&quot;_version&quot;:1,&quot;_shards&quot;:{&quot;total&quot;:2,&quot;successful&quot;:2,&quot;failed&quot;:0},&quot;created&quot;:true}
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h3 id=&quot;section-3&quot;&gt;查&lt;/h3&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XGET http://127.0.0.1:9200/logstash-2015.06.21/testlog/AV6eVtpCdKKfa5USSXuh?pretty
{
  &quot;_index&quot; : &quot;logstash-2015.06.21&quot;,
  &quot;_type&quot; : &quot;testlog&quot;,
  &quot;_id&quot; : &quot;AV6eVtpCdKKfa5USSXuh&quot;,
  &quot;_version&quot; : 1,
  &quot;found&quot; : true,
  &quot;_source&quot; : {
    &quot;date&quot; : &quot;1434966686000&quot;,
    &quot;user&quot; : &quot;chenlin7&quot;,
    &quot;mesg&quot; : &quot;first message into Elasticsearch&quot;
  }
}

curl -XGET http://127.0.0.1:9200/logstash-2015.06.21/testlog/AV6eVtpCdKKfa5USSXuh/_source?pretty
{
  &quot;date&quot; : &quot;1434966686000&quot;,
  &quot;user&quot; : &quot;chenlin7&quot;,
  &quot;mesg&quot; : &quot;first message into Elasticsearch&quot;
}

curl -XGET 'http://127.0.0.1:9200/logstash-2015.06.21/testlog/AV6eVtpCdKKfa5USSXuh?fields=user,mesg&amp;amp;pretty'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h3 id=&quot;section-4&quot;&gt;改&lt;/h3&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XPOST http://localhost:9200/logstash-2015.06.21/testlog/AV6eVtpCdKKfa5USSXuh/_update -d '{&quot;doc&quot;: {&quot;date&quot; : &quot;1111111111111&quot;,&quot;user&quot; : &quot;someone&quot;,&quot;mesg&quot; : &quot;first message into Elasticsearch&quot;}}'
curl -XPOST http://localhost:9200/logstash-2015.06.21/testlog/AV6eVtpCdKKfa5USSXuh -d '{&quot;date&quot; : &quot;2222222222&quot;,&quot;user&quot; : &quot;Robin&quot;,&quot;mesg&quot; : &quot;first message into Elasticsearch version 2&quot;}'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h3 id=&quot;section-5&quot;&gt;删&lt;/h3&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XDELETE http://localhost:9200/logstash-2015.06.21/testlog/AV6eVtpCdKKfa5USSXuh
curl -XDELETE http://localhost:9200/logstash-2015.06*
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;hr /&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;上面都是对单条数据的操作；下面开始做全文搜索和聚合请求&lt;/code&gt;&lt;/p&gt;

&lt;h2 id=&quot;section-6&quot;&gt;全文搜索&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XPOST http://localhost:9200/logstash-2015.06.21/testlog -d '{&quot;date&quot; : &quot;1110&quot;,&quot;user&quot; : &quot;Robin&quot;,&quot;mesg&quot; : &quot;first message into Elasticsearch&quot;}'
curl -XGET http://127.0.0.1:9200/logstash-2015.06.21/testlog/_search?q=first
curl -XGET http://127.0.0.1:9200/logstash-2015.06.21/testlog/_search?q=mesg:first
curl -XGET http://127.0.0.1:9200/logstash-2015.06.21/testlog/_search?q=user:&quot;Robin&quot;
curl -XGET http://127.0.0.1:9200/logstash-2015.06.21/testlog/_search?q=_exists_:user
curl -XGET http://127.0.0.1:9200/logstash-2015.06.21/testlog/_search?q=_missing_:user
curl -XGET http://127.0.0.1:9200/logstash-2015.06.21/testlog/_search?q=user:&quot;chenlin?&quot;
curl -XGET http://127.0.0.1:9200/logstash-2015.06.21/testlog/_search?q=frist~
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h2 id=&quot;section-7&quot;&gt;聚合请求&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;下载测试数据&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;wget http://wangrubin.com/testfile/accounts.json
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;测试数据样例&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&quot;account_number&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;372&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&quot;balance&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;28566&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&quot;firstname&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Alba&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&quot;lastname&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Forbes&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&quot;age&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&quot;gender&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;M&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&quot;address&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;814 Meserole Avenue&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&quot;employer&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Isostream&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&quot;email&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;albaforbes@isostream.com&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&quot;city&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Clarence&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&quot;state&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;OR&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;写入测试数据到es中&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XPOST 'localhost:9200/bank/account/_bulk?pretty' --data-binary  @accounts.json
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;验证是否写入成功&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl 'localhost:9200/_cat/indices?v'
health status index               pri rep docs.count docs.deleted store.size pri.store.size 
green  open   logstash-2017.09.20   5   1          1            0      8.4kb          4.2kb 
green  open   bank                  5   1       1000            0    925.2kb        456.9kb 
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;搜索全部的文档&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XPOST 'localhost:9200/bank/_search?pretty' -d '
{
  &quot;query&quot;: { &quot;match_all&quot;: {} }
}'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;搜索back索引下第一条数据&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XPOST 'localhost:9200/bank/_search?pretty' -d '
{
  &quot;query&quot;: { &quot;match_all&quot;: {} },
  &quot;size&quot;: 1
}'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;下面的命令请求了第10-20的文档&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XPOST 'localhost:9200/bank/_search?pretty' -d '
{
  &quot;query&quot;: { &quot;match_all&quot;: {} },
  &quot;from&quot;: 10,
  &quot;size&quot;: 10
}'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;指定了返回特定的字段&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XPOST 'localhost:9200/bank/_search?pretty' -d '
{
  &quot;query&quot;: { &quot;match_all&quot;: {} },
  &quot;_source&quot;: [&quot;account_number&quot;, &quot;balance&quot;]
}'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;返回特定的字段&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XPOST 'localhost:9200/bank/_search?pretty' -d '
{
  &quot;query&quot;: { &quot;match&quot;: { &quot;account_number&quot;: 20 } }
}'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;查询地址为mill的信息&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XPOST 'localhost:9200/bank/_search?pretty' -d '
{
  &quot;query&quot;: { &quot;match&quot;: { &quot;address&quot;: &quot;mill&quot; } }
}'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;查询地址为mill或者lane的信息&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XPOST 'localhost:9200/bank/_search?pretty' -d '
{
  &quot;query&quot;: { &quot;match&quot;: { &quot;address&quot;: &quot;mill lane&quot; } }
}'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;如果我们想要返回同时包含mill和lane的，可以通过match_phrase查询&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XPOST 'localhost:9200/bank/_search?pretty' -d '
{
  &quot;query&quot;: { &quot;match_phrase&quot;: { &quot;address&quot;: &quot;mill lane&quot; } }
}'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;比如查询同时包含mill和lane的文档&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XPOST 'localhost:9200/bank/_search?pretty' -d '
{
  &quot;query&quot;: {
    &quot;bool&quot;: {
      &quot;must&quot;: [
        { &quot;match&quot;: { &quot;address&quot;: &quot;mill&quot; } },
        { &quot;match&quot;: { &quot;address&quot;: &quot;lane&quot; } }
      ]
    }
  }
}'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;查询包含mill或者lane的文档&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XPOST 'localhost:9200/bank/_search?pretty' -d '
{
  &quot;query&quot;: {
    &quot;bool&quot;: {
      &quot;should&quot;: [
        { &quot;match&quot;: { &quot;address&quot;: &quot;mill&quot; } },
        { &quot;match&quot;: { &quot;address&quot;: &quot;lane&quot; } }
      ]
    }
  }
}'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;排除包含mill和lane的文档&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XPOST 'localhost:9200/bank/_search?pretty' -d '
{
  &quot;query&quot;: {
    &quot;bool&quot;: {
      &quot;must_not&quot;: [
        { &quot;match&quot;: { &quot;address&quot;: &quot;mill&quot; } },
        { &quot;match&quot;: { &quot;address&quot;: &quot;lane&quot; } }
      ]
    }
  }
}'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;bool查询可以同时使用must, should, must_not组成一个复杂的查询&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XPOST 'localhost:9200/bank/_search?pretty' -d '
{
  &quot;query&quot;: {
    &quot;bool&quot;: {
      &quot;must&quot;: [
        { &quot;match&quot;: { &quot;age&quot;: &quot;40&quot; } }
      ],
      &quot;must_not&quot;: [
        { &quot;match&quot;: { &quot;state&quot;: &quot;ID&quot; } }
      ]
    }
  }
}'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;查询在2000-3000范围内的所有文档&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XPOST 'localhost:9200/bank/_search?pretty' -d '
{
  &quot;query&quot;: {
    &quot;bool&quot;: {
      &quot;must&quot;: { &quot;match_all&quot;: {} },
      &quot;filter&quot;: {
        &quot;range&quot;: {
          &quot;balance&quot;: {
            &quot;gte&quot;: 20000,
            &quot;lte&quot;: 30000
          }
        }
      }
    }
  }
}'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;数据聚合统计&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XPOST 'localhost:9200/bank/_search?pretty' -d '
{
  &quot;size&quot;: 0,
  &quot;aggs&quot;: {
    &quot;group_by_state&quot;: {
      &quot;terms&quot;: {
        &quot;field&quot;: &quot;state&quot;
      }
    }
  }
}'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;统计不同账户状态下的平均余额&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XPOST 'localhost:9200/bank/_search?pretty' -d '
{
  &quot;size&quot;: 0,
  &quot;aggs&quot;: {
    &quot;group_by_state&quot;: {
      &quot;terms&quot;: {
        &quot;field&quot;: &quot;state&quot;
      },
      &quot;aggs&quot;: {
        &quot;average_balance&quot;: {
          &quot;avg&quot;: {
            &quot;field&quot;: &quot;balance&quot;
          }
        }
      }
    }
  }
}'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;先按范围分组，在统计不同性别的账户余额&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XPOST 'localhost:9200/bank/_search?pretty' -d '
{
  &quot;size&quot;: 0,
  &quot;aggs&quot;: {
    &quot;group_by_age&quot;: {
      &quot;range&quot;: {
        &quot;field&quot;: &quot;age&quot;,
        &quot;ranges&quot;: [
          {
            &quot;from&quot;: 20,
            &quot;to&quot;: 30
          },
          {
            &quot;from&quot;: 30,
            &quot;to&quot;: 40
          },
          {
            &quot;from&quot;: 40,
            &quot;to&quot;: 50
          }
        ]
      },
      &quot;aggs&quot;: {
        &quot;group_by_gender&quot;: {
          &quot;terms&quot;: {
            &quot;field&quot;: &quot;gender&quot;
          },
          &quot;aggs&quot;: {
            &quot;average_balance&quot;: {
              &quot;avg&quot;: {
                &quot;field&quot;: &quot;balance&quot;
              }
            }
          }
        }
      }
    }
  }
}'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;模拟统计生产环境的每小时日志量&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/usr/bin/env bash&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1
&lt;span class=&quot;k&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;((&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$int&lt;/span&gt;&amp;lt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1000 &lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;do
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;date +%Y&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;date +%m&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;date +%d&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;h&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;date +%H&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;M&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;date +%M&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;date +%S&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
cat &amp;gt;&amp;gt;/root/elasticsearch.json&lt;span class=&quot;sh&quot;&gt;&amp;lt;&amp;lt;EOF
{&quot;index&quot;:{&quot;_id&quot;:&quot;$int&quot;}}
{&quot;account_number&quot;:1,&quot;balance&quot;:39225,&quot;firstname&quot;:&quot;Amber&quot;,&quot;lastname&quot;:&quot;Duke&quot;,&quot;age&quot;:32,&quot;gender&quot;:&quot;M&quot;,&quot;address&quot;:&quot;880 Holmes Lane&quot;,&quot;employer&quot;:&quot;Pyrami&quot;,&quot;email&quot;:&quot;amberduke@pyrami.com&quot;,&quot;city&quot;:&quot;Brogan&quot;,&quot;state&quot;:&quot;IL&quot;,&quot;localtime&quot;:&quot;${d}/${m}/${y}:${h}:${M}:${s} +0800&quot;}
EOF
&lt;/span&gt;sleep 3
&lt;span class=&quot;nb&quot;&gt;let &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;int+1
&lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XPOST 'localhost:9200/wangrubin-2017-09-21/account/_bulk?pretty' --data-binary  @elasticsearch.json
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XPOST 'localhost:9200/wangrubin*/_search?pretty' -d '
{
  &quot;query&quot;: { &quot;match_phrase&quot;: { &quot;localtime&quot;: &quot;21 09 2017 12&quot; } },
  &quot;size&quot;: 0
}'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;reindex&quot;&gt;Reindex&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XPOST http://localhost:9200/_reindex -d '
{
  &quot;source&quot;: {
    &quot;index&quot;: &quot;logstash-2015.06.21&quot;
  },
  &quot;dest&quot;: {
    &quot;index&quot;: &quot;logstash-2017.09.20&quot;
  }
}'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;经过测试这功能就像 cp src dst&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;section-8&quot;&gt;性能优化&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pip install elasticsearch-curator
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curator --timeout 36000 --host 10.0.0.100 delete indices --older-than 5 --time-unit days --timestring '%Y.%m.%d' --prefix logstash-mweibo-nginx-
curator --timeout 36000 --host 10.0.0.100 delete indices --older-than 10 --time-unit days --timestring '%Y.%m.%d' --prefix logstash-mweibo-client- --exclude 'logstash-mweibo-client-2015.05.11'
curator --timeout 36000 --host 10.0.0.100 delete indices --older-than 30 --time-unit days --timestring '%Y.%m.%d' --regex '^logstash-mweibo-\d+'
curator --timeout 36000 --host 10.0.0.100 close indices --older-than 7 --time-unit days --timestring '%Y.%m.%d' --prefix logstash-
curator --timeout 36000 --host 10.0.0.100 optimize --max_num_segments 1 indices --older-than 1 --newer-than 7 --time-unit days --timestring '%Y.%m.%d' --prefix logstash-
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;logstash-mweibo-nginx-yyyy.mm.dd 索引保存最近 5 天&lt;/p&gt;

&lt;p&gt;logstash-mweibo-client-yyyy.mm.dd 保存最近 10 天&lt;/p&gt;

&lt;p&gt;logstash-mweibo-yyyy.mm.dd 索引保存最近 30 天&lt;/p&gt;

&lt;p&gt;所有七天前的 logstash-* 索引都暂时关闭不用&lt;/p&gt;

&lt;p&gt;最后对所有非当日日志做 segment 合并优化。&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;section-9&quot;&gt;访问控制&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;安装插件&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;cd /usr/local/elasticsearch
./bin/plugin install elasticsearch/license/latest
./bin/plugin install elasticsearch/shield/latest
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;重启es&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;supervisorctl restart Elasticsearch
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;创建用户&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;./bin/shield/esusers useradd elasticsearch -r admin
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;查看用户列表&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;./bin/shield/esusers list
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;修改用户密码&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;./bin/shield/esusers passwd root
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;删除用户&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;./bin/shield/esusers userdel root
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;查看所有可用命令&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;./bin/shield/esusers -h
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;es-1&quot;&gt;es集群监控&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;集群层面监控&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -u elasticsearch:xiaoaojianghu -XGET '127.0.0.1:9200/_cluster/health?pretty'
{
  &quot;cluster_name&quot; : &quot;robin_test_cluster&quot;,
  &quot;status&quot; : &quot;green&quot;,
  &quot;timed_out&quot; : false,
  &quot;number_of_nodes&quot; : 3,
  &quot;number_of_data_nodes&quot; : 3,
  &quot;active_primary_shards&quot; : 1,
  &quot;active_shards&quot; : 2,
  &quot;relocating_shards&quot; : 0,
  &quot;initializing_shards&quot; : 0,
  &quot;unassigned_shards&quot; : 0,
  &quot;delayed_unassigned_shards&quot; : 0,
  &quot;number_of_pending_tasks&quot; : 0,
  &quot;number_of_in_flight_fetch&quot; : 0,
  &quot;task_max_waiting_in_queue_millis&quot; : 0,
  &quot;active_shards_percent_as_number&quot; : 100.0
}
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;索引层面监控&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -u elasticsearch:xiaoaojianghu -XGET '127.0.0.1:9200/_cluster/health?level=indices&amp;amp;pretty'
{
  &quot;cluster_name&quot; : &quot;robin_test_cluster&quot;,
  &quot;status&quot; : &quot;green&quot;,
  &quot;timed_out&quot; : false,
  &quot;number_of_nodes&quot; : 3,
  &quot;number_of_data_nodes&quot; : 3,
  &quot;active_primary_shards&quot; : 1,
  &quot;active_shards&quot; : 2,
  &quot;relocating_shards&quot; : 0,
  &quot;initializing_shards&quot; : 0,
  &quot;unassigned_shards&quot; : 0,
  &quot;delayed_unassigned_shards&quot; : 0,
  &quot;number_of_pending_tasks&quot; : 0,
  &quot;number_of_in_flight_fetch&quot; : 0,
  &quot;task_max_waiting_in_queue_millis&quot; : 0,
  &quot;active_shards_percent_as_number&quot; : 100.0,
  &quot;indices&quot; : {
    &quot;.kibana&quot; : {
      &quot;status&quot; : &quot;green&quot;,
      &quot;number_of_shards&quot; : 1,
      &quot;number_of_replicas&quot; : 1,
      &quot;active_primary_shards&quot; : 1,
      &quot;active_shards&quot; : 2,
      &quot;relocating_shards&quot; : 0,
      &quot;initializing_shards&quot; : 0,
      &quot;unassigned_shards&quot; : 0
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;节点层面监控&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -u elasticsearch:xiaoaojianghu -XGET 127.0.0.1:9200/_nodes/stats?pretty
curl -u elasticsearch:xiaoaojianghu -XGET 'http://127.0.0.1:9200/_nodes/_local/hot_threads?interval=60s'
curl -u elasticsearch:xiaoaojianghu -XGET 'http://127.0.0.1:9200/_nodes/_local/hot_threads?type=wait&amp;amp;interval=60s'
curl -u elasticsearch:xiaoaojianghu -XGET 'http://127.0.0.1:9200/_nodes/_local/hot_threads?type=block&amp;amp;interval=60s'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;查看集群等待任务数&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -u elasticsearch:xiaoaojianghu  -XGET 'http://127.0.0.1:9200/_cluster/pending_tasks?pretty'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;shell中获取状态&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;* /_cat/nodes
* /_cat/shards
* /_cat/shards/{index}
* /_cat/aliases
* /_cat/aliases/{alias}
* /_cat/tasks
* /_cat/master
* /_cat/plugins
* /_cat/fielddata
* /_cat/fielddata/{fields}
* /_cat/pending_tasks
* /_cat/count
* /_cat/count/{index}
* /_cat/snapshots/{repository}
* /_cat/recovery
* /_cat/recovery/{index}
* /_cat/segments
* /_cat/segments/{index}
* /_cat/thread_pool
* /_cat/thread_pool/{thread_pools}/_cat/nodeattrs
* /_cat/allocation
* /_cat/repositories
* /_cat/health
* /_cat/indices
* /_cat/indices/{index}
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -u elasticsearch:xiaoaojianghu  -XGET 'http://127.0.0.1:9200//_cat/nodes'
192.168.1.191 192.168.1.191 5 37 0.01 d * hadoop-slave01 
192.168.1.192 192.168.1.192 6 32 0.00 d m hadoop-slave02 
192.168.1.190 192.168.1.190 5 43 0.00 d m hadoop-master
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -u elasticsearch:xiaoaojianghu  -XGET 'http://127.0.0.1:9200/_cat/health'
1506059940 13:59:00 robin_test_cluster green 3 3 12 6 0 0 0 0 - 100.0% 
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -u elasticsearch:xiaoaojianghu  -XGET 'http://127.0.0.1:9200/_cat/nodes?v'
host          ip            heap.percent ram.percent load node.role master name           
192.168.1.191 192.168.1.191            5          37 0.00 d         *      hadoop-slave01 
192.168.1.192 192.168.1.192            6          32 0.00 d         m      hadoop-slave02 
192.168.1.190 192.168.1.190            5          43 0.00 d         m      hadoop-master
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -u elasticsearch:xiaoaojianghu  -XGET 'http://127.0.0.1:9200/_cat/nodes?v&amp;amp;h=ip,port,heapPercent,heapMax'
ip            port heapPercent  heapMax 
192.168.1.191 9300           5 1015.6mb 
192.168.1.192 9300           6 1015.6mb 
192.168.1.190 9300           5 1015.6mb 
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -u elasticsearch:xiaoaojianghu  -XGET 'http://127.0.0.1:9200/_cat/nodes?help'

id                               | id,nodeId                          | unique node id                                                                                                   
pid                              | p                                  | process id                                                                                                       
host                             | h                                  | host name                                                                                                        
ip                               | i                                  | ip address                                                                                                       
port                             | po                                 | bound transport port                                                                                             
version                          | v                                  | es version                                                                                                       
build                            | b                                  | es build hash         
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XGET http://127.0.0.1:9200/_cat/nodes?v&amp;amp;h=i,po,hp,hm
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;查看索引分片状态&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -u elasticsearch:xiaoaojianghu  -XGET 'http://127.0.0.1:9200/_cat/shards?v'  
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;查看当前数据恢复状态&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -u elasticsearch:xiaoaojianghu  -XGET 'http://127.0.0.1:9200/_cat/recovery?active_only&amp;amp;v&amp;amp;h=i,s,shost,thost,fp,bp,tr,trp,trt'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;线程池状态&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -u elasticsearch:xiaoaojianghu  -XGET 'http://127.0.0.1:9200/_cat/thread_pool?v'     
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;hr /&gt;

&lt;p&gt;end&lt;/p&gt;
</description>
        <pubDate>Thu, 21 Sep 2017 00:00:00 +0800</pubDate>
        <link>/bigdata/Elasticsearch.html</link>
        <guid isPermaLink="true">/bigdata/Elasticsearch.html</guid>
        
        
        <category>BigData</category>
        
      </item>
    
      <item>
        <title>supervisor进程守护</title>
        <description>&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mkdir -p /etc/supervisor/conf
mkdir -p /var/log/supervisor
yum install python-setuptools-devel
easy_install supervisor
echo_supervisord_conf &amp;gt; /etc/supervisor/supervisord.conf.bak
cat &amp;gt;/etc/supervisor/supervisord.conf&amp;lt;&amp;lt;EOF
[unix_http_server]
file=/var/run/supervisor.sock   ; the path to the socket file
[supervisord]
logfile=/var/log/supervisor/supervisord.log ; main log file; default $CWD/supervisord.log
logfile_maxbytes=50MB        ; max main logfile bytes b4 rotation; default 50MB
logfile_backups=10           ; # of main logfile backups; 0 means none, default 10
loglevel=info                ; log level; default info; others: debug,warn,trace
pidfile=/var/run/supervisord.pid ; supervisord pidfile; default supervisord.pid
nodaemon=false               ; start in foreground if true; default false
minfds=65535                  ; min. avail startup file descriptors; default 1024
minprocs=65535                 ; min. avail process descriptors;default 200
[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface
[supervisorctl]
serverurl=unix:///var/run/supervisor.sock ; use a unix:// URL  for a unix socket
[include]
files = /etc/supervisor/conf/*.ini
EOF
supervisord -c /etc/supervisor/supervisord.conf
echo &quot;supervisord -c /etc/supervisor/supervisord.conf&quot; &amp;gt;&amp;gt;/etc/rc.local 
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;hr /&gt;

&lt;p&gt;end&lt;/p&gt;
</description>
        <pubDate>Wed, 20 Sep 2017 00:00:00 +0800</pubDate>
        <link>/point/supervisor.html</link>
        <guid isPermaLink="true">/point/supervisor.html</guid>
        
        
        <category>Point</category>
        
      </item>
    
      <item>
        <title>Logstash</title>
        <description>&lt;h2 id=&quot;install-java-env&quot;&gt;Install JAVA ENV&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;wget -c --header &quot;Cookie: oraclelicense=accept-securebackup-cookie&quot; http://download.oracle.com/otn-pub/java/jdk/8u131-b11/d54c1d3a095b4ff2b6607d096fa80163/jdk-8u131-linux-x64.tar.gz
tar xf jdk-8u131-linux-x64.tar.gz -C /usr/local/
cat &amp;gt;&amp;gt; /etc/profile &amp;lt;&amp;lt;EOF
export JAVA_HOME=/usr/local/jdk1.8.0_131
export CLASSPATH=.:\$JAVA_HOME/lib/dt.jar:\$JAVA_HOME/lib/tools.jar
export PATH=\$JAVA_HOME/bin:\$PATH
EOF
source /etc/profile
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;install-logstash&quot;&gt;Install Logstash&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;wget https://download.elastic.co/logstash/logstash/logstash-2.4.0.tar.gz
tar xf logstash-2.4.0.tar.gz -C /usr/local/
ln -s /usr/local/logstash-2.4.0 /usr/local/logstash
sed -i 's#source.*#source &quot;https://ruby.taobao.org/&quot;#g' /usr/local/logstash/Gemfile
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;install-plugin&quot;&gt;Install Plugin&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;cd /usr/local/logstash
./bin/logstash-plugin install logstash-input-elasticsearch
./bin/logstash-plugin install logstash-output-elasticsearch
./bin/logstash-plugin install logstash-input-kafka
./bin/logstash-plugin install logstash-output-kafka
./bin/logstash-plugin install logstash-output-webhdfs
./bin/logstash-plugin list|egrep &quot;kafka|webhdfs|elasticsearch&quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;configure-logstash&quot;&gt;Configure Logstash&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;mkdir /usr/local/logstash/conf/&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;File –&amp;gt; Kafka/File&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;#
input {
    file {
        path =&amp;gt; [&quot;/$PATH/**/*access.log&quot;]
        sincedb_path =&amp;gt; &quot;/$PATH/logstash/sincedb&quot;
        start_position =&amp;gt; &quot;beginning&quot;
		codec =&amp;gt; &quot;plain&quot;
        discover_interval =&amp;gt; 10
        close_older =&amp;gt; 3600
        ignore_older =&amp;gt; 86400
        sincedb_write_interval =&amp;gt; 5
        stat_interval =&amp;gt; 1
    }
}

output {
    kafka {
        bootstrap_servers =&amp;gt; &quot;test-kafka00:9092,test-kafka01:9092,test-kafka02:9092&quot;
        topic_id =&amp;gt; &quot;test_topic&quot;
        codec =&amp;gt; plain {
                        format =&amp;gt; &quot;%{message}&quot;
                }
    }
    file {
        path =&amp;gt; &quot;/home/mtime/logs/accesslog/vip.mtime.com/from_kafka.log&quot;
        message_format =&amp;gt; &quot;%{message}&quot;
    }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;sincedb_path: sincedb存放位置；用于记录文件读取的偏移量&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;start_position: 在没有sincedb记录的前提下；默认从文件尾部开始读取（tail -f）；beginning 从头读取&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;codec: plain表示文本模式；json表示按照json格式处理&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;discover_interval: 没隔多久检测一次被监听目录下是否有新文件生成&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;close_older: 默认3600s文件没有变化时；释放文件监听句柄&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;ignore_older: 如果一个文件的最后修改时间超过这个值就忽略这个文件；默认是86400s（1day）&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;sincedb_write_interval: 每隔多久写一次sincedb记录；关系到丢失数据的容忍度；不推荐太大&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;stat_interval: 每隔多久检查一次被监听文件状态是否有更新；默认1s&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;message_format: logstash-output-file插件无法使用codec插件；所以用此参数；&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;%{message}: 获取原始的日志内容；不添加任何多余字段；&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;Kafka –&amp;gt; ES&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;#
input {
    kafka {
        zk_connect =&amp;gt; &quot;zookeeper01:2181,zookeeper03:2181,zookeeper03:2181&quot;
        group_id =&amp;gt; &quot;logstash-kafka-es&quot;
        topic_id =&amp;gt; &quot;test_kafka&quot;
        codec =&amp;gt; plain
        reset_beginning =&amp;gt; false
        consumer_threads =&amp;gt; 4
        decorate_events =&amp;gt; false
    }
}

filter {
        grok {
                match =&amp;gt; {
                        &quot;message&quot; =&amp;gt; &quot;^(?&amp;lt;hostname&amp;gt;.+?)\s(?&amp;lt;modulname&amp;gt;.+?)\s(?&amp;lt;remote_addr&amp;gt;.+?)\s\-\s(?&amp;lt;remote_user&amp;gt;.+?)\s\[(?&amp;lt;localtime&amp;gt;.+?)\]\s\&quot;(?&amp;lt;request&amp;gt;.+?)\&quot;\s(?&amp;lt;status&amp;gt;.+?)\s(?&amp;lt;body_bytes_sent&amp;gt;.+?)\s\&quot;(?&amp;lt;http_referer&amp;gt;.+?)\&quot;\s\&quot;(?&amp;lt;http_user_agent&amp;gt;.+?)\&quot;\s\&quot;(?&amp;lt;http_x_forwarded_for&amp;gt;.+?)\&quot;\s\&quot;(?&amp;lt;upstream_addr&amp;gt;.+?)\&quot;\s\&quot;(?&amp;lt;upstream_response_time&amp;gt;.+?)\&quot;\s\&quot;(?&amp;lt;request_time&amp;gt;.+?)\&quot;\s\&quot;(?&amp;lt;http_cookie&amp;gt;.+?)\&quot;&quot;
                }
        }
        mutate {
                convert =&amp;gt; [
                &quot;status&quot;, &quot;integer&quot;,
                &quot;body_bytes_sent&quot; , &quot;integer&quot;,
                &quot;upstream_response_time&quot;, &quot;float&quot;,
                &quot;request_time&quot;, &quot;float&quot;
                ]
        }
}

output {
        if [modulname] {
           elasticsearch {
                workers =&amp;gt; 2
                hosts =&amp;gt; [&quot;elasticsearch01:9210&quot;,&quot;1elasticsearch02:9210&quot;,&quot;elasticsearch03:9210&quot;]
                index =&amp;gt; &quot;logstash-%{modulname}-%{+YYYY.MM.dd}&quot;
                flush_size =&amp;gt; 10000
                idle_flush_time =&amp;gt; 60
                template_overwrite =&amp;gt; true
            }
        } else {
           file {
                path =&amp;gt; &quot;/$PATH/logstash/logstash_kafka_es_error.log&quot;
                message_format =&amp;gt; &quot;%{message}&quot;
           }
        }
        stdout{codec =&amp;gt; rubydebug}
}
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;group_id: 消费者分组 可以通过组ID去指定,不同的组之间消费是相互不受影响的,相互隔离&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;topic_id: 指定消费某个topic&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;reset_beginning: logstash启动后从什么位置开始读取数据；默认是结束位置；如果要导入原有数据；将此值设置为true&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;decorate_events: 输出自身一些消息；类似消费消息大小；topic来源等信息；你默认false&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;rebalance_max_retries: 注册节点的重试次数；多个logstash消费同一个topic；需要向zk注册partitons归属于哪个logstash消费；&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;grok: 用正则表达式将纯文本内容变成json格式&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;mutate: 更改json格式中指定key的value的字符类型；integer整数 string字符串 float浮点数&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;Kafka –&amp;gt; HDFS&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;#
input {
    kafka {
        zk_connect =&amp;gt; &quot;zookeeper01:2181,zookeeper03:2181,zookeeper03:2181&quot;
        group_id =&amp;gt; &quot;test_kafka&quot;
        topic_id =&amp;gt; &quot;test_kafka_id&quot;
        codec =&amp;gt; plain
        reset_beginning =&amp;gt; false
        consumer_threads =&amp;gt; 4
        decorate_events =&amp;gt; false
    }
}

filter {
        grok {
                match =&amp;gt; {
                        &quot;message&quot; =&amp;gt;&quot;^(?&amp;lt;hostname&amp;gt;.+?)\s(?&amp;lt;modulname&amp;gt;.+?)\s(?&amp;lt;remote_addr&amp;gt;.+?)\s\-\s(?&amp;lt;remote_user&amp;gt;.+?)\s\[(?&amp;lt;Day&amp;gt;.+?)/(?&amp;lt;Month&amp;gt;.+?)/(?&amp;lt;Year&amp;gt;.+?):(?&amp;lt;Hour&amp;gt;.+?):&quot;
                }
        }
        mutate {
                gsub =&amp;gt; [&quot;modulname&quot;, &quot;\.&quot;, &quot;&quot;]
        }
        if [Month] == &quot;Jan&quot; {
                        mutate {
                                update =&amp;gt; [&quot;Month&quot;,&quot;01&quot;]
                        } 
        } else if [Month] == &quot;Feb&quot; {
                        mutate {
                                update =&amp;gt; [&quot;Month&quot;,&quot;02&quot;]
                        }
        } else if [Month] == &quot;Mar&quot; {
                        mutate {
                                update =&amp;gt; [&quot;Month&quot;,&quot;03&quot;]
                        }
        } else if [Month] == &quot;Api&quot; {
                        mutate {
                                update =&amp;gt; [&quot;Month&quot;,&quot;04&quot;]
                        }
        } else if [Month] == &quot;May&quot; {
                        mutate {
                                update =&amp;gt; [&quot;Month&quot;,&quot;05&quot;]
                        }
        } else if [Month] == &quot;Jun&quot; {
                        mutate {
                                update =&amp;gt; [&quot;Month&quot;,&quot;06&quot;]
                        }
        } else if [Month] == &quot;Jul&quot; {
                        mutate {
                                update =&amp;gt; [&quot;Month&quot;,&quot;07&quot;]
                        }
        } else if [Month] == &quot;Aug&quot; {
                        mutate {
                                update =&amp;gt; [&quot;Month&quot;,&quot;08&quot;]
                        }
        } else if [Month] == &quot;Sep&quot; {
                        mutate {
                                update =&amp;gt; [&quot;Month&quot;,&quot;09&quot;]
                        }
        } else if [Month] == &quot;Oct&quot; {
                        mutate {
                                update =&amp;gt; [&quot;Month&quot;,&quot;10&quot;]
                        }
        } else if [Month] == &quot;Nov&quot; {
                        mutate {
                                update =&amp;gt; [&quot;Month&quot;,&quot;11&quot;]
                        }
        } else if [Month] == &quot;Dec&quot; {
                        mutate {
                                update =&amp;gt; [&quot;Month&quot;,&quot;12&quot;]
                        }
        } 
}

output {
        if [modulname] {
           webhdfs {
                workers =&amp;gt; 2
                host =&amp;gt; &quot;hdfs-host.host.com&quot;
                port =&amp;gt; 50070
                user =&amp;gt; &quot;loguser&quot;
                path =&amp;gt; &quot;/Service-Data/Logs/%{modulname}/dt=%{Year}%{Month}%{Day}/hour=%{Hour}/%{hostname}_%{Year}%{Month}%{Day}%{Hour}.log&quot;
                flush_size =&amp;gt; 5000
                compression =&amp;gt; &quot;gzip&quot;
                idle_flush_time =&amp;gt; 6
                retry_interval =&amp;gt; 3
                retry_times =&amp;gt; 3
                codec =&amp;gt; line {
                        format =&amp;gt; &quot;%{message}&quot;
                }
           }
        } else {
           file {
                path =&amp;gt; &quot;/$PATH/logstash/logstash_kafka_hdfs_error.log&quot;
                message_format =&amp;gt; &quot;%{message}&quot;
           }
        }
        stdout{codec =&amp;gt; rubydebug}
}
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;update: 更新value值&lt;/p&gt;
&lt;/blockquote&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;start-logstash&quot;&gt;Start Logstash&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;cd /usr/local/logstash
nohup ./bin/logstash -f conf/logstash.conf &amp;gt;&amp;gt;/var/log/logstash.debug.log &amp;amp;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;hr /&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;推荐用supervisor守护logstash进程&lt;/code&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;http://wangrubin.com/point/supervisor.html&quot;&gt;参考supervisor进程守护&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;cat &amp;gt;/etc/supervisor/conf/logstash.ini&amp;lt;&amp;lt;EOF
[program:Logstash]
command = /usr/local/logstash/bin/logstash -f /usr/local/logstash/conf/logstash.conf
autostart = true
autorestart = true
startsecs = 3
startretries = 3
stopwaitsecs = 5
user = root
redirect_stderr = true
stdout_logfile = /var/log/supervisor/logstash.log
stdout_logfile_maxbytes = 500MB
stdout_logfile_backups = 0
EOF
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;supervisorctl update&lt;/p&gt;
&lt;/blockquote&gt;

&lt;hr /&gt;

&lt;p&gt;end&lt;/p&gt;

</description>
        <pubDate>Tue, 12 Sep 2017 00:00:00 +0800</pubDate>
        <link>/bigdata/Logstash.html</link>
        <guid isPermaLink="true">/bigdata/Logstash.html</guid>
        
        
        <category>BigData</category>
        
      </item>
    
      <item>
        <title>Centos6 &amp; Centos 7 初始化脚本</title>
        <description>&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/usr/bin/env bash&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#Author: xxxxxxx&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#Email: xxxxxxx@gmail.com&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#Description: This script is for optimizing system performance; For Centos6 and Centos7&lt;/span&gt;

cat /etc/redhat-release|awk &lt;span class=&quot;s1&quot;&gt;'{print &quot;OPERATING SYSTEM:&quot;,$0}'&lt;/span&gt;
grep &lt;span class=&quot;s2&quot;&gt;&quot;IPADDR&quot;&lt;/span&gt; /etc/sysconfig/network-scripts/ifcfg-eth0|awk -F &lt;span class=&quot;s2&quot;&gt;&quot;=&quot;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'{print &quot;HOST IPADDR:&quot;,$2}'&lt;/span&gt;
uname -a|awk &lt;span class=&quot;s1&quot;&gt;'{print &quot;HOSTNAME:&quot;,$2&quot;\nKERNEL VERSION:&quot;,$3}'&lt;/span&gt;        

sed -i &lt;span class=&quot;s1&quot;&gt;'s/DNS1=.*/DNS1=114.114.114.114/g'&lt;/span&gt; /etc/sysconfig/network-scripts/ifcfg-eth0
sed -i &lt;span class=&quot;s1&quot;&gt;'s/DNS2=.*/DNS2=180.76.76.76/g'&lt;/span&gt; /etc/sysconfig/network-scripts/ifcfg-eth0
cat &amp;gt;/etc/resolv.conf&lt;span class=&quot;sh&quot;&gt;&amp;lt;&amp;lt;EOF
nameserver 114.114.114.114
nameserver 180.76.76.76
EOF

&lt;/span&gt;sed -i &lt;span class=&quot;s1&quot;&gt;'s/SELINUX=.*/SELINUX=disabled/g'&lt;/span&gt; /etc/selinux/config
setenforce 0 &amp;amp;&amp;gt; /dev/null

&lt;span class=&quot;nv&quot;&gt;TEST&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;grep &lt;span class=&quot;s2&quot;&gt;&quot;soft nproc 65535&quot;&lt;/span&gt; /etc/security/limits.conf|wc -l&lt;span class=&quot;k&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$TEST&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;0&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;; &lt;span class=&quot;k&quot;&gt;then
&lt;/span&gt;cat  &amp;gt;&amp;gt; /etc/security/limits.conf &lt;span class=&quot;sh&quot;&gt;&amp;lt;&amp;lt; EOF
* soft nproc 65535
* hard nproc 65535
* soft nofile 65535
* hard nofile 65535
EOF
&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;fi

&lt;/span&gt;sed -i &lt;span class=&quot;s2&quot;&gt;&quot;s/&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\#&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;UseDNS.*/UseDNS no/g&quot;&lt;/span&gt; /etc/ssh/sshd_config
sed -i &lt;span class=&quot;s2&quot;&gt;&quot;s/GSSAPIAuthentication.*/GSSAPIAuthentication no/g&quot;&lt;/span&gt; /etc/ssh/sshd_config

&lt;span class=&quot;nv&quot;&gt;TEST&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;egrep &lt;span class=&quot;s2&quot;&gt;&quot;color|auto&quot;&lt;/span&gt; /etc/profile|wc -l&lt;span class=&quot;k&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$TEST&lt;/span&gt; -eq 0 &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;;&lt;span class=&quot;k&quot;&gt;then
&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;alias egrep='egrep --color=auto'&quot;&lt;/span&gt; &amp;gt;&amp;gt;/etc/profile
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;alias grep='grep --color=auto'&quot;&lt;/span&gt; &amp;gt;&amp;gt;/etc/profile
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;alias vi='vim'&quot;&lt;/span&gt; &amp;gt;&amp;gt;/etc/profile
&lt;span class=&quot;k&quot;&gt;fi

&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TEST&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;grep &lt;span class=&quot;s2&quot;&gt;&quot;ntp1.aliyun.com&quot;&lt;/span&gt; /var/spool/cron/root|wc -l&lt;span class=&quot;k&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$TEST&lt;/span&gt; -eq 0 &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;;&lt;span class=&quot;k&quot;&gt;then
&lt;/span&gt;touch /var/spool/cron/root
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;*/5 * * * * /usr/sbin/ntpdate ntp1.aliyun.com &amp;gt;/dev/null 2&amp;gt;&amp;amp;1&quot;&lt;/span&gt; &amp;gt;&amp;gt;/var/spool/cron/root
&lt;span class=&quot;k&quot;&gt;fi

&lt;/span&gt;yum install wget -y &amp;amp;&amp;gt; /dev/null

&lt;span class=&quot;nv&quot;&gt;SYSTEM_VERSION&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;cat /etc/redhat-release|grep -o &lt;span class=&quot;s2&quot;&gt;&quot;6.&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$SYSTEM_VERSION&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;;&lt;span class=&quot;k&quot;&gt;then
    &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;VERSION&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'centos7'&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;else
    &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;VERSION&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'centos6'&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;fi

if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$VERSION&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'centos6'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;;&lt;span class=&quot;k&quot;&gt;then
&lt;/span&gt;chkconfig --list|grep 3:on|egrep -v &lt;span class=&quot;s2&quot;&gt;&quot;crond|network|rsyslog|sshd|sysstat&quot;&lt;/span&gt;|awk &lt;span class=&quot;s1&quot;&gt;'{print $1}'&lt;/span&gt;|sed -r &lt;span class=&quot;s1&quot;&gt;'s#(.*)#chkconfig \1 off#g'&lt;/span&gt;|bash &amp;amp;&amp;gt;/dev/null
/etc/init.d/iptables stop &amp;amp;&amp;gt; /dev/null
wget -qO /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo
wget -qO /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo
chmod +x /etc/rc.d/rc.local
&lt;span class=&quot;k&quot;&gt;elif&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$VERSION&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'centos7'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;;&lt;span class=&quot;k&quot;&gt;then
&lt;/span&gt;wget -qO /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
wget -qO /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo
yum clean all &amp;amp;&amp;gt; /dev/null
systemctl stop firewalld.service &amp;amp;&amp;gt; /dev/null
systemctl disable firewalld.service &amp;amp;&amp;gt; /dev/null
systemctl stop NetworkManager.service &amp;amp;&amp;gt; /dev/null
systemctl disable NetworkManager.service &amp;amp;&amp;gt; /dev/null
systemclt stop postfix.service &amp;amp;&amp;gt; /dev/null
systemclt disable postfix.service &amp;amp;&amp;gt; /dev/null
yum install iptables-services -y &amp;amp;&amp;gt; /dev/null
&lt;span class=&quot;k&quot;&gt;else 
&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;Pls Check The System Version&quot;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;fi
&lt;/span&gt;yum clean all &amp;amp;&amp;gt; /dev/null
yum makecache &amp;amp;&amp;gt; /dev/null
yum -y groupinstall Development tools
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;wget -qO ./optimizing-system.sh http://wangrubin.com/scripts/optimizing-system.sh &amp;amp;&amp;amp; sh optimizing-system.sh&lt;/p&gt;
&lt;/blockquote&gt;

&lt;hr /&gt;

&lt;p&gt;end&lt;/p&gt;
</description>
        <pubDate>Thu, 07 Sep 2017 00:00:00 +0800</pubDate>
        <link>/shell/optimizing-system.html</link>
        <guid isPermaLink="true">/shell/optimizing-system.html</guid>
        
        
        <category>Shell</category>
        
      </item>
    
      <item>
        <title>nginx部署脚本</title>
        <description>&lt;h2 id=&quot;install&quot;&gt;Install&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;yum install -y openssl openssl-devel
yum install -y zlib zlib-devel
yum install -y pcre pcre-devel
useradd nginx -M -s /sbin/nologin
wget https://nginx.org/download/nginx-1.12.1.tar.gz
tar xf nginx-1.12.1.tar.gz  &amp;amp;&amp;amp; cd nginx-1.12.1
./configure --prefix=/usr/local/nginx-1.12.1 --user=nginx --group=nginx --with-http_ssl_module --with-http_stub_status_module
make &amp;amp;&amp;amp; make install
ln -s /usr/local/nginx-1.12.1 /usr/local/nginx
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;start-script&quot;&gt;Start script&lt;/h2&gt;

&lt;p&gt;vim /etc/init.d/nginx&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/usr/bin/env bash   &lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt; -e   
&lt;span class=&quot;nv&quot;&gt;TOOLS_SERVER_NAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Nginx Server&quot;&lt;/span&gt; 
&lt;span class=&quot;nv&quot;&gt;TOOLS_CMD&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/usr/local/nginx/sbin/nginx&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;DESCRIPTION&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Pls use /etc/init.d/nginx start|stop|restart|reload&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;LOCK_FILE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/usr/local/nginx/logs/nginx.lock&quot;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$1&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in 
  &lt;/span&gt;start&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;   
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; -f &lt;span class=&quot;nv&quot;&gt;$LOCK_FILE&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;;&lt;span class=&quot;k&quot;&gt;then
           &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; -e &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[32m&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TOOLS_SERVER_NAME&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; was Started.&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[0m&quot;&lt;/span&gt;
           &lt;span class=&quot;nb&quot;&gt;exit &lt;/span&gt;0
        &lt;span class=&quot;k&quot;&gt;fi
        &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; -e &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[32mSTARTTING &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TOOLS_SERVER_NAME&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;......&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[0m&quot;&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$TOOLS_CMD&lt;/span&gt; &amp;amp;&amp;gt;/dev/null &amp;amp;  
        touch &lt;span class=&quot;nv&quot;&gt;$LOCK_FILE&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;;;&lt;/span&gt;   
   stop&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; 
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; ! -f &lt;span class=&quot;nv&quot;&gt;$LOCK_FILE&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;;&lt;span class=&quot;k&quot;&gt;then
           &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; -e &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[32m&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TOOLS_SERVER_NAME&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; was Stopped.&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[0m&quot;&lt;/span&gt;
           &lt;span class=&quot;nb&quot;&gt;exit &lt;/span&gt;0
        &lt;span class=&quot;k&quot;&gt;fi
        &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; -e &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[32mSTOPPING &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TOOLS_SERVER_NAME&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;......&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[0m&quot;&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$TOOLS_CMD&lt;/span&gt; -s stop &amp;amp;&amp;gt; /dev/null   
        rm -f &lt;span class=&quot;nv&quot;&gt;$LOCK_FILE&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;;;&lt;/span&gt;   
   restart&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;   
        &lt;span class=&quot;nv&quot;&gt;$0&lt;/span&gt; stop &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; sleep 1 &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$0&lt;/span&gt; start   
        &lt;span class=&quot;p&quot;&gt;;;&lt;/span&gt;  
   reload&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$TOOLS_CMD&lt;/span&gt; -s reload &amp;amp;&amp;gt; /dev/null 
        &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; -e &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[32m&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TOOLS_SERVER_NAME&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; was Reload......&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[0m&quot;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;;;&lt;/span&gt;
   &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;   
        &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; -e &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[31mUsage: &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$DESCRIPTION&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[0m&quot;&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;exit &lt;/span&gt;1   
&lt;span class=&quot;k&quot;&gt;esac&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;hr /&gt;

&lt;h2 id=&quot;on-boot-start&quot;&gt;On boot start&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;chmod +x /etc/init.d/nginx&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;/etc/init.d/nginx start&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;echo “/etc/init.d/nginx start” » /etc/rc.local&lt;/p&gt;
&lt;/blockquote&gt;

&lt;hr /&gt;

&lt;p&gt;end&lt;/p&gt;
</description>
        <pubDate>Thu, 07 Sep 2017 00:00:00 +0800</pubDate>
        <link>/shell/nginx.html</link>
        <guid isPermaLink="true">/shell/nginx.html</guid>
        
        
        <category>Shell</category>
        
      </item>
    
      <item>
        <title>lvs_tun_vip.sh</title>
        <description>&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/usr/bin/env bash     &lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;VIP&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;210.14.134.8
&lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$1&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in  
&lt;/span&gt;start&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;  
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; -e &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[32mStart vip......&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[0m&quot;&lt;/span&gt;
modprobe ipip  
/sbin/ifconfig tunl0 &lt;span class=&quot;nv&quot;&gt;$VIP&lt;/span&gt; netmask 255.255.255.255 broadcast &lt;span class=&quot;nv&quot;&gt;$VIP&lt;/span&gt;  
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;1&quot;&lt;/span&gt; &amp;gt; /proc/sys/net/ipv4/conf/tunl0/arp_ignore  
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;2&quot;&lt;/span&gt; &amp;gt; /proc/sys/net/ipv4/conf/tunl0/arp_announce  
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;1&quot;&lt;/span&gt; &amp;gt; /proc/sys/net/ipv4/conf/all/arp_ignore  
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;2&quot;&lt;/span&gt; &amp;gt; /proc/sys/net/ipv4/conf/all/arp_announce  
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;0&quot;&lt;/span&gt; &amp;gt; /proc/sys/net/ipv4/conf/tunl0/rp_filter  
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;0&quot;&lt;/span&gt; &amp;gt; /proc/sys/net/ipv4/conf/all/rp_filter  
&lt;span class=&quot;p&quot;&gt;;;&lt;/span&gt;  
stop&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;  
/sbin/ifconfig tunl0 down  
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; -e &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[32mStop vip......&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[0m&quot;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;0&quot;&lt;/span&gt; &amp;gt; /proc/sys/net/ipv4/conf/tunl0/arp_ignore  
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;0&quot;&lt;/span&gt; &amp;gt; /proc/sys/net/ipv4/conf/tunl0/arp_announce  
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;0&quot;&lt;/span&gt; &amp;gt; /proc/sys/net/ipv4/conf/all/arp_ignore  
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;0&quot;&lt;/span&gt; &amp;gt; /proc/sys/net/ipv4/conf/all/arp_announce  
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;1&quot;&lt;/span&gt; &amp;gt; /proc/sys/net/ipv4/conf/tunl0/rp_filter  
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;1&quot;&lt;/span&gt; &amp;gt; /proc/sys/net/ipv4/conf/all/rp_filter  
&lt;span class=&quot;p&quot;&gt;;;&lt;/span&gt;  
&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;  
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; -e &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[32mUsage: Pls use &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; {start|stop}&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[0m&quot;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;exit &lt;/span&gt;1  
&lt;span class=&quot;k&quot;&gt;esac&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
</description>
        <pubDate>Thu, 07 Sep 2017 00:00:00 +0800</pubDate>
        <link>/shell/lvs-tun.html</link>
        <guid isPermaLink="true">/shell/lvs-tun.html</guid>
        
        
        <category>Shell</category>
        
      </item>
    
      <item>
        <title>lvs部署脚本</title>
        <description>&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/usr/bin/env bash&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#Author: xxxxxxx&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#Email: xxxxxxx@gmail.com&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#Description: This script is for start stop reload lvs &lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;WORK_DIR&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/root/lvs/&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;CMD&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/usr/sbin/ipvsadm&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;LOCK_FILE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/root/lvs/lvs.lock&quot;&lt;/span&gt;

&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$WORK_DIR&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$1&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in
        &lt;/span&gt;start&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; -f &lt;span class=&quot;nv&quot;&gt;$LOCK_FILE&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;;&lt;span class=&quot;k&quot;&gt;then
                &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; -e &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[32mLVS was Started.&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[0m&quot;&lt;/span&gt;
                &lt;span class=&quot;nb&quot;&gt;exit &lt;/span&gt;0
        &lt;span class=&quot;k&quot;&gt;fi
        &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; -e &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[32mSTARTTING LVS......&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[0m&quot;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;while &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;read &lt;/span&gt;line
        &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
                &lt;span class=&quot;nv&quot;&gt;$CMD&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$line&lt;/span&gt;
                &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; -e &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[32m&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$CMD&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$line&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[0m&quot;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;done&lt;/span&gt; &amp;lt; ./lvs_list.txt
        touch &lt;span class=&quot;nv&quot;&gt;$LOCK_FILE&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;;;&lt;/span&gt;
        stop&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; -f &lt;span class=&quot;nv&quot;&gt;$LOCK_FILE&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;;&lt;span class=&quot;k&quot;&gt;then
                &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; -e &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[32mSTOPPING LVS......&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[0m&quot;&lt;/span&gt;
                &lt;span class=&quot;nv&quot;&gt;$CMD&lt;/span&gt; -C
                rm -f &lt;span class=&quot;nv&quot;&gt;$LOCK_FILE&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;else
                &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; -e &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[32mLVS was Stopped.&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[0m&quot;&lt;/span&gt;
                &lt;span class=&quot;nb&quot;&gt;exit &lt;/span&gt;0
        &lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;;;&lt;/span&gt;
        restart&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; -e &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[32mRESTARTTING LVS......&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[0m&quot;&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$0&lt;/span&gt; stop &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; sleep 1 &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$0&lt;/span&gt; start
        &lt;span class=&quot;p&quot;&gt;;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; -e &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[31mUsage: Pls use sh lvs.sh start|stop|restart|reload&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;33[0m&quot;&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;exit &lt;/span&gt;1
&lt;span class=&quot;k&quot;&gt;esac&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;hr /&gt;

&lt;p&gt;end&lt;/p&gt;
</description>
        <pubDate>Thu, 07 Sep 2017 00:00:00 +0800</pubDate>
        <link>/shell/lvs-ipvsadm.html</link>
        <guid isPermaLink="true">/shell/lvs-ipvsadm.html</guid>
        
        
        <category>Shell</category>
        
      </item>
    
      <item>
        <title>Prometheus-容器监控</title>
        <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#prometheus&quot; id=&quot;markdown-toc-prometheus&quot;&gt;什么是Prometheus&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section&quot; id=&quot;markdown-toc-section&quot;&gt;主要特点&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#section-1&quot; id=&quot;markdown-toc-section-1&quot;&gt;相关组件&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#prometheus-1&quot; id=&quot;markdown-toc-prometheus-1&quot;&gt;prometheus架构&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#prometheus-2&quot; id=&quot;markdown-toc-prometheus-2&quot;&gt;prometheus部署&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;首先-什么是 TSDB (Time Series Database):&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;我们可以简单的理解为.一个优化后用来处理时间序列数据的软件,并且数据中的数组是由时间进行索引的.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;时间序列数据库的特点:&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;大部分时间都是写入操作&lt;/li&gt;
  &lt;li&gt;写入操作几乎是顺序添加;大多数时候数据到达后都以时间排序.&lt;/li&gt;
  &lt;li&gt;写操作很少写入很久之前的数据,也很少更新数据.大多数情况在数据被采集到数秒或者数分钟后就会被写入数据库.&lt;/li&gt;
  &lt;li&gt;删除操作一般为区块删除,选定开始的历史时间并指定后续的区块.很少单独删除某个时间或者分开的随机时间的数据.&lt;/li&gt;
  &lt;li&gt;数据一般远远超过内存大小,所以缓存基本无用.系统一般是 IO 密集型&lt;/li&gt;
  &lt;li&gt;读操作是十分典型的升序或者降序的顺序读,&lt;/li&gt;
  &lt;li&gt;高并发的读操作十分常见.&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;常见的时间序列数据库:&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;influxDB	https://influxdata.com/&lt;/li&gt;
  &lt;li&gt;RRDtool	http://oss.oetiker.ch/rrdtool/&lt;/li&gt;
  &lt;li&gt;Graphite	http://graphite.readthedocs.org/en/latest/&lt;/li&gt;
  &lt;li&gt;OpenTSDB	http://opentsdb.net/&lt;/li&gt;
  &lt;li&gt;Kdb+	http://kx.com/&lt;/li&gt;
  &lt;li&gt;Druid	http://druid.io/&lt;/li&gt;
  &lt;li&gt;KairosDB	http://kairosdb.github.io/&lt;/li&gt;
  &lt;li&gt;Prometheus	https://prometheus.io/&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;prometheus&quot;&gt;什么是Prometheus&lt;/h2&gt;

&lt;p&gt;Prometheus是由 SoundCloud 开发的开源监控报警系统和时序列数据库(TSDB)，可以看作是Google内部监控系统Borgmon的一个（非官方）实现。&lt;/p&gt;

&lt;p&gt;并且保持独立于任何公司,Prometheus 在2016加入 CNCF ( Cloud Native Computing Foundation ), 作为在 kubernetes 之后的第二个由基金会主持的项目.&lt;/p&gt;

&lt;p&gt;为什么选择Prometheus而不是其它TSDB实现（如InfluxDB）?&lt;/p&gt;

&lt;p&gt;主要是因为Prometheus的核心功能，查询语言PromQL，它更像一种可编程计算器，而不是其那么像SQL，也意味着PromQL可以近乎无限之组合出各种查询结果&lt;/p&gt;

&lt;h2 id=&quot;section&quot;&gt;主要特点&lt;/h2&gt;

&lt;ol&gt;
  &lt;li&gt;多维数据模型（时序列数据由metric名和一组key/value组成）&lt;/li&gt;
  &lt;li&gt;在多维度上灵活的查询语言(PromQl)&lt;/li&gt;
  &lt;li&gt;不依赖分布式存储，单主节点工作.&lt;/li&gt;
  &lt;li&gt;通过基于HTTP的pull方式采集时序数据&lt;/li&gt;
  &lt;li&gt;可以通过中间网关进行时序列数据推送(pushing)&lt;/li&gt;
  &lt;li&gt;目标服务器可以通过发现服务或者静态配置实现&lt;/li&gt;
  &lt;li&gt;多种可视化和仪表盘支持&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;section-1&quot;&gt;相关组件&lt;/h2&gt;

&lt;p&gt;Prometheus生态系统由多个组件组成，其中许多是可选的：&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Prometheus server&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;主要负责数据采集和存储，提供PromQL查询语言的支持&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;客户端sdk&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;官方提供的客户端类库有go、java、scala、python、ruby，其他还有很多第三方开发的类库，支持nodejs、php、erlang等&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Push Gateway&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;支持临时性Job主动推送指标的中间网关&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;PromDash&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;使用rails开发的dashboard，用于可视化指标数据；目前普遍用Grafana代替&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;exporters&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;支持其他数据源的指标导入到Prometheus，支持数据库、硬件、消息中间件、存储系统、http服务器、jmx等&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;alertmanager&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;实验性的报警管理端(alartmanager,单独进行报警汇总,分发,屏蔽等 )&lt;/p&gt;

&lt;p&gt;promethues 的各个组件基本都是用 golang 编写,对编译和部署十分友好.并且没有特殊依赖.基本都是独立工作.&lt;/p&gt;

&lt;h2 id=&quot;prometheus-1&quot;&gt;prometheus架构&lt;/h2&gt;

&lt;hr /&gt;

&lt;p&gt;&lt;img src=&quot;/pic/prometheus/1.svg&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Prometheus的基本原理是通过HTTP协议周期性抓取被监控组件的状态，任意组件只要提供对应的HTTP接口就可以接入监控。不需要任何SDK或者其他的集成过程。这样做非常适合做虚拟化环境监控系统，&lt;/p&gt;

&lt;p&gt;比如VM、Docker、Kubernetes等。输出被监控组件信息的HTTP接口被叫做exporter 。目前互联网公司常用的组件大部分都有exporter可以直接使用，比如Varnish、Haproxy、Nginx、MySQL、Linux系统信息(包括磁盘、内存、CPU、网络等等)。&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Prometheus服务过程大概是这样：&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;Prometheus Daemon负责定时去目标上抓取metrics(指标)数据，每个抓取目标需要暴露一个http服务的接口给它定时抓取。Prometheus支持通过配置文件、文本文件、Zookeeper、Consul、DNS SRV Lookup等方式指定抓取目标。Prometheus采用PULL的方式进行监控，即服务器可以直接通过目标PULL数据或者间接地通过中间网关来Push数据。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Prometheus在本地存储抓取的所有数据，并通过一定规则进行清理和整理数据，并把得到的结果存储到新的时间序列中。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Prometheus通过PromQL和其他API可视化地展示收集的数据。Prometheus支持很多方式的图表可视化，例如Grafana、自带的Promdash以及自身提供的模版引擎等等。Prometheus还提供HTTP API的查询方式，自定义所需要的输出。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;PushGateway支持Client主动推送metrics到PushGateway，而Prometheus只是定时去Gateway上抓取数据。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Alertmanager是独立于Prometheus的一个组件，可以支持Prometheus的查询语句，提供十分灵活的报警方式。&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;prometheus-2&quot;&gt;prometheus部署&lt;/h2&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot; data-lang=&quot;shell&quot;&gt;docker run &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
	-p 9090:9090 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
	-v /tmp/prometheus.yml:/etc/prometheus/prometheus.yml &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
	-v /home/mtime/prometheus-docker/data：/prometheus/data &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
	prom/prometheus&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

</description>
        <pubDate>Thu, 27 Jul 2017 00:00:00 +0800</pubDate>
        <link>/docker/Prometheus.html</link>
        <guid isPermaLink="true">/docker/Prometheus.html</guid>
        
        
        <category>Docker</category>
        
      </item>
    
  </channel>
</rss>
